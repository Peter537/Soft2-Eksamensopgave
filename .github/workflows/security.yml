name: Security Gates

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: security-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read
  security-events: write
  packages: read

env:
  IMAGE_TAG: ${{ github.event.pull_request.head.sha || github.sha }}

jobs:
  wait_for_cicd:
    name: Wait for CI/CD images & artifact
    runs-on: ubuntu-latest
    outputs:
      cicd-run-id: ${{ steps.get-run-id.outputs.run_id }}
    steps:
      - name: Wait for CI/CD workflow to complete
        uses: fountainhead/action-wait-for-check@v1.2.0
        id: wait
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: Save build outputs
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          intervalSeconds: 15
          timeoutSeconds: 1800

      - name: Verify CI/CD succeeded
        run: |
          if [[ "${{ steps.wait.outputs.conclusion }}" != "success" ]]; then
            echo "CI/CD pipeline did not succeed (conclusion: ${{ steps.wait.outputs.conclusion }})"
            exit 1
          fi

      - name: Get CI/CD workflow run ID
        id: get-run-id
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SHA="${{ github.event.pull_request.head.sha || github.sha }}"
          echo "Looking for CI/CD workflow run for commit: $SHA"

          MAX_ATTEMPTS=20
          SLEEP_SECONDS=3
          ATTEMPT=1
          RUN_ID=""

          # Retry fetching the CI/CD run ID because the GitHub API can lag behind completed runs
          while [[ $ATTEMPT -le $MAX_ATTEMPTS ]]; do
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: querying GitHub API for CI/CD run ID..."

            RUN_ID=$(gh api \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/actions/workflows/cicd.yml/runs?head_sha=$SHA&status=completed" \
              --jq '.workflow_runs[0].id')

            if [[ -n "$RUN_ID" && "$RUN_ID" != "null" ]]; then
              echo "Found CI/CD workflow run ID: $RUN_ID"
              echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"
              break
            fi

            if [[ $ATTEMPT -lt $MAX_ATTEMPTS ]]; then
              echo "Run ID not available yet; waiting $SLEEP_SECONDS seconds before retrying..."
              sleep $SLEEP_SECONDS
            fi

            ((ATTEMPT++))
          done

          if [[ -z "$RUN_ID" || "$RUN_ID" == "null" ]]; then
            echo "Error: Could not find CI/CD workflow run for SHA $SHA after $MAX_ATTEMPTS attempts"
            exit 1
          fi

  detect_changed_services:
    name: Detect changed services
    needs: wait_for_cicd
    runs-on: ubuntu-latest
    outputs:
      cicd-run-id: ${{ needs.wait_for_cicd.outputs.cicd-run-id }}
      shared: ${{ steps.parse.outputs.shared }}
      agentbonus: ${{ steps.parse.outputs.agentbonus }}
      agentservice: ${{ steps.parse.outputs.agentservice }}
      customerservice: ${{ steps.parse.outputs.customerservice }}
      feedbackhub: ${{ steps.parse.outputs.feedbackhub }}
      gateway: ${{ steps.parse.outputs.gateway }}
      notification: ${{ steps.parse.outputs.notification }}
      order: ${{ steps.parse.outputs.order }}
      partner: ${{ steps.parse.outputs.partner }}
      logcollector: ${{ steps.parse.outputs.logcollector }}
      website: ${{ steps.parse.outputs.website }}
      websocketagent: ${{ steps.parse.outputs.websocketagent }}
      websocketcustomer: ${{ steps.parse.outputs.websocketcustomer }}
      websocketpartner: ${{ steps.parse.outputs.websocketpartner }}
      management: ${{ steps.parse.outputs.management }}
      legacy: ${{ steps.parse.outputs.legacy }}

    steps:
      - name: Download build-outputs.json from the completed CI/CD run
        uses: actions/download-artifact@v4
        with:
          name: build-outputs
          path: .
          run-id: ${{ needs.wait_for_cicd.outputs.cicd-run-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse build outputs
        id: parse
        run: |
          cat build-outputs.json
          echo "shared=$(jq -r '.shared' build-outputs.json)" >> "$GITHUB_OUTPUT"
          echo "agentbonus=$(jq -r '.agentbonus' build-outputs.json)" >> "$GITHUB_OUTPUT"
          echo "agentservice=$(jq -r '.agentservice' build-outputs.json)" >> "$GITHUB_OUTPUT"
          echo "customerservice=$(jq -r '.customerservice' build-outputs.json)" >> "$GITHUB_OUTPUT"
          echo "feedbackhub=$(jq -r '.feedbackhub' build-outputs.json)" >> "$GITHUB_OUTPUT"
          echo "gateway=$(jq -r '.gateway' build-outputs.json)" >> "$GITHUB_OUTPUT"
          echo "notification=$(jq -r '.notification' build-outputs.json)" >> "$GITHUB_OUTPUT"
          echo "order=$(jq -r '.order' build-outputs.json)" >> "$GITHUB_OUTPUT"
          echo "partner=$(jq -r '.partner' build-outputs.json)" >> "$GITHUB_OUTPUT"
          echo "logcollector=$(jq -r '.logcollector' build-outputs.json)" >> "$GITHUB_OUTPUT"
          echo "website=$(jq -r '.website' build-outputs.json)" >> "$GITHUB_OUTPUT"
          echo "websocketagent=$(jq -r '.websocketagent' build-outputs.json)" >> "$GITHUB_OUTPUT"
          echo "websocketcustomer=$(jq -r '.websocketcustomer' build-outputs.json)" >> "$GITHUB_OUTPUT"
          echo "websocketpartner=$(jq -r '.websocketpartner' build-outputs.json)" >> "$GITHUB_OUTPUT"
          echo "management=$(jq -r '.management' build-outputs.json)" >> "$GITHUB_OUTPUT"
          echo "legacy=$(jq -r '.legacy' build-outputs.json)" >> "$GITHUB_OUTPUT"

  codeql:
    name: CodeQL - repo-wide analysis
    needs: detect_changed_services
    if: ${{ needs.detect_changed_services.outputs.agentbonus == 'true' || needs.detect_changed_services.outputs.agentservice == 'true' || needs.detect_changed_services.outputs.customerservice == 'true' || needs.detect_changed_services.outputs.feedbackhub == 'true' || needs.detect_changed_services.outputs.gateway == 'true' || needs.detect_changed_services.outputs.notification == 'true' || needs.detect_changed_services.outputs.order == 'true' || needs.detect_changed_services.outputs.partner == 'true' || needs.detect_changed_services.outputs.logcollector == 'true' || needs.detect_changed_services.outputs.website == 'true' || needs.detect_changed_services.outputs.websocketagent == 'true' || needs.detect_changed_services.outputs.websocketcustomer == 'true' || needs.detect_changed_services.outputs.websocketpartner == 'true' || needs.detect_changed_services.outputs.management == 'true' || needs.detect_changed_services.outputs.legacy == 'true' || needs.detect_changed_services.outputs.shared == 'true' }}
    runs-on: ubuntu-latest
    env:
      NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
      DOTNET_NOLOGO: true
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
      NUGET_XMLDOC_MODE: skip

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.IMAGE_TAG }}
          fetch-depth: 1

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ${{ env.NUGET_PACKAGES }}
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.props', '**/*.targets', 'global.json', 'NuGet.config') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: csharp
          build-mode: manual
          dependency-caching: false

      - name: Restore dependencies (solution + legacy when needed)
        run: |
          set -euo pipefail

          needs_mtogo=false
          needs_legacy=false

          if [[ "${{ needs.detect_changed_services.outputs.shared }}" == "true" \
            || "${{ needs.detect_changed_services.outputs.agentbonus }}" == "true" \
            || "${{ needs.detect_changed_services.outputs.agentservice }}" == "true" \
            || "${{ needs.detect_changed_services.outputs.customerservice }}" == "true" \
            || "${{ needs.detect_changed_services.outputs.feedbackhub }}" == "true" \
            || "${{ needs.detect_changed_services.outputs.gateway }}" == "true" \
            || "${{ needs.detect_changed_services.outputs.notification }}" == "true" \
            || "${{ needs.detect_changed_services.outputs.order }}" == "true" \
            || "${{ needs.detect_changed_services.outputs.partner }}" == "true" \
            || "${{ needs.detect_changed_services.outputs.logcollector }}" == "true" \
            || "${{ needs.detect_changed_services.outputs.website }}" == "true" \
            || "${{ needs.detect_changed_services.outputs.websocketagent }}" == "true" \
            || "${{ needs.detect_changed_services.outputs.websocketcustomer }}" == "true" \
            || "${{ needs.detect_changed_services.outputs.websocketpartner }}" == "true" \
            || "${{ needs.detect_changed_services.outputs.management }}" == "true" ]]; then
            needs_mtogo=true
          fi

          if [[ "${{ needs.detect_changed_services.outputs.legacy }}" == "true" \
            || "${{ needs.detect_changed_services.outputs.shared }}" == "true" ]]; then
            needs_legacy=true
          fi

          targets=()
          if [[ "$needs_mtogo" == "true" ]]; then
            targets+=( "MToGo/MToGo.sln" )
          fi
          if [[ "$needs_legacy" == "true" ]]; then
            targets+=( "LegacyMToGo/LegacyMToGo.csproj" )
          fi

          for t in "${targets[@]}"; do
            echo "Restoring: $t"
            dotnet restore "$t" --verbosity minimal
          done

      - name: Build for CodeQL (compile only what matters)
        run: |
          set -euo pipefail

          build_proj() {
            dotnet build "$1" -c Release --no-restore --verbosity minimal -- /m
          }

          # If shared changed, you're basically doing a repo-wide compile anyway:
          if [[ "${{ needs.detect_changed_services.outputs.shared }}" == "true" ]]; then
            echo "Shared changed -> building full MToGo solution once"
            dotnet build MToGo/MToGo.sln -c Release --no-restore --verbosity minimal -- /m

            if [[ "${{ needs.detect_changed_services.outputs.legacy }}" == "true" || "${{ needs.detect_changed_services.outputs.shared }}" == "true" ]]; then
              echo "Building LegacyMToGo"
              build_proj LegacyMToGo/LegacyMToGo.csproj
            fi

            exit 0
          fi

          # Otherwise build only changed services (fast path)
          if [[ "${{ needs.detect_changed_services.outputs.agentbonus }}" == "true" ]]; then
            build_proj MToGo/src/MToGo.AgentBonusService/MToGo.AgentBonusService.csproj
          fi

          if [[ "${{ needs.detect_changed_services.outputs.agentservice }}" == "true" ]]; then
            build_proj MToGo/src/MToGo.AgentService/MToGo.AgentService.csproj
          fi

          if [[ "${{ needs.detect_changed_services.outputs.customerservice }}" == "true" ]]; then
            build_proj MToGo/src/MToGo.CustomerService/MToGo.CustomerService.csproj
          fi

          if [[ "${{ needs.detect_changed_services.outputs.feedbackhub }}" == "true" ]]; then
            build_proj MToGo/src/MToGo.FeedbackHubService/MToGo.FeedbackHubService.csproj
          fi

          if [[ "${{ needs.detect_changed_services.outputs.gateway }}" == "true" ]]; then
            build_proj MToGo/src/MToGo.Gateway/MToGo.Gateway.csproj
          fi

          if [[ "${{ needs.detect_changed_services.outputs.notification }}" == "true" ]]; then
            build_proj MToGo/src/MToGo.NotificationService/MToGo.NotificationService.csproj
          fi

          if [[ "${{ needs.detect_changed_services.outputs.order }}" == "true" ]]; then
            build_proj MToGo/src/MToGo.OrderService/MToGo.OrderService.csproj
          fi

          if [[ "${{ needs.detect_changed_services.outputs.partner }}" == "true" ]]; then
            build_proj MToGo/src/MToGo.PartnerService/MToGo.PartnerService.csproj
          fi

          if [[ "${{ needs.detect_changed_services.outputs.logcollector }}" == "true" ]]; then
            build_proj MToGo/src/MToGo.LogCollectorService/MToGo.LogCollectorService.csproj
          fi

          if [[ "${{ needs.detect_changed_services.outputs.website }}" == "true" ]]; then
            build_proj MToGo/src/MToGo.Website/MToGo.Website.csproj
          fi

          if [[ "${{ needs.detect_changed_services.outputs.websocketagent }}" == "true" ]]; then
            build_proj MToGo/src/MToGo.WebSocketAgentService/MToGo.WebSocketAgentService.csproj
          fi

          if [[ "${{ needs.detect_changed_services.outputs.websocketcustomer }}" == "true" ]]; then
            build_proj MToGo/src/MToGo.WebSocketCustomerService/MToGo.WebSocketCustomerService.csproj
          fi

          if [[ "${{ needs.detect_changed_services.outputs.websocketpartner }}" == "true" ]]; then
            build_proj MToGo/src/MToGo.WebSocketPartnerService/MToGo.WebSocketPartnerService.csproj
          fi

          if [[ "${{ needs.detect_changed_services.outputs.management }}" == "true" ]]; then
            build_proj MToGo/src/MToGo.ManagementService/MToGo.ManagementService.csproj
          fi

          if [[ "${{ needs.detect_changed_services.outputs.legacy }}" == "true" ]]; then
            build_proj LegacyMToGo/LegacyMToGo.csproj
          fi

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

  security_customerservice:
    name: CustomerService - security gates
    needs: detect_changed_services
    if: ${{ needs.detect_changed_services.outputs.customerservice == 'true' || needs.detect_changed_services.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.IMAGE_TAG }}
          fetch-depth: 0

      - name: Set lowercase owner
        run: echo "OWNER_LC=${OWNER,,}" >> "$GITHUB_ENV"
        env:
          OWNER: ${{ github.repository_owner }}

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull CustomerService image from GHCR (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: docker pull ghcr.io/${{ env.OWNER_LC }}/mtogo-customerservice:${{ env.IMAGE_TAG }}

      - name: Set image ref (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: echo "IMAGE_REF=ghcr.io/${{ env.OWNER_LC }}/mtogo-customerservice:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Download Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/download-artifact@v4
        with:
          name: image-mtogo-customerservice
          path: /tmp
          run-id: ${{ needs.detect_changed_services.outputs.cicd-run-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load Docker image (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: docker load -i /tmp/mtogo-customerservice.tar

      - name: Set image ref (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: echo "IMAGE_REF=mtogo-customerservice:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Install gitleaks
        run: |
          VERSION=8.29.1
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz \
          | tar xz -C /usr/local/bin gitleaks

      - name: Gitleaks scan (CustomerService)
        run: |
          gitleaks detect \
            --source MToGo/src/MToGo.CustomerService \
            --config .gitleaks.toml \
            --no-git \
            -v

      - name: Trivy FS scan (CustomerService, HIGH/CRITICAL fail)
        id: trivy_fs
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: fs
          scan-ref: MToGo/src/MToGo.CustomerService
          format: sarif
          output: trivy-customerservice-fs.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Trivy image scan (CustomerService, HIGH/CRITICAL fail)
        id: trivy_image
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: image
          image-ref: ${{ env.IMAGE_REF }}
          format: sarif
          output: trivy-customerservice-image.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Upload Trivy FS SARIF (CustomerService)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-customerservice-fs.sarif
          category: trivy-customerservice-fs

      - name: Upload Trivy image SARIF (CustomerService)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-customerservice-image.sarif
          category: trivy-customerservice-image

      - name: Check Trivy scan results
        if: steps.trivy_fs.outcome == 'failure' || steps.trivy_image.outcome == 'failure'
        run: |
          echo "Trivy found HIGH/CRITICAL vulnerabilities"
          exit 1

  security_order:
    name: Order & Delivery - security gates
    needs: detect_changed_services
    if: ${{ needs.detect_changed_services.outputs.order == 'true' || needs.detect_changed_services.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.IMAGE_TAG }}
          fetch-depth: 0

      - name: Set lowercase owner
        run: echo "OWNER_LC=${OWNER,,}" >> "$GITHUB_ENV"
        env:
          OWNER: ${{ github.repository_owner }}

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Order & Delivery image from GHCR (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: docker pull ghcr.io/${{ env.OWNER_LC }}/mtogo-order:${{ env.IMAGE_TAG }}

      - name: Set image ref (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: echo "IMAGE_REF=ghcr.io/${{ env.OWNER_LC }}/mtogo-order:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Download Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/download-artifact@v4
        with:
          name: image-mtogo-order
          path: /tmp
          run-id: ${{ needs.detect_changed_services.outputs.cicd-run-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load Docker image (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: docker load -i /tmp/mtogo-order.tar

      - name: Set image ref (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: echo "IMAGE_REF=mtogo-order:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Install gitleaks
        run: |
          VERSION=8.29.1
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz \
          | tar xz -C /usr/local/bin gitleaks

      - name: Gitleaks scan (Order & Delivery)
        run: |
          gitleaks detect \
            --source MToGo/src/MToGo.OrderService \
            --config .gitleaks.toml \
            --no-git \
            -v

      - name: Trivy FS scan (Order & Delivery, HIGH/CRITICAL fail)
        id: trivy_fs
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: fs
          scan-ref: MToGo/src/MToGo.OrderService
          format: sarif
          output: trivy-order-fs.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Trivy image scan (Order & Delivery, HIGH/CRITICAL fail)
        id: trivy_image
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: image
          image-ref: ${{ env.IMAGE_REF }}
          format: sarif
          output: trivy-order-image.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Upload Trivy FS SARIF (Order & Delivery)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-order-fs.sarif
          category: trivy-order-fs

      - name: Upload Trivy image SARIF (Order & Delivery)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-order-image.sarif
          category: trivy-order-image

      - name: Check Trivy scan results
        if: steps.trivy_fs.outcome == 'failure' || steps.trivy_image.outcome == 'failure'
        run: |
          echo "Trivy found HIGH/CRITICAL vulnerabilities"
          exit 1

  security_agentbonus:
    name: AgentBonus - security gates
    needs: detect_changed_services
    if: ${{ needs.detect_changed_services.outputs.agentbonus == 'true' || needs.detect_changed_services.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.IMAGE_TAG }}
          fetch-depth: 0

      - name: Set lowercase owner
        run: echo "OWNER_LC=${OWNER,,}" >> "$GITHUB_ENV"
        env:
          OWNER: ${{ github.repository_owner }}

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull AgentBonus image from GHCR (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: docker pull ghcr.io/${{ env.OWNER_LC }}/mtogo-agentbonus:${{ env.IMAGE_TAG }}

      - name: Set image ref (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: echo "IMAGE_REF=ghcr.io/${{ env.OWNER_LC }}/mtogo-agentbonus:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Download Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/download-artifact@v4
        with:
          name: image-mtogo-agentbonus
          path: /tmp
          run-id: ${{ needs.detect_changed_services.outputs.cicd-run-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load Docker image (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: docker load -i /tmp/mtogo-agentbonus.tar

      - name: Set image ref (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: echo "IMAGE_REF=mtogo-agentbonus:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Install gitleaks
        run: |
          VERSION=8.29.1
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz \
          | tar xz -C /usr/local/bin gitleaks

      - name: Gitleaks scan (AgentBonus)
        run: |
          gitleaks detect \
            --source MToGo/src/MToGo.AgentBonusService \
            --config .gitleaks.toml \
            --no-git \
            -v

      - name: Trivy FS scan (AgentBonus, HIGH/CRITICAL fail)
        id: trivy_fs
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: fs
          scan-ref: MToGo/src/MToGo.AgentBonusService
          format: sarif
          output: trivy-agentbonus-fs.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Trivy image scan (AgentBonus, HIGH/CRITICAL fail)
        id: trivy_image
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: image
          image-ref: ${{ env.IMAGE_REF }}
          format: sarif
          output: trivy-agentbonus-image.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Upload Trivy FS SARIF (AgentBonus)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-agentbonus-fs.sarif
          category: trivy-agentbonus-fs

      - name: Upload Trivy image SARIF (AgentBonus)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-agentbonus-image.sarif
          category: trivy-agentbonus-image

      - name: Check Trivy scan results
        if: steps.trivy_fs.outcome == 'failure' || steps.trivy_image.outcome == 'failure'
        run: |
          echo "Trivy found HIGH/CRITICAL vulnerabilities"
          exit 1

  security_agentservice:
    name: AgentService - security gates
    needs: detect_changed_services
    if: ${{ needs.detect_changed_services.outputs.agentservice == 'true' || needs.detect_changed_services.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.IMAGE_TAG }}
          fetch-depth: 0

      - name: Set lowercase owner
        run: echo "OWNER_LC=${OWNER,,}" >> "$GITHUB_ENV"
        env:
          OWNER: ${{ github.repository_owner }}

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull AgentService image from GHCR (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: docker pull ghcr.io/${{ env.OWNER_LC }}/mtogo-agentservice:${{ env.IMAGE_TAG }}

      - name: Set image ref (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: echo "IMAGE_REF=ghcr.io/${{ env.OWNER_LC }}/mtogo-agentservice:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Download Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/download-artifact@v4
        with:
          name: image-mtogo-agentservice
          path: /tmp
          run-id: ${{ needs.detect_changed_services.outputs.cicd-run-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load Docker image (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: docker load -i /tmp/mtogo-agentservice.tar

      - name: Set image ref (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: echo "IMAGE_REF=mtogo-agentservice:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Install gitleaks
        run: |
          VERSION=8.29.1
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz \
          | tar xz -C /usr/local/bin gitleaks

      - name: Gitleaks scan (AgentService)
        run: |
          gitleaks detect \
            --source MToGo/src/MToGo.AgentService \
            --config .gitleaks.toml \
            --no-git \
            -v

      - name: Trivy FS scan (AgentService, HIGH/CRITICAL fail)
        id: trivy_fs
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: fs
          scan-ref: MToGo/src/MToGo.AgentService
          format: sarif
          output: trivy-agentservice-fs.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Trivy image scan (AgentService, HIGH/CRITICAL fail)
        id: trivy_image
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: image
          image-ref: ${{ env.IMAGE_REF }}
          format: sarif
          output: trivy-agentservice-image.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Upload Trivy FS SARIF (AgentService)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-agentservice-fs.sarif
          category: trivy-agentservice-fs

      - name: Upload Trivy image SARIF (AgentService)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-agentservice-image.sarif
          category: trivy-agentservice-image

      - name: Check Trivy scan results
        if: steps.trivy_fs.outcome == 'failure' || steps.trivy_image.outcome == 'failure'
        run: |
          echo "Trivy found HIGH/CRITICAL vulnerabilities"
          exit 1

  security_feedbackhub:
    name: FeedbackHub - security gates
    needs: detect_changed_services
    if: ${{ needs.detect_changed_services.outputs.feedbackhub == 'true' || needs.detect_changed_services.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.IMAGE_TAG }}
          fetch-depth: 0

      - name: Set lowercase owner
        run: echo "OWNER_LC=${OWNER,,}" >> "$GITHUB_ENV"
        env:
          OWNER: ${{ github.repository_owner }}

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull FeedbackHub image from GHCR (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: docker pull ghcr.io/${{ env.OWNER_LC }}/mtogo-feedbackhub:${{ env.IMAGE_TAG }}

      - name: Set image ref (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: echo "IMAGE_REF=ghcr.io/${{ env.OWNER_LC }}/mtogo-feedbackhub:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Download Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/download-artifact@v4
        with:
          name: image-mtogo-feedbackhub
          path: /tmp
          run-id: ${{ needs.detect_changed_services.outputs.cicd-run-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load Docker image (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: docker load -i /tmp/mtogo-feedbackhub.tar

      - name: Set image ref (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: echo "IMAGE_REF=mtogo-feedbackhub:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Install gitleaks
        run: |
          VERSION=8.29.1
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz \
          | tar xz -C /usr/local/bin gitleaks

      - name: Gitleaks scan (FeedbackHub)
        run: |
          gitleaks detect \
            --source MToGo/src/MToGo.FeedbackHubService \
            --config .gitleaks.toml \
            --no-git \
            -v

      - name: Trivy FS scan (FeedbackHub, HIGH/CRITICAL fail)
        id: trivy_fs
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: fs
          scan-ref: MToGo/src/MToGo.FeedbackHubService
          format: sarif
          output: trivy-feedbackhub-fs.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Trivy image scan (FeedbackHub, HIGH/CRITICAL fail)
        id: trivy_image
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: image
          image-ref: ${{ env.IMAGE_REF }}
          format: sarif
          output: trivy-feedbackhub-image.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Upload Trivy FS SARIF (FeedbackHub)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-feedbackhub-fs.sarif
          category: trivy-feedbackhub-fs

      - name: Upload Trivy image SARIF (FeedbackHub)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-feedbackhub-image.sarif
          category: trivy-feedbackhub-image

      - name: Check Trivy scan results
        if: steps.trivy_fs.outcome == 'failure' || steps.trivy_image.outcome == 'failure'
        run: |
          echo "Trivy found HIGH/CRITICAL vulnerabilities"
          exit 1

  security_gateway:
    name: Gateway - security gates
    needs: detect_changed_services
    if: ${{ needs.detect_changed_services.outputs.gateway == 'true' || needs.detect_changed_services.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.IMAGE_TAG }}
          fetch-depth: 0

      - name: Set lowercase owner
        run: echo "OWNER_LC=${OWNER,,}" >> "$GITHUB_ENV"
        env:
          OWNER: ${{ github.repository_owner }}

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Gateway image from GHCR (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: docker pull ghcr.io/${{ env.OWNER_LC }}/mtogo-gateway:${{ env.IMAGE_TAG }}

      - name: Set image ref (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: echo "IMAGE_REF=ghcr.io/${{ env.OWNER_LC }}/mtogo-gateway:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Download Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/download-artifact@v4
        with:
          name: image-mtogo-gateway
          path: /tmp
          run-id: ${{ needs.detect_changed_services.outputs.cicd-run-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load Docker image (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: docker load -i /tmp/mtogo-gateway.tar

      - name: Set image ref (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: echo "IMAGE_REF=mtogo-gateway:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Install gitleaks
        run: |
          VERSION=8.29.1
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz \
          | tar xz -C /usr/local/bin gitleaks

      - name: Gitleaks scan (Gateway)
        run: |
          gitleaks detect \
            --source MToGo/src/MToGo.Gateway \
            --config .gitleaks.toml \
            --no-git \
            -v

      - name: Trivy FS scan (Gateway, HIGH/CRITICAL fail)
        id: trivy_fs
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: fs
          scan-ref: MToGo/src/MToGo.Gateway
          format: sarif
          output: trivy-gateway-fs.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Trivy image scan (Gateway, HIGH/CRITICAL fail)
        id: trivy_image
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: image
          image-ref: ${{ env.IMAGE_REF }}
          format: sarif
          output: trivy-gateway-image.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Upload Trivy FS SARIF (Gateway)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-gateway-fs.sarif
          category: trivy-gateway-fs

      - name: Upload Trivy image SARIF (Gateway)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-gateway-image.sarif
          category: trivy-gateway-image

      - name: Check Trivy scan results
        if: steps.trivy_fs.outcome == 'failure' || steps.trivy_image.outcome == 'failure'
        run: |
          echo "Trivy found HIGH/CRITICAL vulnerabilities"
          exit 1

  security_notification:
    name: Notification - security gates
    needs: detect_changed_services
    if: ${{ needs.detect_changed_services.outputs.notification == 'true' || needs.detect_changed_services.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.IMAGE_TAG }}
          fetch-depth: 0

      - name: Set lowercase owner
        run: echo "OWNER_LC=${OWNER,,}" >> "$GITHUB_ENV"
        env:
          OWNER: ${{ github.repository_owner }}

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Notification image from GHCR (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: docker pull ghcr.io/${{ env.OWNER_LC }}/mtogo-notification:${{ env.IMAGE_TAG }}

      - name: Set image ref (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: echo "IMAGE_REF=ghcr.io/${{ env.OWNER_LC }}/mtogo-notification:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Download Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/download-artifact@v4
        with:
          name: image-mtogo-notification
          path: /tmp
          run-id: ${{ needs.detect_changed_services.outputs.cicd-run-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load Docker image (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: docker load -i /tmp/mtogo-notification.tar

      - name: Set image ref (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: echo "IMAGE_REF=mtogo-notification:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Install gitleaks
        run: |
          VERSION=8.29.1
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz \
          | tar xz -C /usr/local/bin gitleaks

      - name: Gitleaks scan (Notification)
        run: |
          gitleaks detect \
            --source MToGo/src/MToGo.NotificationService \
            --config .gitleaks.toml \
            --no-git \
            -v

      - name: Trivy FS scan (Notification, HIGH/CRITICAL fail)
        id: trivy_fs
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: fs
          scan-ref: MToGo/src/MToGo.NotificationService
          format: sarif
          output: trivy-notification-fs.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Trivy image scan (Notification, HIGH/CRITICAL fail)
        id: trivy_image
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: image
          image-ref: ${{ env.IMAGE_REF }}
          format: sarif
          output: trivy-notification-image.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Upload Trivy FS SARIF (Notification)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-notification-fs.sarif
          category: trivy-notification-fs

      - name: Upload Trivy image SARIF (Notification)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-notification-image.sarif
          category: trivy-notification-image

      - name: Check Trivy scan results
        if: steps.trivy_fs.outcome == 'failure' || steps.trivy_image.outcome == 'failure'
        run: |
          echo "Trivy found HIGH/CRITICAL vulnerabilities"
          exit 1

  security_partner:
    name: Partner - security gates
    needs: detect_changed_services
    if: ${{ needs.detect_changed_services.outputs.partner == 'true' || needs.detect_changed_services.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.IMAGE_TAG }}
          fetch-depth: 0

      - name: Set lowercase owner
        run: echo "OWNER_LC=${OWNER,,}" >> "$GITHUB_ENV"
        env:
          OWNER: ${{ github.repository_owner }}

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Partner image from GHCR (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: docker pull ghcr.io/${{ env.OWNER_LC }}/mtogo-partner:${{ env.IMAGE_TAG }}

      - name: Set image ref (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: echo "IMAGE_REF=ghcr.io/${{ env.OWNER_LC }}/mtogo-partner:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Download Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/download-artifact@v4
        with:
          name: image-mtogo-partner
          path: /tmp
          run-id: ${{ needs.detect_changed_services.outputs.cicd-run-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load Docker image (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: docker load -i /tmp/mtogo-partner.tar

      - name: Set image ref (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: echo "IMAGE_REF=mtogo-partner:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Install gitleaks
        run: |
          VERSION=8.29.1
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz \
          | tar xz -C /usr/local/bin gitleaks

      - name: Gitleaks scan (Partner)
        run: |
          gitleaks detect \
            --source MToGo/src/MToGo.PartnerService \
            --config .gitleaks.toml \
            --no-git \
            -v

      - name: Trivy FS scan (Partner, HIGH/CRITICAL fail)
        id: trivy_fs
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: fs
          scan-ref: MToGo/src/MToGo.PartnerService
          format: sarif
          output: trivy-partner-fs.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Trivy image scan (Partner, HIGH/CRITICAL fail)
        id: trivy_image
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: image
          image-ref: ${{ env.IMAGE_REF }}
          format: sarif
          output: trivy-partner-image.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Upload Trivy FS SARIF (Partner)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-partner-fs.sarif
          category: trivy-partner-fs

      - name: Upload Trivy image SARIF (Partner)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-partner-image.sarif
          category: trivy-partner-image

      - name: Check Trivy scan results
        if: steps.trivy_fs.outcome == 'failure' || steps.trivy_image.outcome == 'failure'
        run: |
          echo "Trivy found HIGH/CRITICAL vulnerabilities"
          exit 1

  security_logcollector:
    name: LogCollector - security gates
    needs: detect_changed_services
    if: ${{ needs.detect_changed_services.outputs.logcollector == 'true' || needs.detect_changed_services.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.IMAGE_TAG }}
          fetch-depth: 0

      - name: Set lowercase owner
        run: echo "OWNER_LC=${OWNER,,}" >> "$GITHUB_ENV"
        env:
          OWNER: ${{ github.repository_owner }}

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull LogCollector image from GHCR (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: docker pull ghcr.io/${{ env.OWNER_LC }}/mtogo-logcollector:${{ env.IMAGE_TAG }}

      - name: Set image ref (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: echo "IMAGE_REF=ghcr.io/${{ env.OWNER_LC }}/mtogo-logcollector:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Download Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/download-artifact@v4
        with:
          name: image-mtogo-logcollector
          path: /tmp
          run-id: ${{ needs.detect_changed_services.outputs.cicd-run-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load Docker image (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: docker load -i /tmp/mtogo-logcollector.tar

      - name: Set image ref (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: echo "IMAGE_REF=mtogo-logcollector:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Install gitleaks
        run: |
          VERSION=8.29.1
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz \
          | tar xz -C /usr/local/bin gitleaks

      - name: Gitleaks scan (LogCollector)
        run: |
          gitleaks detect \
            --source MToGo/src/MToGo.LogCollectorService \
            --config .gitleaks.toml \
            --no-git \
            -v

      - name: Trivy FS scan (LogCollector, HIGH/CRITICAL fail)
        id: trivy_fs
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: fs
          scan-ref: MToGo/src/MToGo.LogCollectorService
          format: sarif
          output: trivy-logcollector-fs.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Trivy image scan (LogCollector, HIGH/CRITICAL fail)
        id: trivy_image
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: image
          image-ref: ${{ env.IMAGE_REF }}
          format: sarif
          output: trivy-logcollector-image.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Upload Trivy FS SARIF (LogCollector)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-logcollector-fs.sarif
          category: trivy-logcollector-fs

      - name: Upload Trivy image SARIF (LogCollector)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-logcollector-image.sarif
          category: trivy-logcollector-image

      - name: Check Trivy scan results
        if: steps.trivy_fs.outcome == 'failure' || steps.trivy_image.outcome == 'failure'
        run: |
          echo "Trivy found HIGH/CRITICAL vulnerabilities"
          exit 1

  security_website:
    name: Website - security gates
    needs: detect_changed_services
    if: ${{ needs.detect_changed_services.outputs.website == 'true' || needs.detect_changed_services.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.IMAGE_TAG }}
          fetch-depth: 0

      - name: Set lowercase owner
        run: echo "OWNER_LC=${OWNER,,}" >> "$GITHUB_ENV"
        env:
          OWNER: ${{ github.repository_owner }}

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Website image from GHCR (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: docker pull ghcr.io/${{ env.OWNER_LC }}/mtogo-website:${{ env.IMAGE_TAG }}

      - name: Set image ref (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: echo "IMAGE_REF=ghcr.io/${{ env.OWNER_LC }}/mtogo-website:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Download Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/download-artifact@v4
        with:
          name: image-mtogo-website
          path: /tmp
          run-id: ${{ needs.detect_changed_services.outputs.cicd-run-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load Docker image (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: docker load -i /tmp/mtogo-website.tar

      - name: Set image ref (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: echo "IMAGE_REF=mtogo-website:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Install gitleaks
        run: |
          VERSION=8.29.1
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz \
          | tar xz -C /usr/local/bin gitleaks

      - name: Gitleaks scan (Website)
        run: |
          gitleaks detect \
            --source MToGo/src/MToGo.Website \
            --config .gitleaks.toml \
            --no-git \
            -v

      - name: Trivy FS scan (Website, HIGH/CRITICAL fail)
        id: trivy_fs
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: fs
          scan-ref: MToGo/src/MToGo.Website
          format: sarif
          output: trivy-website-fs.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Trivy image scan (Website, HIGH/CRITICAL fail)
        id: trivy_image
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: image
          image-ref: ${{ env.IMAGE_REF }}
          format: sarif
          output: trivy-website-image.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Upload Trivy FS SARIF (Website)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-website-fs.sarif
          category: trivy-website-fs

      - name: Upload Trivy image SARIF (Website)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-website-image.sarif
          category: trivy-website-image

      - name: Check Trivy scan results
        if: steps.trivy_fs.outcome == 'failure' || steps.trivy_image.outcome == 'failure'
        run: |
          echo "Trivy found HIGH/CRITICAL vulnerabilities"
          exit 1

  security_websocketagent:
    name: WebSocketAgent - security gates
    needs: detect_changed_services
    if: ${{ needs.detect_changed_services.outputs.websocketagent == 'true' || needs.detect_changed_services.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.IMAGE_TAG }}
          fetch-depth: 0

      - name: Set lowercase owner
        run: echo "OWNER_LC=${OWNER,,}" >> "$GITHUB_ENV"
        env:
          OWNER: ${{ github.repository_owner }}

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull WebSocketAgent image from GHCR (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: docker pull ghcr.io/${{ env.OWNER_LC }}/mtogo-websocketagent:${{ env.IMAGE_TAG }}

      - name: Set image ref (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: echo "IMAGE_REF=ghcr.io/${{ env.OWNER_LC }}/mtogo-websocketagent:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Download Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/download-artifact@v4
        with:
          name: image-mtogo-websocketagent
          path: /tmp
          run-id: ${{ needs.detect_changed_services.outputs.cicd-run-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load Docker image (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: docker load -i /tmp/mtogo-websocketagent.tar

      - name: Set image ref (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: echo "IMAGE_REF=mtogo-websocketagent:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Install gitleaks
        run: |
          VERSION=8.29.1
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz \
          | tar xz -C /usr/local/bin gitleaks

      - name: Gitleaks scan (WebSocketAgent)
        run: |
          gitleaks detect \
            --source MToGo/src/MToGo.WebSocketAgentService \
            --config .gitleaks.toml \
            --no-git \
            -v

      - name: Trivy FS scan (WebSocketAgent, HIGH/CRITICAL fail)
        id: trivy_fs
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: fs
          scan-ref: MToGo/src/MToGo.WebSocketAgentService
          format: sarif
          output: trivy-websocketagent-fs.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Trivy image scan (WebSocketAgent, HIGH/CRITICAL fail)
        id: trivy_image
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: image
          image-ref: ${{ env.IMAGE_REF }}
          format: sarif
          output: trivy-websocketagent-image.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Upload Trivy FS SARIF (WebSocketAgent)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-websocketagent-fs.sarif
          category: trivy-websocketagent-fs

      - name: Upload Trivy image SARIF (WebSocketAgent)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-websocketagent-image.sarif
          category: trivy-websocketagent-image

      - name: Check Trivy scan results
        if: steps.trivy_fs.outcome == 'failure' || steps.trivy_image.outcome == 'failure'
        run: |
          echo "Trivy found HIGH/CRITICAL vulnerabilities"
          exit 1

  security_websocketcustomer:
    name: WebSocketCustomer - security gates
    needs: detect_changed_services
    if: ${{ needs.detect_changed_services.outputs.websocketcustomer == 'true' || needs.detect_changed_services.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.IMAGE_TAG }}
          fetch-depth: 0

      - name: Set lowercase owner
        run: echo "OWNER_LC=${OWNER,,}" >> "$GITHUB_ENV"
        env:
          OWNER: ${{ github.repository_owner }}

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull WebSocketCustomer image from GHCR (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: docker pull ghcr.io/${{ env.OWNER_LC }}/mtogo-websocketcustomer:${{ env.IMAGE_TAG }}

      - name: Set image ref (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: echo "IMAGE_REF=ghcr.io/${{ env.OWNER_LC }}/mtogo-websocketcustomer:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Download Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/download-artifact@v4
        with:
          name: image-mtogo-websocketcustomer
          path: /tmp
          run-id: ${{ needs.detect_changed_services.outputs.cicd-run-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load Docker image (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: docker load -i /tmp/mtogo-websocketcustomer.tar

      - name: Set image ref (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: echo "IMAGE_REF=mtogo-websocketcustomer:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Install gitleaks
        run: |
          VERSION=8.29.1
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz \
          | tar xz -C /usr/local/bin gitleaks

      - name: Gitleaks scan (WebSocketCustomer)
        run: |
          gitleaks detect \
            --source MToGo/src/MToGo.WebSocketCustomerService \
            --config .gitleaks.toml \
            --no-git \
            -v

      - name: Trivy FS scan (WebSocketCustomer, HIGH/CRITICAL fail)
        id: trivy_fs
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: fs
          scan-ref: MToGo/src/MToGo.WebSocketCustomerService
          format: sarif
          output: trivy-websocketcustomer-fs.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Trivy image scan (WebSocketCustomer, HIGH/CRITICAL fail)
        id: trivy_image
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: image
          image-ref: ${{ env.IMAGE_REF }}
          format: sarif
          output: trivy-websocketcustomer-image.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Upload Trivy FS SARIF (WebSocketCustomer)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-websocketcustomer-fs.sarif
          category: trivy-websocketcustomer-fs

      - name: Upload Trivy image SARIF (WebSocketCustomer)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-websocketcustomer-image.sarif
          category: trivy-websocketcustomer-image

      - name: Check Trivy scan results
        if: steps.trivy_fs.outcome == 'failure' || steps.trivy_image.outcome == 'failure'
        run: |
          echo "Trivy found HIGH/CRITICAL vulnerabilities"
          exit 1

  security_websocketpartner:
    name: WebSocketPartner - security gates
    needs: detect_changed_services
    if: ${{ needs.detect_changed_services.outputs.websocketpartner == 'true' || needs.detect_changed_services.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.IMAGE_TAG }}
          fetch-depth: 0

      - name: Set lowercase owner
        run: echo "OWNER_LC=${OWNER,,}" >> "$GITHUB_ENV"
        env:
          OWNER: ${{ github.repository_owner }}

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull WebSocketPartner image from GHCR (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: docker pull ghcr.io/${{ env.OWNER_LC }}/mtogo-websocketpartner:${{ env.IMAGE_TAG }}

      - name: Set image ref (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: echo "IMAGE_REF=ghcr.io/${{ env.OWNER_LC }}/mtogo-websocketpartner:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Download Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/download-artifact@v4
        with:
          name: image-mtogo-websocketpartner
          path: /tmp
          run-id: ${{ needs.detect_changed_services.outputs.cicd-run-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load Docker image (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: docker load -i /tmp/mtogo-websocketpartner.tar

      - name: Set image ref (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: echo "IMAGE_REF=mtogo-websocketpartner:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Install gitleaks
        run: |
          VERSION=8.29.1
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz \
          | tar xz -C /usr/local/bin gitleaks

      - name: Gitleaks scan (WebSocketPartner)
        run: |
          gitleaks detect \
            --source MToGo/src/MToGo.WebSocketPartnerService \
            --config .gitleaks.toml \
            --no-git \
            -v

      - name: Trivy FS scan (WebSocketPartner, HIGH/CRITICAL fail)
        id: trivy_fs
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: fs
          scan-ref: MToGo/src/MToGo.WebSocketPartnerService
          format: sarif
          output: trivy-websocketpartner-fs.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Trivy image scan (WebSocketPartner, HIGH/CRITICAL fail)
        id: trivy_image
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: image
          image-ref: ${{ env.IMAGE_REF }}
          format: sarif
          output: trivy-websocketpartner-image.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Upload Trivy FS SARIF (WebSocketPartner)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-websocketpartner-fs.sarif
          category: trivy-websocketpartner-fs

      - name: Upload Trivy image SARIF (WebSocketPartner)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-websocketpartner-image.sarif
          category: trivy-websocketpartner-image

      - name: Check Trivy scan results
        if: steps.trivy_fs.outcome == 'failure' || steps.trivy_image.outcome == 'failure'
        run: |
          echo "Trivy found HIGH/CRITICAL vulnerabilities"
          exit 1

  security_management:
    name: Management - security gates
    needs: detect_changed_services
    if: ${{ needs.detect_changed_services.outputs.management == 'true' || needs.detect_changed_services.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.IMAGE_TAG }}
          fetch-depth: 0

      - name: Set lowercase owner
        run: echo "OWNER_LC=${OWNER,,}" >> "$GITHUB_ENV"
        env:
          OWNER: ${{ github.repository_owner }}

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Management image from GHCR (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: docker pull ghcr.io/${{ env.OWNER_LC }}/mtogo-management:${{ env.IMAGE_TAG }}

      - name: Set image ref (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: echo "IMAGE_REF=ghcr.io/${{ env.OWNER_LC }}/mtogo-management:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Download Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/download-artifact@v4
        with:
          name: image-mtogo-management
          path: /tmp
          run-id: ${{ needs.detect_changed_services.outputs.cicd-run-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load Docker image (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: docker load -i /tmp/mtogo-management.tar

      - name: Set image ref (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: echo "IMAGE_REF=mtogo-management:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Install gitleaks
        run: |
          VERSION=8.29.1
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz \
          | tar xz -C /usr/local/bin gitleaks

      - name: Gitleaks scan (Management)
        run: |
          gitleaks detect \
            --source MToGo/src/MToGo.ManagementService \
            --config .gitleaks.toml \
            --no-git \
            -v

      - name: Trivy FS scan (Management, HIGH/CRITICAL fail)
        id: trivy_fs
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: fs
          scan-ref: MToGo/src/MToGo.ManagementService
          format: sarif
          output: trivy-management-fs.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Trivy image scan (Management, HIGH/CRITICAL fail)
        id: trivy_image
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: image
          image-ref: ${{ env.IMAGE_REF }}
          format: sarif
          output: trivy-management-image.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Upload Trivy FS SARIF (Management)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-management-fs.sarif
          category: trivy-management-fs

      - name: Upload Trivy image SARIF (Management)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-management-image.sarif
          category: trivy-management-image

      - name: Check Trivy scan results
        if: steps.trivy_fs.outcome == 'failure' || steps.trivy_image.outcome == 'failure'
        run: |
          echo "Trivy found HIGH/CRITICAL vulnerabilities"
          exit 1

  security_legacy:
    name: LegacyMToGo - security gates
    needs: detect_changed_services
    if: ${{ needs.detect_changed_services.outputs.legacy == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.IMAGE_TAG }}
          fetch-depth: 0

      - name: Set lowercase owner
        run: echo "OWNER_LC=${OWNER,,}" >> "$GITHUB_ENV"
        env:
          OWNER: ${{ github.repository_owner }}

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull LegacyMToGo image from GHCR (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: docker pull ghcr.io/${{ env.OWNER_LC }}/mtogo-legacy:${{ env.IMAGE_TAG }}

      - name: Set image ref (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: echo "IMAGE_REF=ghcr.io/${{ env.OWNER_LC }}/mtogo-legacy:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Download Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/download-artifact@v4
        with:
          name: image-mtogo-legacy
          path: /tmp
          run-id: ${{ needs.detect_changed_services.outputs.cicd-run-id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load Docker image (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: docker load -i /tmp/mtogo-legacy.tar

      - name: Set image ref (PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: echo "IMAGE_REF=mtogo-legacy:${{ env.IMAGE_TAG }}" >> "$GITHUB_ENV"

      - name: Install gitleaks
        run: |
          VERSION=8.29.1
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz \
          | tar xz -C /usr/local/bin gitleaks

      - name: Gitleaks scan (LegacyMToGo)
        run: |
          gitleaks detect \
            --source LegacyMToGo \
            --config .gitleaks.toml \
            --no-git \
            -v

      - name: Trivy FS scan (LegacyMToGo, HIGH/CRITICAL fail)
        id: trivy_fs
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: fs
          scan-ref: LegacyMToGo
          format: sarif
          output: trivy-legacy-fs.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Trivy image scan (LegacyMToGo, HIGH/CRITICAL fail)
        id: trivy_image
        uses: aquasecurity/trivy-action@0.24.0
        continue-on-error: true
        with:
          scan-type: image
          image-ref: ${{ env.IMAGE_REF }}
          format: sarif
          output: trivy-legacy-image.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Upload Trivy FS SARIF (LegacyMToGo)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-legacy-fs.sarif
          category: trivy-legacy-fs

      - name: Upload Trivy image SARIF (LegacyMToGo)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-legacy-image.sarif
          category: trivy-legacy-image

      - name: Check Trivy scan results
        if: steps.trivy_fs.outcome == 'failure' || steps.trivy_image.outcome == 'failure'
        run: |
          echo "Trivy found HIGH/CRITICAL vulnerabilities"
          exit 1

  security_all_checks:
    name: Security - all checks
    runs-on: ubuntu-latest
    needs:
      - wait_for_cicd
      - detect_changed_services
      - codeql
      - security_agentbonus
      - security_agentservice
      - security_customerservice
      - security_feedbackhub
      - security_gateway
      - security_notification
      - security_order
      - security_partner
      - security_logcollector
      - security_website
      - security_websocketagent
      - security_websocketcustomer
      - security_websocketpartner
      - security_management
      - security_legacy
    # Always run so we can explicitly fail even if others failed
    if: always()

    steps:
      - name: Evaluate security job results
        run: |
          echo "wait_for_cicd:        ${{ needs.wait_for_cicd.result }}"
          echo "detect_changed_services: ${{ needs.detect_changed_services.result }}"
          echo "codeql:                 ${{ needs.codeql.result }}"
          echo "security_agentbonus:    ${{ needs.security_agentbonus.result }}"
          echo "security_agentservice:  ${{ needs.security_agentservice.result }}"
          echo "security_customerservice: ${{ needs.security_customerservice.result }}"
          echo "security_feedbackhub:   ${{ needs.security_feedbackhub.result }}"
          echo "security_gateway:       ${{ needs.security_gateway.result }}"
          echo "security_notification:  ${{ needs.security_notification.result }}"
          echo "security_order:         ${{ needs.security_order.result }}"
          echo "security_partner:       ${{ needs.security_partner.result }}"
          echo "security_logcollector:  ${{ needs.security_logcollector.result }}"
          echo "security_website:       ${{ needs.security_website.result }}"
          echo "security_websocketagent: ${{ needs.security_websocketagent.result }}"
          echo "security_websocketcustomer: ${{ needs.security_websocketcustomer.result }}"
          echo "security_websocketpartner: ${{ needs.security_websocketpartner.result }}"
          echo "security_management:    ${{ needs.security_management.result }}"
          echo "security_legacy:        ${{ needs.security_legacy.result }}"

          failed=false

          for result in \
            "${{ needs.wait_for_cicd.result }}" \
            "${{ needs.detect_changed_services.result }}" \
            "${{ needs.codeql.result }}" \
            "${{ needs.security_agentbonus.result }}" \
            "${{ needs.security_agentservice.result }}" \
            "${{ needs.security_customerservice.result }}" \
            "${{ needs.security_feedbackhub.result }}" \
            "${{ needs.security_gateway.result }}" \
            "${{ needs.security_notification.result }}" \
            "${{ needs.security_order.result }}" \
            "${{ needs.security_partner.result }}" \
            "${{ needs.security_logcollector.result }}" \
            "${{ needs.security_website.result }}" \
            "${{ needs.security_websocketagent.result }}" \
            "${{ needs.security_websocketcustomer.result }}" \
            "${{ needs.security_websocketpartner.result }}" \
            "${{ needs.security_management.result }}" \
            "${{ needs.security_legacy.result }}"; do

            if [ "$result" = "failure" ] || [ "$result" = "cancelled" ]; then
              failed=true
            fi
          done

          if [ "$failed" = true ]; then
            echo "One or more security jobs failed or were cancelled."
            exit 1
          fi

          echo "All required security jobs succeeded (or were skipped)."
