name: CI / CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: cicd-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write

env:
  IMAGE_TAG: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}

jobs:
  detect_changes:
    name: Detect changed services
    runs-on: ubuntu-latest

    outputs:
      shared: ${{ steps.filter.outputs.shared }}
      agentbonus: ${{ steps.filter.outputs.agentbonus }}
      agentservice: ${{ steps.filter.outputs.agentservice }}
      customerservice: ${{ steps.filter.outputs.customerservice }}
      feedbackhub: ${{ steps.filter.outputs.feedbackhub }}
      gateway: ${{ steps.filter.outputs.gateway }}
      notification: ${{ steps.filter.outputs.notification }}
      order: ${{ steps.filter.outputs.order }}
      partner: ${{ steps.filter.outputs.partner }}
      website: ${{ steps.filter.outputs.website }}
      websocketagent: ${{ steps.filter.outputs.websocketagent }}
      websocketcustomer: ${{ steps.filter.outputs.websocketcustomer }}
      websocketpartner: ${{ steps.filter.outputs.websocketpartner }}
      management: ${{ steps.filter.outputs.management }}
      legacy: ${{ steps.filter.outputs.legacy }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            # Fælles kode / config der påvirker flere services
            shared:
              - 'MToGo/src/MToGo.Shared/**'
              - 'MToGo/Directory.Packages.props'
              - 'MToGo/*.sln'
              - '.github/workflows/**'

            agentbonus:
              - 'MToGo/src/MToGo.AgentBonusService/**'
              - 'MToGo/tests/MToGo.AgentBonusService.Tests/**'

            agentservice:
              - 'MToGo/src/MToGo.AgentService/**'
              - 'MToGo/tests/MToGo.AgentService.Tests/**'

            customerservice:
              - 'MToGo/src/MToGo.CustomerService/**'
              - 'MToGo/tests/MToGo.CustomerService.Tests/**'

            feedbackhub:
              - 'MToGo/src/MToGo.FeedbackHubService/**'
              - 'MToGo/tests/MToGo.FeedbackHubService.Tests/**'

            gateway:
              - 'MToGo/src/MToGo.Gateway/**'
              - 'MToGo/tests/MToGo.Gateway.Tests/**'

            notification:
              - 'MToGo/src/MToGo.NotificationService/**'
              - 'MToGo/tests/MToGo.NotificationService.Tests/**'

            order:
              - 'MToGo/src/MToGo.OrderService/**'
              - 'MToGo/tests/MToGo.OrderService.Tests/**'

            partner:
              - 'MToGo/src/MToGo.PartnerService/**'
              - 'MToGo/tests/MToGo.PartnerService.Tests/**'

            website:
              - 'MToGo/src/MToGo.Website/**'
              - 'MToGo/tests/MToGo.Website.Tests/**'

            websocketagent:
              - 'MToGo/src/MToGo.WebSocketAgentService/**'
              - 'MToGo/tests/MToGo.WebSocketAgentService.Tests/**'

            websocketcustomer:
              - 'MToGo/src/MToGo.WebSocketCustomerService/**'
              - 'MToGo/tests/MToGo.WebSocketCustomerService.Tests/**'

            websocketpartner:
              - 'MToGo/src/MToGo.WebSocketPartnerService/**'
              - 'MToGo/tests/MToGo.WebSocketPartnerService.Tests/**'

            management:
              - 'MToGo/src/MToGo.ManagementService/**'
              - 'MToGo/tests/MToGo.ManagementService.Tests/**'

            legacy:
              - 'LegacyMToGo/**'

  agentbonus_ci:
    name: AgentBonus - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.agentbonus == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.AgentBonusService.csproj', '**/MToGo.AgentBonusService.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.AgentBonusService/MToGo.AgentBonusService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.AgentBonusService/MToGo.AgentBonusService.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.AgentBonusService.Tests/MToGo.AgentBonusService.Tests.csproj -c Release 

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push Docker image
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.AgentBonusService/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/mtogo-agentbonus:${{ env.IMAGE_TAG }}
            ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' && format('ghcr.io/{0}/mtogo-agentbonus:latest', github.repository_owner) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  agentservice_ci:
    name: AgentService - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.agentservice == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.AgentService.csproj', '**/MToGo.AgentService.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.AgentService/MToGo.AgentService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.AgentService/MToGo.AgentService.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.AgentService.Tests/MToGo.AgentService.Tests.csproj -c Release 

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push Docker image
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.AgentService/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/mtogo-agentservice:${{ env.IMAGE_TAG }}
            ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' && format('ghcr.io/{0}/mtogo-agentservice:latest', github.repository_owner) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  customerservice_ci:
    name: CustomerService - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.customerservice == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.CustomerService.csproj', '**/MToGo.CustomerService.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.CustomerService/MToGo.CustomerService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.CustomerService/MToGo.CustomerService.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.CustomerService.Tests/MToGo.CustomerService.Tests.csproj -c Release 

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push Docker image
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.CustomerService/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/mtogo-customerservice:${{ env.IMAGE_TAG }}
            ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' && format('ghcr.io/{0}/mtogo-customerservice:latest', github.repository_owner) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  feedbackhub_ci:
    name: FeedbackHub - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.feedbackhub == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.FeedbackHubService.csproj', '**/MToGo.FeedbackHubService.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.FeedbackHubService/MToGo.FeedbackHubService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.FeedbackHubService/MToGo.FeedbackHubService.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.FeedbackHubService.Tests/MToGo.FeedbackHubService.Tests.csproj -c Release 

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push Docker image
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.FeedbackHubService/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/mtogo-feedbackhub:${{ env.IMAGE_TAG }}
            ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' && format('ghcr.io/{0}/mtogo-feedbackhub:latest', github.repository_owner) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  gateway_ci:
    name: Gateway - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.gateway == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.Gateway.csproj', '**/MToGo.Gateway.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.Gateway/MToGo.Gateway.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.Gateway/MToGo.Gateway.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.Gateway.Tests/MToGo.Gateway.Tests.csproj -c Release 

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push Docker image
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.Gateway/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/mtogo-gateway:${{ env.IMAGE_TAG }}
            ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' && format('ghcr.io/{0}/mtogo-gateway:latest', github.repository_owner) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  notification_ci:
    name: Notification - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.notification == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.NotificationService.csproj', '**/MToGo.NotificationService.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.NotificationService/MToGo.NotificationService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.NotificationService/MToGo.NotificationService.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.NotificationService.Tests/MToGo.NotificationService.Tests.csproj -c Release 

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push Docker image
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.NotificationService/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/mtogo-notification:${{ env.IMAGE_TAG }}
            ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' && format('ghcr.io/{0}/mtogo-notification:latest', github.repository_owner) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  order_ci:
    name: Order - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.order == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.OrderService.csproj', '**/MToGo.OrderService.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.OrderService/MToGo.OrderService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.OrderService/MToGo.OrderService.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.OrderService.Tests/MToGo.OrderService.Tests.csproj -c Release 

      - name: Run EP & BVA Tests
        run: dotnet test MToGo/tests/MToGo.OrderService.Tests/MToGo.OrderService.Tests.csproj -c Release  --filter "ServiceFeeCalculationTests" --logger "console;verbosity=normal"

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push Docker image
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.OrderService/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/mtogo-order:${{ env.IMAGE_TAG }}
            ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' && format('ghcr.io/{0}/mtogo-order:latest', github.repository_owner) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  partner_ci:
    name: Partner - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.partner == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.PartnerService.csproj', '**/MToGo.PartnerService.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.PartnerService/MToGo.PartnerService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.PartnerService/MToGo.PartnerService.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.PartnerService.Tests/MToGo.PartnerService.Tests.csproj -c Release 

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push Docker image
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.PartnerService/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/mtogo-partner:${{ env.IMAGE_TAG }}
            ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' && format('ghcr.io/{0}/mtogo-partner:latest', github.repository_owner) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  website_ci:
    name: Website - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.website == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.Website.csproj', '**/MToGo.Website.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.Website/MToGo.Website.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.Website/MToGo.Website.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.Website.Tests/MToGo.Website.Tests.csproj -c Release 

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push Docker image
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.Website/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/mtogo-website:${{ env.IMAGE_TAG }}
            ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' && format('ghcr.io/{0}/mtogo-website:latest', github.repository_owner) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  websocketagent_ci:
    name: WebSocketAgent - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.websocketagent == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.WebSocketAgentService.csproj', '**/MToGo.WebSocketAgentService.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.WebSocketAgentService/MToGo.WebSocketAgentService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.WebSocketAgentService/MToGo.WebSocketAgentService.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.WebSocketAgentService.Tests/MToGo.WebSocketAgentService.Tests.csproj -c Release 

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push Docker image
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.WebSocketAgentService/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/mtogo-websocketagent:${{ env.IMAGE_TAG }}
            ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' && format('ghcr.io/{0}/mtogo-websocketagent:latest', github.repository_owner) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  websocketcustomer_ci:
    name: WebSocketCustomer - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.websocketcustomer == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.WebSocketCustomerService.csproj', '**/MToGo.WebSocketCustomerService.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.WebSocketCustomerService/MToGo.WebSocketCustomerService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.WebSocketCustomerService/MToGo.WebSocketCustomerService.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.WebSocketCustomerService.Tests/MToGo.WebSocketCustomerService.Tests.csproj -c Release 

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push Docker image
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.WebSocketCustomerService/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/mtogo-websocketcustomer:${{ env.IMAGE_TAG }}
            ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' && format('ghcr.io/{0}/mtogo-websocketcustomer:latest', github.repository_owner) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  websocketpartner_ci:
    name: WebSocketPartner - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.websocketpartner == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.WebSocketPartnerService.csproj', '**/MToGo.WebSocketPartnerService.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.WebSocketPartnerService/MToGo.WebSocketPartnerService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.WebSocketPartnerService/MToGo.WebSocketPartnerService.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.WebSocketPartnerService.Tests/MToGo.WebSocketPartnerService.Tests.csproj -c Release 

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push Docker image
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.WebSocketPartnerService/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/mtogo-websocketpartner:${{ env.IMAGE_TAG }}
            ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' && format('ghcr.io/{0}/mtogo-websocketpartner:latest', github.repository_owner) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  management_ci:
    name: Management - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.management == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.ManagementService.csproj', '**/MToGo.ManagementService.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.ManagementService/MToGo.ManagementService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.ManagementService/MToGo.ManagementService.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.ManagementService.Tests/MToGo.ManagementService.Tests.csproj -c Release 

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push Docker image
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.ManagementService/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/mtogo-management:${{ env.IMAGE_TAG }}
            ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' && format('ghcr.io/{0}/mtogo-management:latest', github.repository_owner) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  legacy_ci:
    name: LegacyMToGo - build & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.legacy == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/LegacyMToGo.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore LegacyMToGo/LegacyMToGo.csproj

      - name: Build
        run: dotnet build LegacyMToGo/LegacyMToGo.csproj -c Release --no-restore

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push Docker image
        uses: docker/build-push-action@v5
        with:
          context: LegacyMToGo/
          file: LegacyMToGo/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/mtogo-legacy:${{ env.IMAGE_TAG }}
            ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' && format('ghcr.io/{0}/mtogo-legacy:latest', github.repository_owner) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Save build outputs for security workflow
  save_build_outputs:
    name: Save build outputs
    needs:
      - detect_changes
      - agentbonus_ci
      - agentservice_ci
      - customerservice_ci
      - feedbackhub_ci
      - gateway_ci
      - notification_ci
      - order_ci
      - partner_ci
      - website_ci
      - websocketagent_ci
      - websocketcustomer_ci
      - websocketpartner_ci
      - management_ci
      - legacy_ci
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Create build outputs file
        run: |
          cat << EOF > build-outputs.json
          {
            "shared": "${{ needs.detect_changes.outputs.shared }}",
            "agentbonus": "${{ needs.detect_changes.outputs.agentbonus }}",
            "agentservice": "${{ needs.detect_changes.outputs.agentservice }}",
            "customerservice": "${{ needs.detect_changes.outputs.customerservice }}",
            "feedbackhub": "${{ needs.detect_changes.outputs.feedbackhub }}",
            "gateway": "${{ needs.detect_changes.outputs.gateway }}",
            "notification": "${{ needs.detect_changes.outputs.notification }}",
            "order": "${{ needs.detect_changes.outputs.order }}",
            "partner": "${{ needs.detect_changes.outputs.partner }}",
            "website": "${{ needs.detect_changes.outputs.website }}",
            "websocketagent": "${{ needs.detect_changes.outputs.websocketagent }}",
            "websocketcustomer": "${{ needs.detect_changes.outputs.websocketcustomer }}",
            "websocketpartner": "${{ needs.detect_changes.outputs.websocketpartner }}",
            "management": "${{ needs.detect_changes.outputs.management }}",
            "legacy": "${{ needs.detect_changes.outputs.legacy }}"
          }
          EOF
          cat build-outputs.json

      - name: Upload build outputs
        uses: actions/upload-artifact@v4
        with:
          name: build-outputs
          path: build-outputs.json
          retention-days: 1
