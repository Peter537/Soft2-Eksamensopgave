name: CI / CD Pipeline

on:
  push:
    branches: [main]
    paths:
      - "MToGo/src/**"
      - "MToGo/tests/**"
      - "LegacyMToGo/**"
      - "MToGo/*.sln"
      - "MToGo/Directory.Packages.props"
      - "MToGo/.dockerignore"
      - "LegacyMToGo/.dockerignore"
      - ".github/workflows/**"
  pull_request:
    branches: [main]
    paths:
      - "MToGo/src/**"
      - "MToGo/tests/**"
      - "LegacyMToGo/**"
      - "MToGo/*.sln"
      - "MToGo/Directory.Packages.props"
      - "MToGo/.dockerignore"
      - "LegacyMToGo/.dockerignore"
      - ".github/workflows/**"

permissions:
  contents: read
  packages: write

jobs:
  detect_changes:
    name: Detect changed services
    runs-on: ubuntu-latest

    outputs:
      shared: ${{ steps.filter.outputs.shared }}
      agentbonus: ${{ steps.filter.outputs.agentbonus }}
      agentservice: ${{ steps.filter.outputs.agentservice }}
      customerservice: ${{ steps.filter.outputs.customerservice }}
      feedbackhub: ${{ steps.filter.outputs.feedbackhub }}
      gateway: ${{ steps.filter.outputs.gateway }}
      notification: ${{ steps.filter.outputs.notification }}
      order: ${{ steps.filter.outputs.order }}
      partner: ${{ steps.filter.outputs.partner }}
      website: ${{ steps.filter.outputs.website }}
      websocketagent: ${{ steps.filter.outputs.websocketagent }}
      websocketcustomer: ${{ steps.filter.outputs.websocketcustomer }}
      websocketpartner: ${{ steps.filter.outputs.websocketpartner }}
      legacy: ${{ steps.filter.outputs.legacy }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            # Fælles kode / config der påvirker flere services
            shared:
              - 'MToGo/src/MToGo.Shared/**'
              - 'MToGo/Directory.Packages.props'
              - 'MToGo/*.sln'
              - '.github/workflows/**'

            agentbonus:
              - 'MToGo/src/MToGo.AgentBonusService/**'
              - 'MToGo/tests/MToGo.AgentBonusService.Tests/**'

            agentservice:
              - 'MToGo/src/MToGo.AgentService/**'
              - 'MToGo/tests/MToGo.AgentService.Tests/**'

            customerservice:
              - 'MToGo/src/MToGo.CustomerService/**'
              - 'MToGo/tests/MToGo.CustomerService.Tests/**'

            feedbackhub:
              - 'MToGo/src/MToGo.FeedbackHubService/**'
              - 'MToGo/tests/MToGo.FeedbackHubService.Tests/**'

            gateway:
              - 'MToGo/src/MToGo.Gateway/**'
              - 'MToGo/tests/MToGo.Gateway.Tests/**'

            notification:
              - 'MToGo/src/MToGo.NotificationService/**'
              - 'MToGo/tests/MToGo.NotificationService.Tests/**'

            order:
              - 'MToGo/src/MToGo.OrderService/**'
              - 'MToGo/tests/MToGo.OrderService.Tests/**'

            partner:
              - 'MToGo/src/MToGo.PartnerService/**'
              - 'MToGo/tests/MToGo.PartnerService.Tests/**'

            website:
              - 'MToGo/src/MToGo.Website/**'
              - 'MToGo/tests/MToGo.Website.Tests/**'

            websocketagent:
              - 'MToGo/src/MToGo.WebSocketAgentService/**'
              - 'MToGo/tests/MToGo.WebSocketAgentService.Tests/**'

            websocketcustomer:
              - 'MToGo/src/MToGo.WebSocketCustomerService/**'
              - 'MToGo/tests/MToGo.WebSocketCustomerService.Tests/**'

            websocketpartner:
              - 'MToGo/src/MToGo.WebSocketPartnerService/**'
              - 'MToGo/tests/MToGo.WebSocketPartnerService.Tests/**'

            legacy:
              - 'LegacyMToGo/**'

  agentbonus_ci:
    name: AgentBonus - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.agentbonus == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.AgentBonusService/MToGo.AgentBonusService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.AgentBonusService/MToGo.AgentBonusService.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.AgentBonusService.Tests/MToGo.AgentBonusService.Tests.csproj -c Release --no-build

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push Docker image
        run: |
          OWNER="${GITHUB_REPOSITORY_OWNER,,}"
          IMAGE_NAME="mtogo-agentbonus"
          IMAGE="ghcr.io/${OWNER}/${IMAGE_NAME}:${GITHUB_SHA}"

          docker build \
            -f MToGo/src/MToGo.AgentBonusService/Dockerfile \
            -t "$IMAGE" \
            MToGo/

          docker push "$IMAGE"

  agentservice_ci:
    name: AgentService - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.agentservice == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.AgentService/MToGo.AgentService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.AgentService/MToGo.AgentService.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.AgentService.Tests/MToGo.AgentService.Tests.csproj -c Release --no-build

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push Docker image
        run: |
          OWNER="${GITHUB_REPOSITORY_OWNER,,}"
          IMAGE_NAME="mtogo-agentservice"
          IMAGE="ghcr.io/${OWNER}/${IMAGE_NAME}:${GITHUB_SHA}"

          docker build \
            -f MToGo/src/MToGo.AgentService/Dockerfile \
            -t "$IMAGE" \
            MToGo/

          docker push "$IMAGE"

  customerservice_ci:
    name: CustomerService - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.customerservice == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.CustomerService/MToGo.CustomerService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.CustomerService/MToGo.CustomerService.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.CustomerService.Tests/MToGo.CustomerService.Tests.csproj -c Release --no-build

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push Docker image
        run: |
          OWNER="${GITHUB_REPOSITORY_OWNER,,}"
          IMAGE_NAME="mtogo-customerservice"
          IMAGE="ghcr.io/${OWNER}/${IMAGE_NAME}:${GITHUB_SHA}"

          docker build \
            -f MToGo/src/MToGo.CustomerService/Dockerfile \
            -t "$IMAGE" \
            MToGo/

          docker push "$IMAGE"

  feedbackhub_ci:
    name: FeedbackHub - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.feedbackhub == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.FeedbackHubService/MToGo.FeedbackHubService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.FeedbackHubService/MToGo.FeedbackHubService.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.FeedbackHubService.Tests/MToGo.FeedbackHubService.Tests.csproj -c Release --no-build

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push Docker image
        run: |
          OWNER="${GITHUB_REPOSITORY_OWNER,,}"
          IMAGE_NAME="mtogo-feedbackhub"
          IMAGE="ghcr.io/${OWNER}/${IMAGE_NAME}:${GITHUB_SHA}"

          docker build \
            -f MToGo/src/MToGo.FeedbackHubService/Dockerfile \
            -t "$IMAGE" \
            MToGo/

          docker push "$IMAGE"

  gateway_ci:
    name: Gateway - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.gateway == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.Gateway/MToGo.Gateway.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.Gateway/MToGo.Gateway.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.Gateway.Tests/MToGo.Gateway.Tests.csproj -c Release --no-build

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push Docker image
        run: |
          OWNER="${GITHUB_REPOSITORY_OWNER,,}"
          IMAGE_NAME="mtogo-gateway"
          IMAGE="ghcr.io/${OWNER}/${IMAGE_NAME}:${GITHUB_SHA}"

          docker build \
            -f MToGo/src/MToGo.Gateway/Dockerfile \
            -t "$IMAGE" \
            MToGo/

          docker push "$IMAGE"

  notification_ci:
    name: Notification - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.notification == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.NotificationService/MToGo.NotificationService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.NotificationService/MToGo.NotificationService.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.NotificationService.Tests/MToGo.NotificationService.Tests.csproj -c Release --no-build

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push Docker image
        run: |
          OWNER="${GITHUB_REPOSITORY_OWNER,,}"
          IMAGE_NAME="mtogo-notification"
          IMAGE="ghcr.io/${OWNER}/${IMAGE_NAME}:${GITHUB_SHA}"

          docker build \
            -f MToGo/src/MToGo.NotificationService/Dockerfile \
            -t "$IMAGE" \
            MToGo/

          docker push "$IMAGE"

  order_ci:
    name: Order - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.order == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.OrderService/MToGo.OrderService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.OrderService/MToGo.OrderService.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.OrderService.Tests/MToGo.OrderService.Tests.csproj -c Release --no-build

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push Docker image
        run: |
          OWNER="${GITHUB_REPOSITORY_OWNER,,}"
          IMAGE_NAME="mtogo-order"
          IMAGE="ghcr.io/${OWNER}/${IMAGE_NAME}:${GITHUB_SHA}"

          docker build \
            -f MToGo/src/MToGo.OrderService/Dockerfile \
            -t "$IMAGE" \
            MToGo/

          docker push "$IMAGE"

  partner_ci:
    name: Partner - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.partner == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.PartnerService/MToGo.PartnerService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.PartnerService/MToGo.PartnerService.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.PartnerService.Tests/MToGo.PartnerService.Tests.csproj -c Release --no-build

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push Docker image
        run: |
          OWNER="${GITHUB_REPOSITORY_OWNER,,}"
          IMAGE_NAME="mtogo-partner"
          IMAGE="ghcr.io/${OWNER}/${IMAGE_NAME}:${GITHUB_SHA}"

          docker build \
            -f MToGo/src/MToGo.PartnerService/Dockerfile \
            -t "$IMAGE" \
            MToGo/

          docker push "$IMAGE"

  website_ci:
    name: Website - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.website == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.Website/MToGo.Website.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.Website/MToGo.Website.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.Website.Tests/MToGo.Website.Tests.csproj -c Release --no-build

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push Docker image
        run: |
          OWNER="${GITHUB_REPOSITORY_OWNER,,}"
          IMAGE_NAME="mtogo-website"
          IMAGE="ghcr.io/${OWNER}/${IMAGE_NAME}:${GITHUB_SHA}"

          docker build \
            -f MToGo/src/MToGo.Website/Dockerfile \
            -t "$IMAGE" \
            MToGo/

          docker push "$IMAGE"

  websocketagent_ci:
    name: WebSocketAgent - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.websocketagent == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.WebSocketAgentService/MToGo.WebSocketAgentService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.WebSocketAgentService/MToGo.WebSocketAgentService.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.WebSocketAgentService.Tests/MToGo.WebSocketAgentService.Tests.csproj -c Release --no-build

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push Docker image
        run: |
          OWNER="${GITHUB_REPOSITORY_OWNER,,}"
          IMAGE_NAME="mtogo-websocketagent"
          IMAGE="ghcr.io/${OWNER}/${IMAGE_NAME}:${GITHUB_SHA}"

          docker build \
            -f MToGo/src/MToGo.WebSocketAgentService/Dockerfile \
            -t "$IMAGE" \
            MToGo/

          docker push "$IMAGE"

  websocketcustomer_ci:
    name: WebSocketCustomer - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.websocketcustomer == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.WebSocketCustomerService/MToGo.WebSocketCustomerService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.WebSocketCustomerService/MToGo.WebSocketCustomerService.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.WebSocketCustomerService.Tests/MToGo.WebSocketCustomerService.Tests.csproj -c Release --no-build

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push Docker image
        run: |
          OWNER="${GITHUB_REPOSITORY_OWNER,,}"
          IMAGE_NAME="mtogo-websocketcustomer"
          IMAGE="ghcr.io/${OWNER}/${IMAGE_NAME}:${GITHUB_SHA}"

          docker build \
            -f MToGo/src/MToGo.WebSocketCustomerService/Dockerfile \
            -t "$IMAGE" \
            MToGo/

          docker push "$IMAGE"

  websocketpartner_ci:
    name: WebSocketPartner - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.websocketpartner == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.WebSocketPartnerService/MToGo.WebSocketPartnerService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.WebSocketPartnerService/MToGo.WebSocketPartnerService.csproj -c Release --no-restore

      - name: Test
        run: dotnet test MToGo/tests/MToGo.WebSocketPartnerService.Tests/MToGo.WebSocketPartnerService.Tests.csproj -c Release --no-build

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push Docker image
        run: |
          OWNER="${GITHUB_REPOSITORY_OWNER,,}"
          IMAGE_NAME="mtogo-websocketpartner"
          IMAGE="ghcr.io/${OWNER}/${IMAGE_NAME}:${GITHUB_SHA}"

          docker build \
            -f MToGo/src/MToGo.WebSocketPartnerService/Dockerfile \
            -t "$IMAGE" \
            MToGo/

          docker push "$IMAGE"

  legacy_ci:
    name: LegacyMToGo - build & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.legacy == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore LegacyMToGo/LegacyMToGo.csproj

      - name: Build
        run: dotnet build LegacyMToGo/LegacyMToGo.csproj -c Release --no-restore

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push Docker image
        run: |
          OWNER="${GITHUB_REPOSITORY_OWNER,,}"
          IMAGE_NAME="mtogo-legacy"
          IMAGE="ghcr.io/${OWNER}/${IMAGE_NAME}:${GITHUB_SHA}"

          docker build \
            -f LegacyMToGo/Dockerfile \
            -t "$IMAGE" \
            LegacyMToGo/

          docker push "$IMAGE"
