name: CI / CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: cicd-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write

env:
  IMAGE_TAG: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}

jobs:
  detect_changes:
    name: Detect changed services
    runs-on: ubuntu-latest

    outputs:
      shared: ${{ steps.filter.outputs.shared }}
      agentbonus: ${{ steps.filter.outputs.agentbonus }}
      agentservice: ${{ steps.filter.outputs.agentservice }}
      customerservice: ${{ steps.filter.outputs.customerservice }}
      feedbackhub: ${{ steps.filter.outputs.feedbackhub }}
      gateway: ${{ steps.filter.outputs.gateway }}
      notification: ${{ steps.filter.outputs.notification }}
      order: ${{ steps.filter.outputs.order }}
      partner: ${{ steps.filter.outputs.partner }}
      logcollector: ${{ steps.filter.outputs.logcollector }}
      website: ${{ steps.filter.outputs.website }}
      websocketagent: ${{ steps.filter.outputs.websocketagent }}
      websocketcustomer: ${{ steps.filter.outputs.websocketcustomer }}
      websocketpartner: ${{ steps.filter.outputs.websocketpartner }}
      management: ${{ steps.filter.outputs.management }}
      legacy: ${{ steps.filter.outputs.legacy }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            # Fælles kode / config der påvirker flere services
            shared:
              - 'MToGo/src/MToGo.Shared/**'
              - 'MToGo/Directory.Packages.props'
              - 'MToGo/*.sln'
              - '.github/workflows/**'

            agentbonus:
              - 'MToGo/src/MToGo.AgentBonusService/**'
              - 'MToGo/tests/MToGo.AgentBonusService.Tests/**'

            agentservice:
              - 'MToGo/src/MToGo.AgentService/**'
              - 'MToGo/tests/MToGo.AgentService.Tests/**'

            customerservice:
              - 'MToGo/src/MToGo.CustomerService/**'
              - 'MToGo/tests/MToGo.CustomerService.Tests/**'

            feedbackhub:
              - 'MToGo/src/MToGo.FeedbackHubService/**'
              - 'MToGo/tests/MToGo.FeedbackHubService.Tests/**'

            gateway:
              - 'MToGo/src/MToGo.Gateway/**'

            notification:
              - 'MToGo/src/MToGo.NotificationService/**'
              - 'MToGo/tests/MToGo.NotificationService.Tests/**'

            order:
              - 'MToGo/src/MToGo.OrderService/**'
              - 'MToGo/tests/MToGo.OrderService.Tests/**'

            partner:
              - 'MToGo/src/MToGo.PartnerService/**'
              - 'MToGo/tests/MToGo.PartnerService.Tests/**'

            logcollector:
              - 'MToGo/src/MToGo.LogCollectorService/**'

            website:
              - 'MToGo/src/MToGo.Website/**'
              - 'MToGo/tests/MToGo.Website.Tests/**'

            websocketagent:
              - 'MToGo/src/MToGo.WebSocketAgentService/**'
              - 'MToGo/tests/MToGo.WebSocketAgentService.Tests/**'

            websocketcustomer:
              - 'MToGo/src/MToGo.WebSocketCustomerService/**'
              - 'MToGo/tests/MToGo.WebSocketCustomerService.Tests/**'

            websocketpartner:
              - 'MToGo/src/MToGo.WebSocketPartnerService/**'
              - 'MToGo/tests/MToGo.WebSocketPartnerService.Tests/**'

            management:
              - 'MToGo/src/MToGo.ManagementService/**'
              - 'MToGo/tests/MToGo.ManagementService.Tests/**'

            legacy:
              - 'LegacyMToGo/**'

  logcollector_ci:
    name: LogCollector - build & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.logcollector == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.LogCollectorService.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.LogCollectorService/MToGo.LogCollectorService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.LogCollectorService/MToGo.LogCollectorService.csproj -c Release --no-restore

      - name: Set lowercase owner
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image tar (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.LogCollectorService/Dockerfile
          push: false
          tags: mtogo-logcollector:${{ env.IMAGE_TAG }}
          outputs: type=docker,dest=/tmp/mtogo-logcollector.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: image-mtogo-logcollector
          path: /tmp/mtogo-logcollector.tar
          retention-days: 1

      - name: Build & push Docker image (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.LogCollectorService/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/mtogo-logcollector:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.OWNER_LC }}/mtogo-logcollector:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  agentbonus_ci:
    name: AgentBonus - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.agentbonus == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.AgentBonusService.csproj', '**/MToGo.AgentBonusService.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.AgentBonusService/MToGo.AgentBonusService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.AgentBonusService/MToGo.AgentBonusService.csproj -c Release --no-restore

      - name: Test with coverage
        run: |
          dotnet test MToGo.AgentBonusService.Tests.csproj -c Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            -p:CoverletExclude="[MToGo.AgentBonusService]*.Models.*;[MToGo.AgentBonusService]*.Entities.*;[MToGo.AgentBonusService]*.Exceptions.*" \
            -p:CoverletThreshold=80 \
            -p:CoverletThresholdType=line \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
        working-directory: MToGo/tests/MToGo.AgentBonusService.Tests

      - name: Restore dotnet tools
        run: dotnet tool restore
        working-directory: MToGo

      - name: Verify coverage file
        run: |
          echo "Looking for coverage files..."
          find MToGo/tests/MToGo.AgentBonusService.Tests/TestResults -name "*.xml" 2>/dev/null || echo "No XML files found"
          ls -laR MToGo/tests/MToGo.AgentBonusService.Tests/TestResults/ 2>/dev/null || echo "Directory not found"

      - name: Generate coverage report
        run: |
          dotnet tool run reportgenerator \
            "-reports:tests/MToGo.AgentBonusService.Tests/TestResults/**/coverage.opencover.xml" \
            "-targetdir:tests/MToGo.AgentBonusService.Tests/TestResults/CoverageReport" \
            -reporttypes:Html
        working-directory: MToGo

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-agentbonus
          path: MToGo/tests/MToGo.AgentBonusService.Tests/TestResults/CoverageReport
          retention-days: 7

      - name: Set lowercase owner
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image tar (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.AgentBonusService/Dockerfile
          push: false
          tags: mtogo-agentbonus:${{ env.IMAGE_TAG }}
          outputs: type=docker,dest=/tmp/mtogo-agentbonus.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: image-mtogo-agentbonus
          path: /tmp/mtogo-agentbonus.tar
          retention-days: 1

      - name: Build & push Docker image (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.AgentBonusService/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/mtogo-agentbonus:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.OWNER_LC }}/mtogo-agentbonus:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  agentservice_ci:
    name: AgentService - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.agentservice == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.AgentService.csproj', '**/MToGo.AgentService.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.AgentService/MToGo.AgentService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.AgentService/MToGo.AgentService.csproj -c Release --no-restore

      - name: Test with coverage
        run: |
          dotnet test MToGo.AgentService.Tests.csproj -c Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            -p:CoverletExclude="[MToGo.AgentService]*.Models.*;[MToGo.AgentService]*.Entities.*;[MToGo.AgentService]*.Exceptions.*;[MToGo.AgentService]*.Metrics.*" \
            -p:CoverletThreshold=80 \
            -p:CoverletThresholdType=line \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
        working-directory: MToGo/tests/MToGo.AgentService.Tests

      - name: Restore dotnet tools
        run: dotnet tool restore
        working-directory: MToGo

      - name: Verify coverage file
        run: |
          echo "Looking for coverage files..."
          find MToGo/tests/MToGo.AgentService.Tests/TestResults -name "*.xml" 2>/dev/null || echo "No XML files found"
          ls -laR MToGo/tests/MToGo.AgentService.Tests/TestResults/ 2>/dev/null || echo "Directory not found"

      - name: Generate coverage report
        run: |
          dotnet tool run reportgenerator \
            "-reports:tests/MToGo.AgentService.Tests/TestResults/**/coverage.opencover.xml" \
            "-targetdir:tests/MToGo.AgentService.Tests/TestResults/CoverageReport" \
            -reporttypes:Html
        working-directory: MToGo

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-agentservice
          path: MToGo/tests/MToGo.AgentService.Tests/TestResults/CoverageReport
          retention-days: 7

      - name: Set lowercase owner
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image tar (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.AgentService/Dockerfile
          push: false
          tags: mtogo-agentservice:${{ env.IMAGE_TAG }}
          outputs: type=docker,dest=/tmp/mtogo-agentservice.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: image-mtogo-agentservice
          path: /tmp/mtogo-agentservice.tar
          retention-days: 1

      - name: Build & push Docker image (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.AgentService/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/mtogo-agentservice:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.OWNER_LC }}/mtogo-agentservice:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  customerservice_ci:
    name: CustomerService - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.customerservice == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.CustomerService.csproj', '**/MToGo.CustomerService.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.CustomerService/MToGo.CustomerService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.CustomerService/MToGo.CustomerService.csproj -c Release --no-restore

      - name: Test with coverage
        run: |
          dotnet test MToGo.CustomerService.Tests.csproj -c Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            -p:CoverletExclude="[MToGo.CustomerService]*.Models.*;[MToGo.CustomerService]*.Entities.*;[MToGo.CustomerService]*.Exceptions.*;[MToGo.CustomerService]*.Clients.*" \
            -p:CoverletThreshold=80 \
            -p:CoverletThresholdType=line \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
        working-directory: MToGo/tests/MToGo.CustomerService.Tests

      - name: Restore dotnet tools
        run: dotnet tool restore
        working-directory: MToGo

      - name: Verify coverage file
        run: |
          echo "Looking for coverage files..."
          find MToGo/tests/MToGo.CustomerService.Tests/TestResults -name "*.xml" 2>/dev/null || echo "No XML files found"
          ls -laR MToGo/tests/MToGo.CustomerService.Tests/TestResults/ 2>/dev/null || echo "Directory not found"

      - name: Generate coverage report
        run: |
          dotnet tool run reportgenerator \
            "-reports:tests/MToGo.CustomerService.Tests/TestResults/**/coverage.opencover.xml" \
            "-targetdir:tests/MToGo.CustomerService.Tests/TestResults/CoverageReport" \
            -reporttypes:Html
        working-directory: MToGo

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-customerservice
          path: MToGo/tests/MToGo.CustomerService.Tests/TestResults/CoverageReport
          retention-days: 7

      - name: Set lowercase owner
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image tar (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.CustomerService/Dockerfile
          push: false
          tags: mtogo-customerservice:${{ env.IMAGE_TAG }}
          outputs: type=docker,dest=/tmp/mtogo-customerservice.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: image-mtogo-customerservice
          path: /tmp/mtogo-customerservice.tar
          retention-days: 1

      - name: Build & push Docker image (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.CustomerService/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/mtogo-customerservice:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.OWNER_LC }}/mtogo-customerservice:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  feedbackhub_ci:
    name: FeedbackHub - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.feedbackhub == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.FeedbackHubService.csproj', '**/MToGo.FeedbackHubService.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.FeedbackHubService/MToGo.FeedbackHubService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.FeedbackHubService/MToGo.FeedbackHubService.csproj -c Release --no-restore

      - name: Test with coverage
        run: |
          dotnet test MToGo.FeedbackHubService.Tests.csproj -c Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            -p:CoverletExclude="[MToGo.FeedbackHubService]*.Models.*;[MToGo.FeedbackHubService]*.Entities.*;[MToGo.FeedbackHubService]*.Exceptions.*" \
            -p:CoverletThreshold=80 \
            -p:CoverletThresholdType=line \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
        working-directory: MToGo/tests/MToGo.FeedbackHubService.Tests

      - name: Restore dotnet tools
        run: dotnet tool restore
        working-directory: MToGo

      - name: Verify coverage file
        run: |
          echo "Looking for coverage files..."
          find MToGo/tests/MToGo.FeedbackHubService.Tests/TestResults -name "*.xml" 2>/dev/null || echo "No XML files found"
          ls -laR MToGo/tests/MToGo.FeedbackHubService.Tests/TestResults/ 2>/dev/null || echo "Directory not found"

      - name: Generate coverage report
        run: |
          dotnet tool run reportgenerator \
            "-reports:tests/MToGo.FeedbackHubService.Tests/TestResults/**/coverage.opencover.xml" \
            "-targetdir:tests/MToGo.FeedbackHubService.Tests/TestResults/CoverageReport" \
            -reporttypes:Html
        working-directory: MToGo

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-feedbackhub
          path: MToGo/tests/MToGo.FeedbackHubService.Tests/TestResults/CoverageReport
          retention-days: 7

      - name: Set lowercase owner
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image tar (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.FeedbackHubService/Dockerfile
          push: false
          tags: mtogo-feedbackhub:${{ env.IMAGE_TAG }}
          outputs: type=docker,dest=/tmp/mtogo-feedbackhub.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: image-mtogo-feedbackhub
          path: /tmp/mtogo-feedbackhub.tar
          retention-days: 1

      - name: Build & push Docker image (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.FeedbackHubService/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/mtogo-feedbackhub:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.OWNER_LC }}/mtogo-feedbackhub:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  gateway_ci:
    name: Gateway - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.gateway == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.Gateway.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.Gateway/MToGo.Gateway.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.Gateway/MToGo.Gateway.csproj -c Release --no-restore

      - name: Set lowercase owner
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image tar (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.Gateway/Dockerfile
          push: false
          tags: mtogo-gateway:${{ env.IMAGE_TAG }}
          outputs: type=docker,dest=/tmp/mtogo-gateway.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: image-mtogo-gateway
          path: /tmp/mtogo-gateway.tar
          retention-days: 1

      - name: Build & push Docker image (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.Gateway/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/mtogo-gateway:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.OWNER_LC }}/mtogo-gateway:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  notification_ci:
    name: Notification - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.notification == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.NotificationService.csproj', '**/MToGo.NotificationService.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.NotificationService/MToGo.NotificationService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.NotificationService/MToGo.NotificationService.csproj -c Release --no-restore

      - name: Test with coverage
        run: |
          dotnet test MToGo.NotificationService.Tests.csproj -c Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            -p:CoverletExclude="[MToGo.NotificationService]*.Models.*" \
            -p:CoverletThreshold=80 \
            -p:CoverletThresholdType=line \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
        working-directory: MToGo/tests/MToGo.NotificationService.Tests

      - name: Restore dotnet tools
        run: dotnet tool restore
        working-directory: MToGo

      - name: Verify coverage file
        run: |
          echo "Looking for coverage files..."
          find MToGo/tests/MToGo.NotificationService.Tests/TestResults -name "*.xml" 2>/dev/null || echo "No XML files found"
          ls -laR MToGo/tests/MToGo.NotificationService.Tests/TestResults/ 2>/dev/null || echo "Directory not found"

      - name: Generate coverage report
        run: |
          dotnet tool run reportgenerator \
            "-reports:tests/MToGo.NotificationService.Tests/TestResults/**/coverage.opencover.xml" \
            "-targetdir:tests/MToGo.NotificationService.Tests/TestResults/CoverageReport" \
            -reporttypes:Html
        working-directory: MToGo

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-notification
          path: MToGo/tests/MToGo.NotificationService.Tests/TestResults/CoverageReport
          retention-days: 7

      - name: Set lowercase owner
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image tar (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.NotificationService/Dockerfile
          push: false
          tags: mtogo-notification:${{ env.IMAGE_TAG }}
          outputs: type=docker,dest=/tmp/mtogo-notification.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: image-mtogo-notification
          path: /tmp/mtogo-notification.tar
          retention-days: 1

      - name: Build & push Docker image (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.NotificationService/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/mtogo-notification:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.OWNER_LC }}/mtogo-notification:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  order_ci:
    name: Order - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.order == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.OrderService.csproj', '**/MToGo.OrderService.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.OrderService/MToGo.OrderService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.OrderService/MToGo.OrderService.csproj -c Release --no-restore

      - name: Test with coverage
        run: |
          dotnet test MToGo.OrderService.Tests.csproj -c Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            -p:CoverletExclude="[MToGo.OrderService]*.Models.*;[MToGo.OrderService]*.Entities.*" \
            -p:CoverletThreshold=80 \
            -p:CoverletThresholdType=line \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
        working-directory: MToGo/tests/MToGo.OrderService.Tests

      - name: Restore dotnet tools
        run: dotnet tool restore
        working-directory: MToGo

      - name: Verify coverage file
        run: |
          echo "Looking for coverage files..."
          find MToGo/tests/MToGo.OrderService.Tests/TestResults -name "*.xml" 2>/dev/null || echo "No XML files found"
          ls -laR MToGo/tests/MToGo.OrderService.Tests/TestResults/ 2>/dev/null || echo "Directory not found"

      - name: Generate coverage report
        run: |
          dotnet tool run reportgenerator \
            "-reports:tests/MToGo.OrderService.Tests/TestResults/**/coverage.opencover.xml" \
            "-targetdir:tests/MToGo.OrderService.Tests/TestResults/CoverageReport" \
            -reporttypes:Html
        working-directory: MToGo

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-order
          path: MToGo/tests/MToGo.OrderService.Tests/TestResults/CoverageReport
          retention-days: 7

      - name: Set lowercase owner
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image tar (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.OrderService/Dockerfile
          push: false
          tags: mtogo-order:${{ env.IMAGE_TAG }}
          outputs: type=docker,dest=/tmp/mtogo-order.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: image-mtogo-order
          path: /tmp/mtogo-order.tar
          retention-days: 1

      - name: Build & push Docker image (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.OrderService/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/mtogo-order:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.OWNER_LC }}/mtogo-order:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  partner_ci:
    name: Partner - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.partner == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.PartnerService.csproj', '**/MToGo.PartnerService.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.PartnerService/MToGo.PartnerService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.PartnerService/MToGo.PartnerService.csproj -c Release --no-restore

      - name: Test with coverage
        run: |
          dotnet test MToGo.PartnerService.Tests.csproj -c Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            -p:CoverletExclude="[MToGo.PartnerService]*.Models.*;[MToGo.PartnerService]*.Entities.*" \
            -p:CoverletThreshold=80 \
            -p:CoverletThresholdType=line \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
        working-directory: MToGo/tests/MToGo.PartnerService.Tests

      - name: Restore dotnet tools
        run: dotnet tool restore
        working-directory: MToGo

      - name: Verify coverage file
        run: |
          echo "Looking for coverage files..."
          find MToGo/tests/MToGo.PartnerService.Tests/TestResults -name "*.xml" 2>/dev/null || echo "No XML files found"
          ls -laR MToGo/tests/MToGo.PartnerService.Tests/TestResults/ 2>/dev/null || echo "Directory not found"

      - name: Generate coverage report
        run: |
          dotnet tool run reportgenerator \
            "-reports:tests/MToGo.PartnerService.Tests/TestResults/**/coverage.opencover.xml" \
            "-targetdir:tests/MToGo.PartnerService.Tests/TestResults/CoverageReport" \
            -reporttypes:Html
        working-directory: MToGo

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-partner
          path: MToGo/tests/MToGo.PartnerService.Tests/TestResults/CoverageReport
          retention-days: 7

      - name: Set lowercase owner
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image tar (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.PartnerService/Dockerfile
          push: false
          tags: mtogo-partner:${{ env.IMAGE_TAG }}
          outputs: type=docker,dest=/tmp/mtogo-partner.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: image-mtogo-partner
          path: /tmp/mtogo-partner.tar
          retention-days: 1

      - name: Build & push Docker image (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.PartnerService/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/mtogo-partner:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.OWNER_LC }}/mtogo-partner:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  website_ci:
    name: Website - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.website == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.Website.csproj', '**/MToGo.Website.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.Website/MToGo.Website.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.Website/MToGo.Website.csproj -c Release --no-restore

      - name: Test with coverage
        run: |
          dotnet test MToGo.Website.Tests.csproj -c Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            -p:CoverletExclude="[MToGo.Website]*.Models.*" \
            -p:CoverletThreshold=80 \
            -p:CoverletThresholdType=line \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
        working-directory: MToGo/tests/MToGo.Website.Tests

      - name: Restore dotnet tools
        run: dotnet tool restore
        working-directory: MToGo

      - name: Verify coverage file
        run: |
          echo "Looking for coverage files..."
          find MToGo/tests/MToGo.Website.Tests/TestResults -name "*.xml" 2>/dev/null || echo "No XML files found"
          ls -laR MToGo/tests/MToGo.Website.Tests/TestResults/ 2>/dev/null || echo "Directory not found"

      - name: Generate coverage report
        run: |
          dotnet tool run reportgenerator \
            "-reports:tests/MToGo.Website.Tests/TestResults/**/coverage.opencover.xml" \
            "-targetdir:tests/MToGo.Website.Tests/TestResults/CoverageReport" \
            -reporttypes:Html
        working-directory: MToGo

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-website
          path: MToGo/tests/MToGo.Website.Tests/TestResults/CoverageReport
          retention-days: 7

      - name: Set lowercase owner
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image tar (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.Website/Dockerfile
          push: false
          tags: mtogo-website:${{ env.IMAGE_TAG }}
          outputs: type=docker,dest=/tmp/mtogo-website.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: image-mtogo-website
          path: /tmp/mtogo-website.tar
          retention-days: 1

      - name: Build & push Docker image (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.Website/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/mtogo-website:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.OWNER_LC }}/mtogo-website:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  websocketagent_ci:
    name: WebSocketAgent - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.websocketagent == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.WebSocketAgentService.csproj', '**/MToGo.WebSocketAgentService.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.WebSocketAgentService/MToGo.WebSocketAgentService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.WebSocketAgentService/MToGo.WebSocketAgentService.csproj -c Release --no-restore

      - name: Test with coverage
        run: |
          dotnet test MToGo.WebSocketAgentService.Tests.csproj -c Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            -p:CoverletExclude="[MToGo.WebSocketAgentService]*.Models.*" \
            -p:CoverletThreshold=80 \
            -p:CoverletThresholdType=line \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
        working-directory: MToGo/tests/MToGo.WebSocketAgentService.Tests

      - name: Restore dotnet tools
        run: dotnet tool restore
        working-directory: MToGo

      - name: Verify coverage file
        run: |
          echo "Looking for coverage files..."
          find MToGo/tests/MToGo.WebSocketAgentService.Tests/TestResults -name "*.xml" 2>/dev/null || echo "No XML files found"
          ls -laR MToGo/tests/MToGo.WebSocketAgentService.Tests/TestResults/ 2>/dev/null || echo "Directory not found"

      - name: Generate coverage report
        run: |
          dotnet tool run reportgenerator \
            "-reports:tests/MToGo.WebSocketAgentService.Tests/TestResults/**/coverage.opencover.xml" \
            "-targetdir:tests/MToGo.WebSocketAgentService.Tests/TestResults/CoverageReport" \
            -reporttypes:Html
        working-directory: MToGo

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-websocketagent
          path: MToGo/tests/MToGo.WebSocketAgentService.Tests/TestResults/CoverageReport
          retention-days: 7

      - name: Set lowercase owner
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image tar (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.WebSocketAgentService/Dockerfile
          push: false
          tags: mtogo-websocketagent:${{ env.IMAGE_TAG }}
          outputs: type=docker,dest=/tmp/mtogo-websocketagent.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: image-mtogo-websocketagent
          path: /tmp/mtogo-websocketagent.tar
          retention-days: 1

      - name: Build & push Docker image (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.WebSocketAgentService/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/mtogo-websocketagent:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.OWNER_LC }}/mtogo-websocketagent:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  websocketcustomer_ci:
    name: WebSocketCustomer - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.websocketcustomer == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.WebSocketCustomerService.csproj', '**/MToGo.WebSocketCustomerService.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.WebSocketCustomerService/MToGo.WebSocketCustomerService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.WebSocketCustomerService/MToGo.WebSocketCustomerService.csproj -c Release --no-restore

      - name: Test with coverage
        run: |
          dotnet test MToGo.WebSocketCustomerService.Tests.csproj -c Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            -p:CoverletExclude="[MToGo.WebSocketCustomerService]*.Models.*" \
            -p:CoverletThreshold=80 \
            -p:CoverletThresholdType=line \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
        working-directory: MToGo/tests/MToGo.WebSocketCustomerService.Tests

      - name: Restore dotnet tools
        run: dotnet tool restore
        working-directory: MToGo

      - name: Verify coverage file
        run: |
          echo "Looking for coverage files..."
          find MToGo/tests/MToGo.WebSocketCustomerService.Tests/TestResults -name "*.xml" 2>/dev/null || echo "No XML files found"
          ls -laR MToGo/tests/MToGo.WebSocketCustomerService.Tests/TestResults/ 2>/dev/null || echo "Directory not found"

      - name: Generate coverage report
        run: |
          dotnet tool run reportgenerator \
            "-reports:tests/MToGo.WebSocketCustomerService.Tests/TestResults/**/coverage.opencover.xml" \
            "-targetdir:tests/MToGo.WebSocketCustomerService.Tests/TestResults/CoverageReport" \
            -reporttypes:Html
        working-directory: MToGo

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-websocketcustomer
          path: MToGo/tests/MToGo.WebSocketCustomerService.Tests/TestResults/CoverageReport
          retention-days: 7

      - name: Set lowercase owner
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image tar (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.WebSocketCustomerService/Dockerfile
          push: false
          tags: mtogo-websocketcustomer:${{ env.IMAGE_TAG }}
          outputs: type=docker,dest=/tmp/mtogo-websocketcustomer.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: image-mtogo-websocketcustomer
          path: /tmp/mtogo-websocketcustomer.tar
          retention-days: 1

      - name: Build & push Docker image (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.WebSocketCustomerService/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/mtogo-websocketcustomer:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.OWNER_LC }}/mtogo-websocketcustomer:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  websocketpartner_ci:
    name: WebSocketPartner - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.websocketpartner == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.WebSocketPartnerService.csproj', '**/MToGo.WebSocketPartnerService.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.WebSocketPartnerService/MToGo.WebSocketPartnerService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.WebSocketPartnerService/MToGo.WebSocketPartnerService.csproj -c Release --no-restore

      - name: Test with coverage
        run: |
          dotnet test MToGo.WebSocketPartnerService.Tests.csproj -c Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            -p:CoverletExclude="[MToGo.WebSocketPartnerService]*.Models.*" \
            -p:CoverletThreshold=80 \
            -p:CoverletThresholdType=line \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
        working-directory: MToGo/tests/MToGo.WebSocketPartnerService.Tests

      - name: Restore dotnet tools
        run: dotnet tool restore
        working-directory: MToGo

      - name: Verify coverage file
        run: |
          echo "Looking for coverage files..."
          find MToGo/tests/MToGo.WebSocketPartnerService.Tests/TestResults -name "*.xml" 2>/dev/null || echo "No XML files found"
          ls -laR MToGo/tests/MToGo.WebSocketPartnerService.Tests/TestResults/ 2>/dev/null || echo "Directory not found"

      - name: Generate coverage report
        run: |
          dotnet tool run reportgenerator \
            "-reports:tests/MToGo.WebSocketPartnerService.Tests/TestResults/**/coverage.opencover.xml" \
            "-targetdir:tests/MToGo.WebSocketPartnerService.Tests/TestResults/CoverageReport" \
            -reporttypes:Html
        working-directory: MToGo

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-websocketpartner
          path: MToGo/tests/MToGo.WebSocketPartnerService.Tests/TestResults/CoverageReport
          retention-days: 7

      - name: Set lowercase owner
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image tar (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.WebSocketPartnerService/Dockerfile
          push: false
          tags: mtogo-websocketpartner:${{ env.IMAGE_TAG }}
          outputs: type=docker,dest=/tmp/mtogo-websocketpartner.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: image-mtogo-websocketpartner
          path: /tmp/mtogo-websocketpartner.tar
          retention-days: 1

      - name: Build & push Docker image (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.WebSocketPartnerService/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/mtogo-websocketpartner:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.OWNER_LC }}/mtogo-websocketpartner:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  management_ci:
    name: Management - build, test & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.management == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/MToGo.ManagementService.csproj', '**/MToGo.ManagementService.Tests.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore MToGo/src/MToGo.ManagementService/MToGo.ManagementService.csproj

      - name: Build
        run: dotnet build MToGo/src/MToGo.ManagementService/MToGo.ManagementService.csproj -c Release --no-restore

      - name: Test with coverage
        run: |
          dotnet test MToGo.ManagementService.Tests.csproj -c Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            -p:CoverletExclude="[MToGo.ManagementService]*.Models.*;[MToGo.ManagementService]*.Entities.*;[MToGo.ManagementService]*.Exceptions.*" \
            -p:CoverletThreshold=80 \
            -p:CoverletThresholdType=line \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
        working-directory: MToGo/tests/MToGo.ManagementService.Tests

      - name: Restore dotnet tools
        run: dotnet tool restore
        working-directory: MToGo

      - name: Verify coverage file
        run: |
          echo "Looking for coverage files..."
          find MToGo/tests/MToGo.ManagementService.Tests/TestResults -name "*.xml" 2>/dev/null || echo "No XML files found"
          ls -laR MToGo/tests/MToGo.ManagementService.Tests/TestResults/ 2>/dev/null || echo "Directory not found"

      - name: Generate coverage report
        run: |
          dotnet tool run reportgenerator \
            "-reports:tests/MToGo.ManagementService.Tests/TestResults/**/coverage.opencover.xml" \
            "-targetdir:tests/MToGo.ManagementService.Tests/TestResults/CoverageReport" \
            -reporttypes:Html
        working-directory: MToGo

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-management
          path: MToGo/tests/MToGo.ManagementService.Tests/TestResults/CoverageReport
          retention-days: 7

      - name: Set lowercase owner
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image tar (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.ManagementService/Dockerfile
          push: false
          tags: mtogo-management:${{ env.IMAGE_TAG }}
          outputs: type=docker,dest=/tmp/mtogo-management.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: image-mtogo-management
          path: /tmp/mtogo-management.tar
          retention-days: 1

      - name: Build & push Docker image (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/build-push-action@v5
        with:
          context: MToGo/
          file: MToGo/src/MToGo.ManagementService/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/mtogo-management:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.OWNER_LC }}/mtogo-management:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  legacy_ci:
    name: LegacyMToGo - build & docker
    needs: detect_changes
    if: ${{ needs.detect_changes.outputs.legacy == 'true' || needs.detect_changes.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/LegacyMToGo.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore LegacyMToGo/LegacyMToGo.csproj

      - name: Build
        run: dotnet build LegacyMToGo/LegacyMToGo.csproj -c Release --no-restore

      - name: Set lowercase owner
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image tar (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: docker/build-push-action@v5
        with:
          context: LegacyMToGo/
          file: LegacyMToGo/Dockerfile
          push: false
          tags: mtogo-legacy:${{ env.IMAGE_TAG }}
          outputs: type=docker,dest=/tmp/mtogo-legacy.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload Docker image artifact (PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: image-mtogo-legacy
          path: /tmp/mtogo-legacy.tar
          retention-days: 1

      - name: Build & push Docker image (main)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/build-push-action@v5
        with:
          context: LegacyMToGo/
          file: LegacyMToGo/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/mtogo-legacy:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.OWNER_LC }}/mtogo-legacy:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Save build outputs for security workflow
  save_build_outputs:
    name: Save build outputs
    needs:
      - detect_changes
      - agentbonus_ci
      - agentservice_ci
      - customerservice_ci
      - feedbackhub_ci
      - gateway_ci
      - notification_ci
      - order_ci
      - partner_ci
      - logcollector_ci
      - website_ci
      - websocketagent_ci
      - websocketcustomer_ci
      - websocketpartner_ci
      - management_ci
      - legacy_ci
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Create build outputs file
        run: |
          cat << EOF > build-outputs.json
          {
            "shared": "${{ needs.detect_changes.outputs.shared }}",
            "agentbonus": "${{ needs.detect_changes.outputs.agentbonus }}",
            "agentservice": "${{ needs.detect_changes.outputs.agentservice }}",
            "customerservice": "${{ needs.detect_changes.outputs.customerservice }}",
            "feedbackhub": "${{ needs.detect_changes.outputs.feedbackhub }}",
            "gateway": "${{ needs.detect_changes.outputs.gateway }}",
            "notification": "${{ needs.detect_changes.outputs.notification }}",
            "order": "${{ needs.detect_changes.outputs.order }}",
            "partner": "${{ needs.detect_changes.outputs.partner }}",
            "logcollector": "${{ needs.detect_changes.outputs.logcollector }}",
            "website": "${{ needs.detect_changes.outputs.website }}",
            "websocketagent": "${{ needs.detect_changes.outputs.websocketagent }}",
            "websocketcustomer": "${{ needs.detect_changes.outputs.websocketcustomer }}",
            "websocketpartner": "${{ needs.detect_changes.outputs.websocketpartner }}",
            "management": "${{ needs.detect_changes.outputs.management }}",
            "legacy": "${{ needs.detect_changes.outputs.legacy }}"
          }
          EOF
          cat build-outputs.json

      - name: Upload build outputs
        uses: actions/upload-artifact@v4
        with:
          name: build-outputs
          path: build-outputs.json
          retention-days: 1
