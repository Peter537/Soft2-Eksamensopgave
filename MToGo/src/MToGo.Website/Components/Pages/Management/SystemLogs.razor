@page "/management/system-logs"
@inject HttpClient Http
@inject AuthService Auth
@inject NavigationManager Navigation
@inject CultureService CultureService
@inject ILocalizerService L
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>@L["Pages.Management.SystemLogs.PageTitle"]</PageTitle>

<div class="container mt-4">
    @if (!isInitialized)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">@L["Pages.Management.SystemLogs.Loading"]</span>
            </div>
        </div>
    }
    else if (!Auth.IsManagement)
    {
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="alert alert-warning">
                    <h5 class="alert-heading">@L["Pages.Management.SystemLogs.AccessDeniedTitle"]</h5>
                    <p class="mb-0">@L["Pages.Management.SystemLogs.LoginRequired"] <a href="/management/login">@L["Pages.Management.SystemLogs.LoginLink"]</a></p>
                </div>
            </div>
        </div>
    }
    else
    {
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/management">@L["Pages.Management.SystemLogs.BreadcrumbDashboard"]</a></li>
                <li class="breadcrumb-item active">@L["Pages.Management.SystemLogs.BreadcrumbSystemLogs"]</li>
            </ol>
        </nav>

        <h2 class="mb-4"><i class="bi bi-terminal me-2"></i>@L["Pages.Management.SystemLogs.Title"]</h2>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
            </div>
        }

        <div class="row">
            <!-- File List -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-folder me-2"></i>@L["Pages.Management.SystemLogs.LogFiles"]</h5>
                        <button class="btn btn-sm btn-outline-primary" @onclick="LoadLogFiles" disabled="@isLoadingFiles" title="@L["Pages.Management.SystemLogs.Refresh"]">
                            <i class="bi bi-arrow-clockwise @(isLoadingFiles ? "spin" : "") me-1"></i>@L["Pages.Management.SystemLogs.Refresh"]
                        </button>
                    </div>
                    <div class="list-group list-group-flush" style="max-height: 600px; overflow-y: auto;">
                        @if (isLoadingFiles)
                        {
                            <div class="list-group-item text-center">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                            </div>
                        }
                        else if (logFiles.Count == 0)
                        {
                            <div class="list-group-item text-muted">
                                <i class="bi bi-info-circle me-2"></i>@L["Pages.Management.SystemLogs.NoFilesFound"]
                            </div>
                        }
                        else
                        {
                            @foreach (var file in logFiles)
                            {
                                <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center @(selectedFile == file.Date ? "active" : "")"
                                        @onclick="() => LoadFileContent(file.Date)">
                                    <div>
                                        <i class="bi bi-file-text me-2"></i>
                                        <span>system-@(file.Date).log</span>
                                    </div>
                                    <span class="badge bg-secondary rounded-pill">@FormatFileSize(file.Size)</span>
                                </button>
                            }
                        }
                    </div>
                </div>
            </div>

            <!-- File Content -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-file-text me-2"></i>
                            @if (!string.IsNullOrEmpty(selectedFile))
                            {
                                <span>system-@(selectedFile).log</span>
                            }
                            else
                            {
                                <span>@L["Pages.Management.SystemLogs.SelectFile"]</span>
                            }
                        </h5>
                        @if (!string.IsNullOrEmpty(selectedFile))
                        {
                            <div>
                                <button class="btn btn-sm btn-outline-secondary me-2" @onclick="ToggleWrap" title="@L["Pages.Management.SystemLogs.ToggleWrap"]">
                                    <i class="bi @(wrapText ? "bi-text-wrap" : "bi-text-left") me-1"></i>@L["Pages.Management.SystemLogs.ToggleWrap"]
                                </button>
                                <button class="btn btn-sm btn-outline-primary" @onclick="DownloadFile" title="@L["Pages.Management.SystemLogs.Download"]">
                                    <i class="bi bi-download me-1"></i>@L["Pages.Management.SystemLogs.Download"]
                                </button>
                            </div>
                        }
                    </div>
                    <div class="card-body p-0">
                        @if (isLoadingContent)
                        {
                            <div class="text-center p-4">
                                <div class="spinner-border" role="status"></div>
                                <p class="mt-2 text-muted">@L["Pages.Management.SystemLogs.LoadingContent"]</p>
                            </div>
                        }
                        else if (string.IsNullOrEmpty(selectedFile))
                        {
                            <div class="text-center p-5 text-muted">
                                <i class="bi bi-arrow-left-circle display-4"></i>
                                <p class="mt-3">@L["Pages.Management.SystemLogs.SelectFileHint"]</p>
                            </div>
                        }
                        else if (string.IsNullOrEmpty(fileContent))
                        {
                            <div class="text-center p-4 text-muted">
                                <i class="bi bi-file-earmark display-4"></i>
                                <p class="mt-3">@L["Pages.Management.SystemLogs.EmptyFile"]</p>
                            </div>
                        }
                        else
                        {
                            <div class="position-relative">
                                <!-- Search bar -->
                                <div class="p-2 border-bottom bg-light">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                                        <input type="text" class="form-control" @bind="contentSearch" @bind:event="oninput"
                                               placeholder="@L["Pages.Management.SystemLogs.SearchPlaceholder"]" />
                                        @if (!string.IsNullOrEmpty(contentSearch))
                                        {
                                            <button class="btn btn-outline-secondary" @onclick="ClearSearch" title="@L["Pages.Management.SystemLogs.ClearSearch"]">
                                                <i class="bi bi-x me-1"></i>@L["Pages.Management.SystemLogs.ClearSearch"]
                                            </button>
                                        }
                                    </div>
                                </div>
                                <!-- Log content -->
                                <pre class="m-0 p-3 bg-dark text-light log-viewer @(wrapText ? "wrap-text" : "")" 
                                     style="max-height: 500px; overflow: auto; font-size: 0.8rem;">@GetFilteredContent()</pre>
                            </div>
                        }
                    </div>
                    @if (!string.IsNullOrEmpty(fileContent))
                    {
                        <div class="card-footer small text-muted">
                            @L.GetString("Pages.Management.SystemLogs.LineCount", fileContent.Split('\n').Length)
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

<style>
    .log-viewer {
        white-space: pre;
    }
    .log-viewer.wrap-text {
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    .spin {
        animation: spin 1s linear infinite;
    }
    @@keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>

@code {
    private bool isInitialized;
    private bool isLoadingFiles;
    private bool isLoadingContent;
    private string? errorMessage;

    private List<LogFileInfo> logFiles = new();
    private string? selectedFile;
    private string? fileContent;
    private string contentSearch = "";
    private bool wrapText = true;

    protected override void OnInitialized()
    {
        CultureService.OnChange += OnCultureChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Auth.InitializeAsync();
            isInitialized = true;
            StateHasChanged();

            if (Auth.IsManagement)
            {
                await LoadLogFiles();
            }
        }
    }

    private async Task LoadLogFiles()
    {
        isLoadingFiles = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            var response = await Http.GetAsync("/api/v1/logs/system/files");
            if (response.IsSuccessStatusCode)
            {
                logFiles = await response.Content.ReadFromJsonAsync<List<LogFileInfo>>() ?? new();
                logFiles = logFiles.OrderByDescending(f => f.Date).ToList();
            }
            else
            {
                errorMessage = $"Failed to load log files: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading log files: {ex.Message}";
        }
        finally
        {
            isLoadingFiles = false;
            StateHasChanged();
        }
    }

    private async Task LoadFileContent(string date)
    {
        selectedFile = date;
        isLoadingContent = true;
        fileContent = null;
        contentSearch = "";
        StateHasChanged();

        try
        {
            var response = await Http.GetAsync($"/api/v1/logs/system/files/{date}");
            if (response.IsSuccessStatusCode)
            {
                fileContent = await response.Content.ReadAsStringAsync();
            }
            else
            {
                errorMessage = $"Failed to load file content: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading file content: {ex.Message}";
        }
        finally
        {
            isLoadingContent = false;
            StateHasChanged();
        }
    }

    private string GetFilteredContent()
    {
        if (string.IsNullOrEmpty(fileContent) || string.IsNullOrEmpty(contentSearch))
            return fileContent ?? "";

        var lines = fileContent.Split('\n');
        var filteredLines = lines.Where(line => 
            line.Contains(contentSearch, StringComparison.OrdinalIgnoreCase));
        
        return string.Join('\n', filteredLines);
    }

    private void ClearSearch()
    {
        contentSearch = "";
    }

    private void ToggleWrap()
    {
        wrapText = !wrapText;
    }

    private async Task DownloadFile()
    {
        if (string.IsNullOrEmpty(selectedFile) || string.IsNullOrEmpty(fileContent))
            return;

        // In a real implementation, you would use JS interop to download the file
        // For now, we'll just trigger a navigation to the download endpoint
        var url = $"/api/v1/logs/system/files/{selectedFile}";
        Navigation.NavigateTo(url, forceLoad: true);
    }

    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }

    private void OnCultureChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        CultureService.OnChange -= OnCultureChanged;
    }

    private class LogFileInfo
    {
        public string Date { get; set; } = "";
        public string FileName { get; set; } = "";
        public long Size { get; set; }
        public DateTime LastModified { get; set; }
    }
}
