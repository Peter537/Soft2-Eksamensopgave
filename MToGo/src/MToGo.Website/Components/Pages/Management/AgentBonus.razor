@page "/management/agent-bonus"
@inject HttpClient Http
@inject CultureService CultureService
@inject AuthService Auth
@inject NavigationManager Navigation
@inject ILocalizerService L
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>@L["Pages.Management.AgentBonus.PageTitle"]</PageTitle>

<div class="container mt-4">
    @if (!isInitialized)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">@L["Pages.Management.AgentBonus.Loading"]</span>
            </div>
        </div>
    }
    else if (!Auth.IsManagement)
    {
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="alert alert-warning">
                    <h5 class="alert-heading">@L["Pages.Management.AgentBonus.AccessDeniedTitle"]</h5>
                    <p class="mb-0">@L["Pages.Management.AgentBonus.AccessDeniedMessage"] <a href="/management/login">@L["Pages.Management.AgentBonus.LoginLink"]</a></p>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-trophy text-warning"></i> @L["Pages.Management.AgentBonus.Title"]</h2>
                    <a href="/management" class="btn btn-outline-dark">
                        <i class="bi bi-arrow-left"></i> @L["Pages.Management.AgentBonus.BackToDashboard"]
                    </a>
                </div>
            </div>
        </div>

        <!-- Search Form Card -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-search"></i> @L["Pages.Management.AgentBonus.CalculateBonus"]</h5>
            </div>
            <div class="card-body">
                <EditForm Model="@searchModel" OnValidSubmit="CalculateBonus">
                    <DataAnnotationsValidator />
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">@L["Pages.Management.AgentBonus.AgentId"]</label>
                            <InputNumber @bind-Value="searchModel.AgentId" class="form-control" placeholder="@L["Pages.Management.AgentBonus.AgentIdPlaceholder"]" />
                            <ValidationMessage For="@(() => searchModel.AgentId)" class="text-danger" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">@L["Pages.Management.AgentBonus.StartDate"]</label>
                            <InputDate @bind-Value="searchModel.StartDate" class="form-control" />
                            <ValidationMessage For="@(() => searchModel.StartDate)" class="text-danger" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">@L["Pages.Management.AgentBonus.EndDate"]</label>
                            <InputDate @bind-Value="searchModel.EndDate" class="form-control" />
                            <ValidationMessage For="@(() => searchModel.EndDate)" class="text-danger" />
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100" disabled="@isCalculating">
                                @if (isCalculating)
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                    <span>@L["Pages.Management.AgentBonus.Calculating"]</span>
                                }
                                else
                                {
                                    <i class="bi bi-calculator"></i>
                                    <span> @L["Pages.Management.AgentBonus.Calculate"]</span>
                                }
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quick Date Range Buttons -->
                    <div class="mt-3">
                        <small class="text-muted me-2">@L["Pages.Management.AgentBonus.QuickSelect"]</small>
                        <button type="button" class="btn btn-outline-secondary btn-sm me-1" @onclick="() => SetDateRange(DateRangeType.ThisMonth)">@L["Pages.Management.AgentBonus.ThisMonth"]</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm me-1" @onclick="() => SetDateRange(DateRangeType.LastMonth)">@L["Pages.Management.AgentBonus.LastMonth"]</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm me-1" @onclick="() => SetDateRange(DateRangeType.Last3Months)">@L["Pages.Management.AgentBonus.Last3Months"]</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="() => SetDateRange(DateRangeType.ThisYear)">@L["Pages.Management.AgentBonus.ThisYear"]</button>
                    </div>
                </EditForm>
            </div>
        </div>

        <!-- Error Message -->
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i> @errorMessage
                <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
            </div>
        }

        <!-- Results Section -->
        @if (bonusResult != null)
        {
            <!-- Agent Header -->
            <div class="card mb-4 shadow-sm border-0 bg-gradient" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
                <div class="card-body text-white">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h3 class="mb-1">
                                <i class="bi bi-person-badge"></i> @bonusResult.AgentName
                            </h3>
                            <p class="mb-0 opacity-75">
                                @L["Pages.Management.AgentBonus.AgentId"]: @bonusResult.AgentId | 
                                @L["Pages.Management.AgentBonus.Period"] @bonusResult.Period.StartDate.ToString("MMM dd, yyyy") - @bonusResult.Period.EndDate.ToString("MMM dd, yyyy")
                            </p>
                        </div>
                        <div class="col-md-4 text-md-end">
                            @if (bonusResult.Qualified)
                            {
                                <span class="badge bg-success fs-5"><i class="bi bi-check-circle"></i> @L["Pages.Management.AgentBonus.Qualified"]</span>
                            }
                            else
                            {
                                <span class="badge bg-warning text-dark fs-5"><i class="bi bi-exclamation-circle"></i> @L["Pages.Management.AgentBonus.NotQualified"]</span>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Warnings -->
            @if (bonusResult.Warnings != null && bonusResult.Warnings.Any())
            {
                <div class="alert alert-warning mb-4">
                    <h6><i class="bi bi-exclamation-triangle"></i> @L["Pages.Management.AgentBonus.Warnings"]</h6>
                    <ul class="mb-0">
                        @foreach (var warning in bonusResult.Warnings)
                        {
                            <li>@warning</li>
                        }
                    </ul>
                </div>
            }

            <!-- Disqualification Reason -->
            @if (!bonusResult.Qualified && !string.IsNullOrEmpty(bonusResult.DisqualificationReason))
            {
                <div class="alert alert-danger mb-4">
                    <h6><i class="bi bi-x-circle"></i> @L["Pages.Management.AgentBonus.NotQualified"]</h6>
                    <p class="mb-0">@bonusResult.DisqualificationReason</p>
                </div>
            }

            <!-- Main Stats Cards -->
            <div class="row g-4 mb-4">
                <!-- Bonus Amount Card -->
                <div class="col-md-4">
                    <div class="card h-100 shadow-sm border-0" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                        <div class="card-body text-white text-center">
                            <h6 class="card-subtitle mb-2 opacity-75">
                                <i class="bi bi-cash-stack"></i> @L["Pages.Management.AgentBonus.TotalBonus"]
                            </h6>
                            <h2 class="display-4 fw-bold mb-0">@bonusResult.BonusAmount.ToString("C")</h2>
                            <small class="opacity-75">@L["Pages.Management.AgentBonus.EarnedThisPeriod"]</small>
                        </div>
                    </div>
                </div>

                <!-- Deliveries Card -->
                <div class="col-md-4">
                    <div class="card h-100 shadow-sm border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="card-body text-white text-center">
                            <h6 class="card-subtitle mb-2 opacity-75">
                                <i class="bi bi-box-seam"></i> @L["Pages.Management.AgentBonus.Deliveries"]
                            </h6>
                            <h2 class="display-4 fw-bold mb-0">@bonusResult.DeliveryCount</h2>
                            <small class="opacity-75">@(bonusResult.Qualified ? L["Pages.Management.AgentBonus.RequiredDeliveries"] : string.Format(L["Pages.Management.AgentBonus.NeedMoreDeliveries"], 20 - bonusResult.DeliveryCount))</small>
                        </div>
                    </div>
                </div>

                <!-- Performance Card -->
                <div class="col-md-4">
                    <div class="card h-100 shadow-sm border-0" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="card-body text-white text-center">
                            <h6 class="card-subtitle mb-2 opacity-75">
                                <i class="bi bi-speedometer2"></i> @L["Pages.Management.AgentBonus.Performance"]
                            </h6>
                            <h2 class="display-4 fw-bold mb-0">@((bonusResult.Performance * 100).ToString("F0"))%</h2>
                            <small class="opacity-75">@L["Pages.Management.AgentBonus.PerformanceMultiplier"]</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Breakdown Cards Row -->
            <div class="row g-4 mb-4">
                <!-- Time Score Breakdown -->
                <div class="col-md-6">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-clock-history text-primary"></i> @L["Pages.Management.AgentBonus.TimeScoreBreakdown"]</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span>@L["Pages.Management.AgentBonus.TimeScore"]</span>
                                    <span class="fw-bold">@((bonusResult.TimeScore * 100).ToString("F1"))%</span>
                                </div>
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar bg-primary" role="progressbar" style="width: @((bonusResult.TimeScore * 100).ToString("F0"))%"></div>
                                </div>
                            </div>
                            
                            <hr />
                            
                            <div class="row text-center g-2">
                                <div class="col-4">
                                    <div class="p-2 rounded" style="background-color: #d1e7dd;">
                                        <i class="bi bi-sunrise text-success fs-4"></i>
                                        <h5 class="mb-0 text-success">@bonusResult.EarlyDeliveries</h5>
                                        <small class="text-muted">@L["Pages.Management.AgentBonus.Early"]</small>
                                        <br /><small class="badge bg-success">@L["Pages.Management.AgentBonus.EarlyBonus"]</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="p-2 rounded" style="background-color: #fff3cd;">
                                        <i class="bi bi-sun text-warning fs-4"></i>
                                        <h5 class="mb-0 text-warning">@bonusResult.NormalDeliveries</h5>
                                        <small class="text-muted">@L["Pages.Management.AgentBonus.Normal"]</small>
                                        <br /><small class="badge bg-warning text-dark">@L["Pages.Management.AgentBonus.NormalBase"]</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="p-2 rounded" style="background-color: #cfe2ff;">
                                        <i class="bi bi-moon-stars text-primary fs-4"></i>
                                        <h5 class="mb-0 text-primary">@bonusResult.LateDeliveries</h5>
                                        <small class="text-muted">@L["Pages.Management.AgentBonus.Late"]</small>
                                        <br /><small class="badge bg-primary">@L["Pages.Management.AgentBonus.LateBonus"]</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Review Score Breakdown -->
                <div class="col-md-6">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-star-fill text-warning"></i> @L["Pages.Management.AgentBonus.ReviewScoreTitle"]</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span>@L["Pages.Management.AgentBonus.ReviewScore"]</span>
                                    <span class="fw-bold">@((bonusResult.ReviewScore * 100).ToString("F1"))%</span>
                                </div>
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: @((bonusResult.ReviewScore * 100).ToString("F0"))%"></div>
                                </div>
                            </div>
                            
                            <hr />
                            
                            <div class="text-center">
                                @if (!bonusResult.UsedDefaultRating)
                                {
                                    <div class="d-flex justify-content-center align-items-center gap-1 mb-2">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            @if (i <= Math.Round(bonusResult.AverageRating))
                                            {
                                                <i class="bi bi-star-fill text-warning fs-3"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-star text-warning fs-3"></i>
                                            }
                                        }
                                    </div>
                                    <h4 class="mb-1">@bonusResult.AverageRating.ToString("F1") / 5.0</h4>
                                    <small class="text-muted">@string.Format(L["Pages.Management.AgentBonus.BasedOnReviews"], bonusResult.ReviewCount)</small>
                                }
                                else
                                {
                                    <div class="alert alert-info mb-0">
                                        <i class="bi bi-info-circle"></i> @L["Pages.Management.AgentBonus.UsingDefaultRating"]
                                        <br /><small>@string.Format(L["Pages.Management.AgentBonus.DefaultScoreApplied"], bonusResult.ReviewCount)</small>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calculation Breakdown -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-calculator"></i> @L["Pages.Management.AgentBonus.CalculationBreakdown"]</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-borderless mb-0">
                            <tbody>
                                <tr>
                                    <td class="w-50"><strong>@L["Pages.Management.AgentBonus.ContributionBase"]</strong> <small class="text-muted">@L["Pages.Management.AgentBonus.ContributionBaseDesc"]</small></td>
                                    <td class="text-end">@bonusResult.Contribution.ToString("C")</td>
                                </tr>
                                <tr>
                                    <td><strong>@L["Pages.Management.AgentBonus.TimeScore"]</strong> <small class="text-muted">@L["Pages.Management.AgentBonus.TimeScoreDesc"]</small></td>
                                    <td class="text-end">@((bonusResult.TimeScore * 100).ToString("F1"))%</td>
                                </tr>
                                <tr>
                                    <td><strong>@L["Pages.Management.AgentBonus.ReviewScore"]</strong> <small class="text-muted">@L["Pages.Management.AgentBonus.ReviewScoreDesc"]</small></td>
                                    <td class="text-end">@((bonusResult.ReviewScore * 100).ToString("F1"))%</td>
                                </tr>
                                <tr class="table-secondary">
                                    <td><strong>@L["Pages.Management.AgentBonus.Performance"]</strong> <small class="text-muted">@L["Pages.Management.AgentBonus.PerformanceDesc"]</small></td>
                                    <td class="text-end fw-bold">@((bonusResult.Performance * 100).ToString("F1"))%</td>
                                </tr>
                                <tr class="table-success">
                                    <td><strong>@L["Pages.Management.AgentBonus.FinalBonus"]</strong> <small class="text-muted">@L["Pages.Management.AgentBonus.FinalBonusDesc"]</small></td>
                                    <td class="text-end fw-bold fs-5 text-success">@bonusResult.BonusAmount.ToString("C")</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    @if (!bonusResult.Qualified)
                    {
                        <div class="alert alert-warning mt-3 mb-0">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>@L["Pages.Management.AgentBonus.NotQualified"]:</strong> @string.Format(L["Pages.Management.AgentBonus.NotQualifiedWarning"], bonusResult.DeliveryCount)
                        </div>
                    }
                </div>
            </div>
        }
    }
</div>

@code {
    private bool isInitialized;
    private bool isCalculating;
    private string? errorMessage;
    private SearchModel searchModel = new();
    private BonusCalculationResult? bonusResult;

    protected override void OnInitialized()
    {
        CultureService.OnChange += OnCultureChanged;
        
        // Default to current month (full month)
        SetDateRange(DateRangeType.ThisMonth);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Auth.InitializeAsync();
            isInitialized = true;
            StateHasChanged();
        }
    }

    private void OnCultureChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task CalculateBonus()
    {
        if (searchModel.AgentId <= 0)
        {
            errorMessage = L["Pages.Management.AgentBonus.EnterValidAgentId"];
            return;
        }

        if (searchModel.EndDate < searchModel.StartDate)
        {
            errorMessage = L["Pages.Management.AgentBonus.EndDateAfterStart"];
            return;
        }

        isCalculating = true;
        errorMessage = null;
        bonusResult = null;
        StateHasChanged();

        try
        {
            var startDateStr = searchModel.StartDate.ToString("yyyy-MM-dd");
            var endDateStr = searchModel.EndDate.ToString("yyyy-MM-dd");
            var url = $"/api/v1/agent-bonus/{searchModel.AgentId}?startDate={startDateStr}&endDate={endDateStr}";
            
            Console.WriteLine($"[AgentBonus] Calling API: {url}");
            Console.WriteLine($"[AgentBonus] Auth Token present: {!string.IsNullOrEmpty(Auth.Token)}");
            
            // Create request with auth header
            var request = new HttpRequestMessage(HttpMethod.Get, url);
            if (!string.IsNullOrEmpty(Auth.Token))
            {
                request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", Auth.Token);
            }
            else
            {
                Console.WriteLine("[AgentBonus] WARNING: No auth token available!");
            }
            
            var response = await Http.SendAsync(request);
            
            Console.WriteLine($"[AgentBonus] Response status: {response.StatusCode}");
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"[AgentBonus] Response content: {content}");
                bonusResult = System.Text.Json.JsonSerializer.Deserialize<BonusCalculationResult>(content, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                Console.WriteLine($"[AgentBonus] Parsed result - DeliveryCount: {bonusResult?.DeliveryCount}, Qualified: {bonusResult?.Qualified}");
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                errorMessage = string.Format(L["Pages.Management.AgentBonus.AgentNotFound"], searchModel.AgentId);
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"[AgentBonus] Error response: {error}");
                errorMessage = string.Format(L["Pages.Management.AgentBonus.FailedToCalculate"], response.StatusCode, error);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[AgentBonus] Exception: {ex}");
            errorMessage = string.Format(L["Pages.Management.AgentBonus.Error"], ex.Message);
        }
        finally
        {
            isCalculating = false;
        }
    }

    private void SetDateRange(DateRangeType rangeType)
    {
        var today = DateTime.Today;
        
        switch (rangeType)
        {
            case DateRangeType.ThisMonth:
                // Full current month (1st to last day, handles Feb/leap years automatically)
                searchModel.StartDate = new DateTime(today.Year, today.Month, 1);
                searchModel.EndDate = new DateTime(today.Year, today.Month, DateTime.DaysInMonth(today.Year, today.Month));
                break;
            case DateRangeType.LastMonth:
                var lastMonth = today.AddMonths(-1);
                searchModel.StartDate = new DateTime(lastMonth.Year, lastMonth.Month, 1);
                searchModel.EndDate = new DateTime(lastMonth.Year, lastMonth.Month, DateTime.DaysInMonth(lastMonth.Year, lastMonth.Month));
                break;
            case DateRangeType.Last3Months:
                searchModel.StartDate = today.AddMonths(-3);
                searchModel.EndDate = new DateTime(today.Year, today.Month, DateTime.DaysInMonth(today.Year, today.Month));
                break;
            case DateRangeType.ThisYear:
                searchModel.StartDate = new DateTime(today.Year, 1, 1);
                searchModel.EndDate = new DateTime(today.Year, today.Month, DateTime.DaysInMonth(today.Year, today.Month));
                break;
        }
    }

    public void Dispose()
    {
        CultureService.OnChange -= OnCultureChanged;
    }

    private enum DateRangeType
    {
        ThisMonth,
        LastMonth,
        Last3Months,
        ThisYear
    }

    private class SearchModel
    {
        public int AgentId { get; set; }
        // Default to current full month
        public DateTime StartDate { get; set; } = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
        public DateTime EndDate { get; set; } = new DateTime(DateTime.Today.Year, DateTime.Today.Month, DateTime.DaysInMonth(DateTime.Today.Year, DateTime.Today.Month));
    }

    // Response model matching the actual API response from AgentBonusService
    private class BonusCalculationResult
    {
        public int AgentId { get; set; }
        public string AgentName { get; set; } = string.Empty;
        public PeriodInfo Period { get; set; } = new();
        public bool Qualified { get; set; }
        public string? DisqualificationReason { get; set; }
        
        // Delivery stats (flat, not nested)
        public int DeliveryCount { get; set; }
        public int EarlyDeliveries { get; set; }
        public int NormalDeliveries { get; set; }
        public int LateDeliveries { get; set; }
        
        // Financial
        public decimal TotalDeliveryFees { get; set; }
        public decimal Contribution { get; set; }
        
        // Scores (decimal in backend)
        public decimal TimeScore { get; set; }
        public decimal ReviewScore { get; set; }
        public decimal Performance { get; set; }
        
        // Review stats (flat, not nested)
        public int ReviewCount { get; set; }
        public decimal AverageRating { get; set; }
        public bool UsedDefaultRating { get; set; }
        
        // Final result
        public decimal BonusAmount { get; set; }
        
        // Warnings
        public List<string> Warnings { get; set; } = new();
    }

    private class PeriodInfo
    {
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
    }
}
