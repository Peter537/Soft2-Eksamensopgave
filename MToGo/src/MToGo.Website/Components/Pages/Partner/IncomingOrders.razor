@page "/partner/incoming-orders"
@rendermode InteractiveServer
@inject IConfiguration Configuration
@inject IJSRuntime JS
@inject HttpClient Http
@inject AuthService Auth
@inject NavigationManager Navigation
@inject CultureService CultureService
@inject ILocalizerService L
@implements IAsyncDisposable

<PageTitle>@L["Pages.Partner.IncomingOrders.PageTitle"]</PageTitle>

<div class="container mt-4">
    @if (!isInitialized)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">@L["Pages.Partner.IncomingOrders.Loading"]</span>
            </div>
        </div>
    }
    else if (!Auth.IsPartner || !Auth.Id.HasValue)
    {
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="alert alert-warning">
                    <h5 class="alert-heading">@L["Pages.Partner.IncomingOrders.AccessDeniedTitle"]</h5>
                    <p class="mb-0">@L["Pages.Partner.IncomingOrders.LoginRequired"] <a href="/partner/login">@L["Pages.Partner.IncomingOrders.LoginLink"]</a></p>
                </div>
            </div>
        </div>
    }
    else
    {
        <h3>@L["Pages.Partner.IncomingOrders.Title"]</h3>

        <div class="row">
    @* Left Column: New Orders *@
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <span class="oi oi-bell me-2"></span>
                    @L["Pages.Partner.IncomingOrders.NewOrders"] (@NewOrders.Count)
                </h5>
            </div>
            <div class="card-body" style="min-height: 400px; max-height: 600px; overflow-y: auto;">
                @if (NewOrders.Count == 0)
                {
                    <p class="text-muted text-center mt-4">
                        <span class="oi oi-inbox" style="font-size: 2rem;"></span><br />
                        @L["Pages.Partner.IncomingOrders.WaitingForOrders"]
                    </p>
                }
                else
                {
                    @foreach (var order in NewOrders.OrderByDescending(o => o.ReceivedAt))
                    {
                        <div class="card mb-3 border-warning">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <h6 class="card-title">@string.Format(L["Pages.Partner.IncomingOrders.OrderNumber"], order.OrderId)</h6>
                                    <small class="text-muted">@order.ReceivedAt.ToString("HH:mm:ss")</small>
                                </div>
                                @if (!string.IsNullOrEmpty(order.Distance))
                                {
                                    <p class="text-info mb-1"><small>@string.Format(L["Pages.Partner.IncomingOrders.Distance"], order.Distance)</small></p>
                                }
                                <ul class="list-unstyled mb-2">
                                    @foreach (var item in order.Items)
                                    {
                                        <li>@item.Quantity x @item.Name</li>
                                    }
                                </ul>
                                <div class="mb-2">
                                    <label class="form-label small mb-1">@L["Pages.Partner.IncomingOrders.EstimatedPrepTime"]</label>
                                    <input type="number" 
                                           class="form-control form-control-sm" 
                                           min="1" 
                                           max="120"
                                           placeholder="@L["Pages.Partner.IncomingOrders.EstimatedPrepPlaceholder"]"
                                           @bind="order.EstimatedMinutes" />
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-success btn-sm" 
                                            disabled="@(!order.EstimatedMinutes.HasValue || order.EstimatedMinutes < 1)"
                                            @onclick="() => AcceptOrder(order)">
                                        @L["Pages.Partner.IncomingOrders.Accept"]
                                    </button>
                                    <button class="btn btn-danger btn-sm" @onclick="() => RejectOrder(order)">
                                        @L["Pages.Partner.IncomingOrders.Reject"]
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>

    @* Right Column: Accepted Orders *@
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <span class="oi oi-check me-2"></span>
                    @L["Pages.Partner.IncomingOrders.AcceptedOrders"] (@AcceptedOrders.Count)
                </h5>
            </div>
            <div class="card-body" style="min-height: 400px; max-height: 600px; overflow-y: auto;">
                @if (AcceptedOrders.Count == 0)
                {
                    <p class="text-muted text-center mt-4">
                        <span class="oi oi-list" style="font-size: 2rem;"></span><br />
                        @L["Pages.Partner.IncomingOrders.NoAcceptedOrders"]
                    </p>
                }
                else
                {
                    @foreach (var order in AcceptedOrders.OrderByDescending(o => o.AcceptedAt))
                    {
                        <div class="card mb-3 border-success">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <h6 class="card-title">@string.Format(L["Pages.Partner.IncomingOrders.OrderNumber"], order.OrderId)</h6>
                                    <span class="badge @(order.AgentId.HasValue ? "bg-info" : "bg-secondary")">
                                        @(order.AgentId.HasValue ? string.Format(L["Pages.Partner.IncomingOrders.AgentAssigned"], order.AgentId) : L["Pages.Partner.IncomingOrders.AwaitingAgent"])
                                    </span>
                                </div>
                                <ul class="list-unstyled mb-2">
                                    @foreach (var item in order.Items)
                                    {
                                        <li>@item.Quantity x @item.Name</li>
                                    }
                                </ul>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">@string.Format(L["Pages.Partner.IncomingOrders.AcceptedAt"], order.AcceptedAt?.ToString("HH:mm:ss"))</small>
                                    @if (!order.IsReady)
                                    {
                                        <button class="btn btn-primary btn-sm" @onclick="() => MarkFoodReady(order)">
                                            @L["Pages.Partner.IncomingOrders.FoodReady"]
                                        </button>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">@L["Pages.Partner.IncomingOrders.ReadyForPickup"]</span>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

@* Connection Status *@
<div class="mt-3">
    <span class="badge @(IsConnected ? "bg-success" : "bg-danger")">
        @(IsConnected ? L["Pages.Partner.IncomingOrders.Connected"] : L["Pages.Partner.IncomingOrders.Disconnected"])
    </span>
    @if (!string.IsNullOrEmpty(StatusMessage))
    {
        <span class="ms-2 text-muted">@StatusMessage</span>
    }
</div>
    }
</div>

@code {
    private List<IncomingOrder> NewOrders { get; set; } = new();
    private List<AcceptedOrder> AcceptedOrders { get; set; } = new();
    private bool IsConnected { get; set; }
    private string StatusMessage { get; set; } = "Loading...";
    private bool isInitialized;

    private DotNetObjectReference<IncomingOrders>? _dotNetRef;

    protected override void OnInitialized()
    {
        CultureService.OnChange += OnCultureChanged;
    }

    private void OnCultureChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Auth.InitializeAsync();
            isInitialized = true;
            
            if (Auth.IsPartner && Auth.Id.HasValue)
            {
                // Load existing active orders for persistence
                await LoadActiveOrders();
                
                _dotNetRef = DotNetObjectReference.Create(this);
                
                // PublicUrl for browser, GatewayUrl is internal docker hostname
                var gatewayUrl = Configuration["GatewayPublicUrl"] ?? Configuration["GatewayUrl"] ?? "http://localhost:8080";
                var wsUrl = gatewayUrl.Replace("http://", "ws://").Replace("https://", "wss://");
                wsUrl = $"{wsUrl}/api/v1/ws/partners/{Auth.Id}";

                if (!string.IsNullOrEmpty(Auth.Token))
                {
                    wsUrl = $"{wsUrl}?access_token={Uri.EscapeDataString(Auth.Token)}";
                }

                await JS.InvokeVoidAsync("partnerWebSocket.connect", wsUrl, _dotNetRef);
            }
            StateHasChanged();
        }
    }

    private async Task LoadActiveOrders()
    {
        StatusMessage = "Loading active orders...";
        
        try
        {
            var gatewayUrl = Configuration["GatewayUrl"] ?? "http://localhost:8080";
            var request = new HttpRequestMessage(HttpMethod.Get, $"{gatewayUrl}/api/v1/orders/partner/{Auth.Id}/active");
            
            if (!string.IsNullOrEmpty(Auth.Token))
            {
                request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", Auth.Token);
            }
            
            var response = await Http.SendAsync(request);
            
            if (response.IsSuccessStatusCode)
            {
                var orders = await response.Content.ReadFromJsonAsync<List<PartnerOrderResponse>>();
                
                if (orders != null)
                {
                    foreach (var order in orders)
                    {
                        // Orders with status "Placed" go to NewOrders
                        if (order.Status == "Placed")
                        {
                            NewOrders.Add(new IncomingOrder
                            {
                                OrderId = order.Id,
                                OrderCreatedTime = order.OrderCreatedTime,
                                Distance = "", // Not available from API response
                                Items = order.Items.Select(i => new OrderItemDto
                                {
                                    Name = i.Name,
                                    Quantity = i.Quantity
                                }).ToList(),
                                ReceivedAt = DateTime.TryParse(order.OrderCreatedTime, out var dt) ? dt : DateTime.Now
                            });
                        }
                        // Orders with status "Accepted" or "Ready" go to AcceptedOrders
                        else if (order.Status == "Accepted" || order.Status == "Ready")
                        {
                            AcceptedOrders.Add(new AcceptedOrder
                            {
                                OrderId = order.Id,
                                Items = order.Items.Select(i => new OrderItemDto
                                {
                                    Name = i.Name,
                                    Quantity = i.Quantity
                                }).ToList(),
                                Distance = "",
                                EstimatedMinutes = 0,
                                AcceptedAt = DateTime.TryParse(order.OrderCreatedTime, out var dt2) ? dt2 : DateTime.Now,
                                AgentId = order.AgentId,
                                IsReady = order.Status == "Ready"
                            });
                        }
                    }
                }
                
                StatusMessage = $"Loaded {NewOrders.Count} new orders, {AcceptedOrders.Count} accepted orders";
            }
            else
            {
                StatusMessage = $"Failed to load orders: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            StatusMessage = $"Error loading orders: {ex.Message}";
        }
        finally
        {
            // No-op
        }
    }

    [JSInvokable]
    public void OnConnected()
    {
        IsConnected = true;
        StatusMessage = "Listening for orders...";
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public void OnDisconnected(string reason)
    {
        IsConnected = false;
        StatusMessage = $"Disconnected: {reason}";
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public void OnOrderCreated(int orderId, string orderCreatedTime, string distance, OrderItemDto[] items)
    {
        var order = new IncomingOrder
        {
            OrderId = orderId,
            OrderCreatedTime = orderCreatedTime,
            Distance = distance,
            Items = items.ToList(),
            ReceivedAt = DateTime.Now
        };

        NewOrders.Add(order);
        StatusMessage = $"New order #{orderId} received!";
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public void OnAgentAssigned(int orderId, int agentId)
    {
        var order = AcceptedOrders.FirstOrDefault(o => o.OrderId == orderId);
        if (order != null)
        {
            order.AgentId = agentId;
            StatusMessage = $"Agent #{agentId} assigned to order #{orderId}";
            InvokeAsync(StateHasChanged);
        }
    }

    [JSInvokable]
    public void OnOrderPickedUp(int orderId)
    {
        var order = AcceptedOrders.FirstOrDefault(o => o.OrderId == orderId);
        if (order != null)
        {
            AcceptedOrders.Remove(order);
            StatusMessage = $"Order #{orderId} picked up by agent!";
            InvokeAsync(StateHasChanged);
        }
    }

    private async Task AcceptOrder(IncomingOrder order)
    {
        NewOrders.Remove(order);
        AcceptedOrders.Add(new AcceptedOrder
        {
            OrderId = order.OrderId,
            Items = order.Items,
            Distance = order.Distance,
            EstimatedMinutes = order.EstimatedMinutes ?? 0,
            AcceptedAt = DateTime.Now,
            AgentId = null
        });

        // Call Gateway to accept order
        var gatewayUrl = Configuration["GatewayUrl"] ?? "http://localhost:8080";
        StatusMessage = $"Order #{order.OrderId} accepted! ETA: {order.EstimatedMinutes} min";
        
        try
        {
            var payload = new { estimatedMinutes = order.EstimatedMinutes ?? 15 };
            var request = new HttpRequestMessage(HttpMethod.Post, $"{gatewayUrl}/api/v1/orders/order/{order.OrderId}/accept");
            request.Content = JsonContent.Create(payload);
            
            if (!string.IsNullOrEmpty(Auth.Token))
            {
                request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", Auth.Token);
            }
            
            var response = await Http.SendAsync(request);
            if (!response.IsSuccessStatusCode)
            {
                StatusMessage = $"Order #{order.OrderId} accepted locally, but API call failed: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            StatusMessage = $"Order #{order.OrderId} accepted locally, API error: {ex.Message}";
        }
        
        await InvokeAsync(StateHasChanged);
    }

    private async Task RejectOrder(IncomingOrder order)
    {
        NewOrders.Remove(order);
        StatusMessage = $"Order #{order.OrderId} rejected";

        var gatewayUrl = Configuration["GatewayUrl"] ?? "http://localhost:8080";
        try
        {
            var request = new HttpRequestMessage(HttpMethod.Post, $"{gatewayUrl}/api/v1/orders/order/{order.OrderId}/reject");
            request.Content = JsonContent.Create(new { reason = "Partner rejected" });
            
            if (!string.IsNullOrEmpty(Auth.Token))
            {
                request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", Auth.Token);
            }
            
            await Http.SendAsync(request);
        }
        catch
        {
            // Fire-and-forget, UI already updated
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task MarkFoodReady(AcceptedOrder order)
    {
        order.IsReady = true;
        StatusMessage = $"Order #{order.OrderId} marked as ready!";

        var gatewayUrl = Configuration["GatewayUrl"] ?? "http://localhost:8080";
        try
        {
            var request = new HttpRequestMessage(HttpMethod.Post, $"{gatewayUrl}/api/v1/orders/order/{order.OrderId}/set-ready");
            
            if (!string.IsNullOrEmpty(Auth.Token))
            {
                request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", Auth.Token);
            }
            
            await Http.SendAsync(request);
        }
        catch
        {
            // Fire-and-forget, UI already updated
        }

        await InvokeAsync(StateHasChanged);
    }

    public async ValueTask DisposeAsync()
    {
        CultureService.OnChange -= OnCultureChanged;
        if (_dotNetRef != null)
        {
            await JS.InvokeVoidAsync("partnerWebSocket.disconnect");
            _dotNetRef.Dispose();
        }
    }

    public class IncomingOrder
    {
        public int OrderId { get; set; }
        public string OrderCreatedTime { get; set; } = "";
        public string Distance { get; set; } = "";
        public List<OrderItemDto> Items { get; set; } = new();
        public DateTime ReceivedAt { get; set; }
        public int? EstimatedMinutes { get; set; }
    }

    public class AcceptedOrder
    {
        public int OrderId { get; set; }
        public List<OrderItemDto> Items { get; set; } = new();
        public string Distance { get; set; } = "";
        public int EstimatedMinutes { get; set; }
        public DateTime? AcceptedAt { get; set; }
        public int? AgentId { get; set; }
        public bool IsReady { get; set; }
    }

    public class OrderItemDto
    {
        public string Name { get; set; } = "";
        public int Quantity { get; set; }
    }

    // Response model for active orders API
    public class PartnerOrderResponse
    {
        public int Id { get; set; }
        public int CustomerId { get; set; }
        public int? AgentId { get; set; }
        public string DeliveryAddress { get; set; } = "";
        public decimal ServiceFee { get; set; }
        public decimal DeliveryFee { get; set; }
        public string Status { get; set; } = "";
        public string OrderCreatedTime { get; set; } = "";
        public List<PartnerOrderItemResponse> Items { get; set; } = new();
    }

    public class PartnerOrderItemResponse
    {
        public int FoodItemId { get; set; }
        public string Name { get; set; } = "";
        public int Quantity { get; set; }
        public decimal UnitPrice { get; set; }
    }
}
