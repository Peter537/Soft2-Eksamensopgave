@page "/login"
@using MToGo.Website.Components.Shared
@inject HttpClient Http
@inject NavigationManager Navigation
@inject AuthService Auth
@inject CultureService CultureService
@inject ILocalizerService L
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>@L["Pages.Login.PageTitle"]</PageTitle>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <LoginForm 
                IdentifierLabel="@L["Pages.Login.Email"]"
                IdentifierPlaceholder="@L["Pages.Login.EmailPlaceholder"]"
                PasswordLabel="@L["Pages.Login.Password"]"
                PasswordPlaceholder="@L["Pages.Login.PasswordPlaceholder"]"
                ApiEndpoint="/api/v1/customers/login"
                RedirectUrl="/profile"
                CardTitle="@L["Pages.Login.Title"]"
                CardHeaderClass=""
                ButtonClass="btn-primary"
                ButtonText="@L["Pages.Login.LoginButton"]"
                LoadingText="@L["Pages.Login.LoggingIn"]"
                FormName="CustomerLoginForm"
                OnLoginSuccess="HandleLoginSuccess">
                <AdditionalLinks>
                    <div class="mt-3 text-center">
                        <p class="mb-0">@L["Pages.Login.NoAccount"] <a href="/register">@L["Pages.Login.RegisterHere"]</a></p>
                        <p class="mb-0">@L["Pages.Login.AgentQuestion"] <a href="/agent/login">@L["Pages.Login.AgentLogin"]</a></p>
                        <p class="mb-0">@L["Pages.Login.PartnerQuestion"] <a href="/partner/login">@L["Pages.Login.PartnerLogin"]</a></p>
                    </div>
                </AdditionalLinks>
            </LoginForm>
        </div>
    </div>
</div>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Initialize auth then check if already logged in
            await Auth.InitializeAsync();
            
            if (Auth.IsLoggedIn && Auth.IsCustomer)
            {
                Navigation.NavigateTo("/profile");
            }
        }
    }

    protected override void OnInitialized()
    {
        CultureService.OnChange += OnCultureChanged;
    }

    private void OnCultureChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        CultureService.OnChange -= OnCultureChanged;
    }

    private async Task HandleLoginSuccess(string jwt)
    {
        // Fetch user's language preference after successful login
        if (Auth.Id.HasValue)
        {
            await LoadUserLanguagePreference(Auth.Id.Value);
        }
    }

    private async Task LoadUserLanguagePreference(int customerId)
    {
        try
        {
            var request = new HttpRequestMessage(HttpMethod.Get, $"/api/v1/customers/{customerId}");
            if (!string.IsNullOrEmpty(Auth.Token))
            {
                request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", Auth.Token);
            }
            
            var profileResponse = await Http.SendAsync(request);
            if (profileResponse.IsSuccessStatusCode)
            {
                var profile = await profileResponse.Content.ReadFromJsonAsync<CustomerProfile>();
                if (!string.IsNullOrEmpty(profile?.LanguagePreference))
                {
                    CultureService.SetCulture(profile.LanguagePreference);
                }
            }
        }
        catch
        {
            // Silently fail - use default language
        }
    }

    public class CustomerProfile
    {
        public string? LanguagePreference { get; set; }
    }
}
