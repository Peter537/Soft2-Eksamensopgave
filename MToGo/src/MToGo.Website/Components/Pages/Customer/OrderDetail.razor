@page "/customer/orders/{OrderId:int}"
@inject HttpClient Http
@inject CultureService CultureService
@inject AuthService Auth
@inject NavigationManager Navigation
@inject ILocalizerService L
@inject IConfiguration Configuration
@inject IJSRuntime JS
@implements IAsyncDisposable
@rendermode InteractiveServer

<PageTitle>@string.Format(L["Pages.Customer.OrderDetail.PageTitle"], OrderId)</PageTitle>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Back navigation -->
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/customer/active-orders">@L["Pages.Customer.OrderDetail.BreadcrumbActiveOrders"]</a></li>
                    <li class="breadcrumb-item active">@string.Format(L["Pages.Customer.OrderDetail.BreadcrumbOrder"], OrderId)</li>
                </ol>
            </nav>

            @if (!Auth.IsCustomer)
            {
                <div class="alert alert-warning">
                    <p class="mb-0">@L["Pages.Customer.OrderDetail.LoginRequired"] <a href="/login">@L["Pages.Customer.OrderDetail.LoginLink"]</a></p>
                </div>
            }
            else if (isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">@L["Pages.Customer.OrderDetail.Loading"]</span>
                    </div>
                    <p class="mt-2 text-muted">@L["Pages.Customer.OrderDetail.Loading"]</p>
                </div>
            }
            else if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
                </div>
            }
            else if (order != null)
            {
                <!-- Order Header -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">@string.Format(L["Pages.Customer.OrderDetail.BreadcrumbOrder"], order.Id)</h4>
                            <small>@FormatDate(order.OrderCreatedTime)</small>
                        </div>
                        <div class="text-end">
                            @if (IsConnected)
                            {
                                <span class="badge bg-success">
                                    <i class="bi bi-wifi me-1"></i>@L["Pages.Customer.OrderDetail.LiveStatus"]
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-light text-dark">
                                    <i class="bi bi-wifi-off me-1"></i>@L["Pages.Customer.OrderDetail.OfflineStatus"]
                                </span>
                            }
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong><i class="bi bi-shop me-2"></i>@L["Pages.Customer.OrderDetail.Partner"]</strong> #@order.PartnerId</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong><i class="bi bi-geo-alt me-2"></i>@L["Pages.Customer.OrderDetail.Delivery"]</strong> @order.DeliveryAddress</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Left: Order Status Stepper -->
                    <div class="col-lg-5 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>@L["Pages.Customer.OrderDetail.OrderStatus"]</h5>
                            </div>
                            <div class="card-body">
                                @if (order.Status == "Rejected")
                                {
                                    <div class="alert alert-danger">
                                        <i class="bi bi-x-circle me-2"></i>
                                        <strong>@L["Pages.Customer.OrderDetail.OrderRejected"]</strong>
                                        @if (!string.IsNullOrEmpty(rejectionReason))
                                        {
                                            <p class="mb-0 mt-2">@L["Pages.Customer.OrderDetail.RejectionReason"] @rejectionReason</p>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="stepper">
                                        @foreach (var step in GetOrderSteps())
                                        {
                                            <div class="step @(step.IsCompleted ? "completed" : "") @(step.IsCurrent ? "current" : "")">
                                                <div class="step-icon">
                                                    @if (step.IsCompleted)
                                                    {
                                                        <i class="bi bi-check-lg"></i>
                                                    }
                                                    else if (step.IsCurrent)
                                                    {
                                                        <div class="spinner-border spinner-border-sm" role="status">
                                                            <span class="visually-hidden">@L["Pages.Customer.OrderDetail.InProgress"]</span>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <i class="bi bi-circle"></i>
                                                    }
                                                </div>
                                                <div class="step-content">
                                                    <div class="step-title">@step.Title</div>
                                                    <div class="step-description text-muted">@step.Description</div>
                                                    @if (!string.IsNullOrEmpty(step.Timestamp))
                                                    {
                                                        <small class="text-success">@step.Timestamp</small>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Right: Order Items & Pricing -->
                    <div class="col-lg-7 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-bag me-2"></i>@L["Pages.Customer.OrderDetail.OrderItems"]</h5>
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>@L["Pages.Customer.OrderDetail.Item"]</th>
                                            <th class="text-center">@L["Pages.Customer.OrderDetail.Qty"]</th>
                                            <th class="text-end">@L["Pages.Customer.OrderDetail.Price"]</th>
                                            <th class="text-end">@L["Pages.Customer.OrderDetail.Subtotal"]</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in order.Items)
                                        {
                                            <tr>
                                                <td>@item.Name</td>
                                                <td class="text-center">@item.Quantity</td>
                                                <td class="text-end">@item.UnitPrice.FormatDKK()</td>
                                                <td class="text-end">@((item.Quantity * item.UnitPrice).FormatDKK())</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pricing Summary -->
                            <div class="card-footer bg-light">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">@L["Pages.Customer.OrderDetail.ItemsSubtotal"]</span>
                                    <span>@GetItemsSubtotal().FormatDKK()</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">@L["Pages.Customer.OrderDetail.DeliveryFee"]</span>
                                    <span>@order.DeliveryFee.FormatDKK()</span>
                                </div>
                                <hr />
                                <div class="d-flex justify-content-between">
                                    <strong class="fs-5">@L["Pages.Customer.OrderDetail.Total"]</strong>
                                    <strong class="fs-5 text-primary">@CalculateTotal().FormatDKK()</strong>
                                </div>
                            </div>
                        </div>

                        @* Review Section - Only show for delivered orders *@
                        @if (order.Status == "Delivered")
                        {
                            <div class="card mt-3 shadow-sm">
                                <div class="card-header bg-warning text-dark">
                                    <h5 class="mb-0"><i class="bi bi-star me-2"></i>@L["Pages.Customer.OrderDetail.RateYourOrder"]</h5>
                                </div>
                                <div class="card-body">
                                    @if (hasReviewed && existingReview != null)
                                    {
                                        <div class="alert alert-success mb-3">
                                            <i class="bi bi-check-circle me-2"></i>@L["Pages.Customer.OrderDetail.ThankYouFeedback"]
                                        </div>
                                        
                                        <div class="row">
                                            @* Food Rating Display *@
                                            @if (existingReview.FoodRating > 0)
                                            {
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label fw-bold">üçΩÔ∏è @L["Pages.Customer.OrderDetail.FoodQuality"]</label>
                                                    <div class="mb-2">
                                                        @for (int i = 1; i <= 5; i++)
                                                        {
                                                            <span class="@(existingReview.FoodRating >= i ? "text-warning" : "text-muted")" style="font-size: 1.5rem;">
                                                                @(existingReview.FoodRating >= i ? "‚òÖ" : "‚òÜ")
                                                            </span>
                                                        }
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(existingReview.FoodComment))
                                                    {
                                                        <p class="text-muted small mb-0 fst-italic">"@existingReview.FoodComment"</p>
                                                    }
                                                </div>
                                            }

                                            @* Agent Rating Display *@
                                            @if (existingReview.AgentRating > 0)
                                            {
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label fw-bold">üö¥ @L["Pages.Customer.OrderDetail.DeliveryAgent"]</label>
                                                    <div class="mb-2">
                                                        @for (int i = 1; i <= 5; i++)
                                                        {
                                                            <span class="@(existingReview.AgentRating >= i ? "text-warning" : "text-muted")" style="font-size: 1.5rem;">
                                                                @(existingReview.AgentRating >= i ? "‚òÖ" : "‚òÜ")
                                                            </span>
                                                        }
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(existingReview.AgentComment))
                                                    {
                                                        <p class="text-muted small mb-0 fst-italic">"@existingReview.AgentComment"</p>
                                                    }
                                                </div>
                                            }

                                            @* Order Rating Display *@
                                            @if (existingReview.OrderRating > 0)
                                            {
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label fw-bold">üì¶ @L["Pages.Customer.OrderDetail.OverallExperience"]</label>
                                                    <div class="mb-2">
                                                        @for (int i = 1; i <= 5; i++)
                                                        {
                                                            <span class="@(existingReview.OrderRating >= i ? "text-warning" : "text-muted")" style="font-size: 1.5rem;">
                                                                @(existingReview.OrderRating >= i ? "‚òÖ" : "‚òÜ")
                                                            </span>
                                                        }
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(existingReview.OrderComment))
                                                    {
                                                        <p class="text-muted small mb-0 fst-italic">"@existingReview.OrderComment"</p>
                                                    }
                                                </div>
                                            }
                                        </div>
                                        
                                        <small class="text-muted">@L["Pages.Customer.OrderDetail.ReviewSubmittedOn"] @existingReview.CreatedAt.ToLocalTime().ToString("f")</small>
                                    }
                                    else if (hasReviewed)
                                    {
                                        <div class="alert alert-success mb-0">
                                            <i class="bi bi-check-circle me-2"></i>@L["Pages.Customer.OrderDetail.ThankYouFeedback"]
                                        </div>
                                    }
                                    else if (isSubmittingReview)
                                    {
                                        <div class="text-center py-3">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">@L["Pages.Customer.OrderDetail.Submitting"]</span>
                                            </div>
                                            <p class="mt-2 text-muted">@L["Pages.Customer.OrderDetail.Submitting"]</p>
                                        </div>
                                    }
                                    else
                                    {
                                        @if (!string.IsNullOrEmpty(reviewErrorMessage))
                                        {
                                            <div class="alert alert-danger">
                                                <i class="bi bi-exclamation-triangle me-2"></i>@reviewErrorMessage
                                            </div>
                                        }

                                        <EditForm Model="reviewModel" OnValidSubmit="SubmitReview">
                                            <DataAnnotationsValidator />

                                            <div class="row">
                                                <!-- Food Rating -->
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label fw-bold">üçΩÔ∏è @L["Pages.Customer.OrderDetail.FoodQuality"]</label>
                                                    <div class="star-rating d-flex mb-2">
                                                        @for (int i = 1; i <= 5; i++)
                                                        {
                                                            var rating = i;
                                                            <button type="button" class="btn btn-sm @(reviewModel.FoodRating >= rating ? "btn-warning" : "btn-outline-secondary") me-1" 
                                                                    style="font-size: 1.2rem; width: 40px; height: 40px;"
                                                                    @onclick="() => SetFoodRating(rating)">
                                                                @(reviewModel.FoodRating >= rating ? "‚òÖ" : "‚òÜ")
                                                            </button>
                                                        }
                                                    </div>
                                                    <textarea class="form-control mt-2" rows="2" maxlength="500" 
                                                              placeholder="@L["Pages.Customer.OrderDetail.FoodCommentPlaceholder"]"
                                                              @bind="reviewModel.FoodComment"></textarea>
                                                    <small class="text-muted">@(reviewModel.FoodComment?.Length ?? 0)/500</small>
                                                </div>

                                                <!-- Agent Rating -->
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label fw-bold">üö¥ @L["Pages.Customer.OrderDetail.DeliveryAgent"]</label>
                                                    <div class="star-rating d-flex mb-2">
                                                        @for (int i = 1; i <= 5; i++)
                                                        {
                                                            var rating = i;
                                                            <button type="button" class="btn btn-sm @(reviewModel.AgentRating >= rating ? "btn-warning" : "btn-outline-secondary") me-1" 
                                                                    style="font-size: 1.2rem; width: 40px; height: 40px;"
                                                                    @onclick="() => SetAgentRating(rating)">
                                                                @(reviewModel.AgentRating >= rating ? "‚òÖ" : "‚òÜ")
                                                            </button>
                                                        }
                                                    </div>
                                                    <textarea class="form-control mt-2" rows="2" maxlength="500" 
                                                              placeholder="@L["Pages.Customer.OrderDetail.AgentCommentPlaceholder"]"
                                                              @bind="reviewModel.AgentComment"></textarea>
                                                    <small class="text-muted">@(reviewModel.AgentComment?.Length ?? 0)/500</small>
                                                </div>

                                                <!-- Order Rating -->
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label fw-bold">üì¶ @L["Pages.Customer.OrderDetail.OverallExperience"]</label>
                                                    <div class="star-rating d-flex mb-2">
                                                        @for (int i = 1; i <= 5; i++)
                                                        {
                                                            var rating = i;
                                                            <button type="button" class="btn btn-sm @(reviewModel.OrderRating >= rating ? "btn-warning" : "btn-outline-secondary") me-1" 
                                                                    style="font-size: 1.2rem; width: 40px; height: 40px;"
                                                                    @onclick="() => SetOrderRating(rating)">
                                                                @(reviewModel.OrderRating >= rating ? "‚òÖ" : "‚òÜ")
                                                            </button>
                                                        }
                                                    </div>
                                                    <textarea class="form-control mt-2" rows="2" maxlength="500" 
                                                              placeholder="@L["Pages.Customer.OrderDetail.OrderCommentPlaceholder"]"
                                                              @bind="reviewModel.OrderComment"></textarea>
                                                    <small class="text-muted">@(reviewModel.OrderComment?.Length ?? 0)/500</small>
                                                </div>
                                            </div>

                                            <div class="text-center mt-3">
                                                <button type="submit" class="btn btn-warning btn-lg" 
                                                        disabled="@(reviewModel.FoodRating == 0 && reviewModel.AgentRating == 0 && reviewModel.OrderRating == 0)">
                                                    <i class="bi bi-send me-2"></i>@L["Pages.Customer.OrderDetail.SubmitReview"]
                                                </button>
                                            </div>
                                        </EditForm>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Back button -->
                <div class="text-center mt-4">
                    <a href="/customer/active-orders" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>@L["Pages.Customer.OrderDetail.BackToActiveOrders"]
                    </a>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .stepper {
        position: relative;
        padding-left: 0;
    }
    
    .step {
        display: flex;
        align-items: flex-start;
        margin-bottom: 1.5rem;
        position: relative;
    }
    
    .step:not(:last-child)::after {
        content: '';
        position: absolute;
        left: 15px;
        top: 35px;
        width: 2px;
        height: calc(100% + 0.5rem);
        background-color: #dee2e6;
    }
    
    .step.completed:not(:last-child)::after {
        background-color: #198754;
    }
    
    .step-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #dee2e6;
        color: #6c757d;
        flex-shrink: 0;
        margin-right: 1rem;
        z-index: 1;
    }
    
    .step.completed .step-icon {
        background-color: #198754;
        color: white;
    }
    
    .step.current .step-icon {
        background-color: #0d6efd;
        color: white;
    }
    
    .step-content {
        flex-grow: 1;
        padding-top: 4px;
    }
    
    .step-title {
        font-weight: 600;
        margin-bottom: 2px;
    }
    
    .step-description {
        font-size: 0.875rem;
    }
    
    .step.completed .step-title {
        color: #198754;
    }
    
    .step.current .step-title {
        color: #0d6efd;
    }
</style>

@code {
    [Parameter]
    public int OrderId { get; set; }

    private CustomerOrderResponse? order;
    private string? errorMessage;
    private bool isLoading = true;
    private string? rejectionReason;
    
    // Review state
    private ReviewModel reviewModel = new();
    private bool hasReviewed = false;
    private bool isSubmittingReview = false;
    private string? reviewErrorMessage;
    private ReviewResponse? existingReview;
    
    // Status timestamps (populated from WebSocket events)
    private Dictionary<string, string> statusTimestamps = new();
    
    // WebSocket state
    private bool IsConnected { get; set; }
    private DotNetObjectReference<OrderDetail>? _dotNetRef;
    private int _listenerId;

    protected override void OnInitialized()
    {
        CultureService.OnChange += OnCultureChanged;
    }

    private void OnCultureChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Auth.InitializeAsync();
            
            if (Auth.IsCustomer)
            {
                await LoadOrderDetail();
                await CheckExistingReview();
                await ConnectWebSocket();
            }
            else
            {
                isLoading = false;
            }
            StateHasChanged();
        }
    }

    private async Task ConnectWebSocket()
    {
        if (!Auth.IsCustomer || !Auth.Id.HasValue) return;

        try
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            var gatewayUrl = Configuration["GatewayPublicUrl"] ?? Configuration["GatewayUrl"] ?? "http://localhost:5000";
            var wsUrl = gatewayUrl.Replace("http://", "ws://").Replace("https://", "wss://");
            wsUrl = $"{wsUrl}/api/v1/ws/customers/{Auth.Id}";
            
            // Connect returns a listener ID for cleanup
            _listenerId = await JS.InvokeAsync<int>("customerWebSocket.connect", wsUrl, _dotNetRef);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to connect WebSocket: {ex.Message}");
        }
    }

    [JSInvokable]
    public void OnConnected()
    {
        IsConnected = true;
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public void OnDisconnected(string reason)
    {
        IsConnected = false;
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public async Task OnOrderAccepted(int orderId, string partnerName, int estimatedMinutes, string timestamp)
    {
        if (orderId == OrderId && order != null)
        {
            order.Status = "Accepted";
            statusTimestamps["Accepted"] = FormatTimestamp(timestamp);
            await InvokeAsync(StateHasChanged);
        }
    }

    [JSInvokable]
    public async Task OnOrderRejected(int orderId, string reason, string timestamp)
    {
        if (orderId == OrderId && order != null)
        {
            order.Status = "Rejected";
            rejectionReason = reason;
            await InvokeAsync(StateHasChanged);
        }
    }

    [JSInvokable]
    public async Task OnOrderReady(int orderId, string partnerName, string timestamp)
    {
        if (orderId == OrderId && order != null)
        {
            order.Status = "Ready";
            statusTimestamps["Ready"] = FormatTimestamp(timestamp);
            await InvokeAsync(StateHasChanged);
        }
    }

    [JSInvokable]
    public async Task OnOrderPickedUp(int orderId, string agentName, string timestamp)
    {
        if (orderId == OrderId && order != null)
        {
            order.Status = "PickedUp";
            statusTimestamps["PickedUp"] = FormatTimestamp(timestamp);
            await InvokeAsync(StateHasChanged);
        }
    }

    [JSInvokable]
    public async Task OnOrderDelivered(int orderId, string timestamp)
    {
        if (orderId == OrderId && order != null)
        {
            order.Status = "Delivered";
            statusTimestamps["Delivered"] = FormatTimestamp(timestamp);
            await InvokeAsync(StateHasChanged);
        }
    }

    private string FormatTimestamp(string isoTimestamp)
    {
        if (DateTime.TryParse(isoTimestamp, out var dt))
        {
            return dt.ToLocalTime().ToString("h:mm tt");
        }
        return "";
    }

    private async Task LoadOrderDetail()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var url = $"/api/v1/orders/customer/{Auth.Id}/active";

            var request = new HttpRequestMessage(HttpMethod.Get, url);
            if (!string.IsNullOrEmpty(Auth.Token))
            {
                request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", Auth.Token);
            }

            var response = await Http.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                var orders = await response.Content.ReadFromJsonAsync<List<CustomerOrderResponse>>();
                order = orders?.FirstOrDefault(o => o.Id == OrderId);
                
                if (order == null)
                {
                    // Try loading from full order history
                    await LoadFromHistory();
                }
            }
            else
            {
                errorMessage = "Failed to load order details. Please try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadFromHistory()
    {
        try
        {
            var url = $"/api/v1/orders/customer/{Auth.Id}";
            var request = new HttpRequestMessage(HttpMethod.Get, url);
            if (!string.IsNullOrEmpty(Auth.Token))
            {
                request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", Auth.Token);
            }

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                var orders = await response.Content.ReadFromJsonAsync<List<CustomerOrderResponse>>();
                order = orders?.FirstOrDefault(o => o.Id == OrderId);
                
                if (order == null)
                {
                    errorMessage = "Order not found.";
                }
            }
        }
        catch { }
    }

    private List<OrderStep> GetOrderSteps()
    {
        var currentStatusIndex = GetStatusIndex(order?.Status ?? "Placed");
        
        var steps = new List<OrderStep>
        {
            new OrderStep 
            { 
                Title = L["Pages.Customer.OrderDetail.StepOrderPlaced"], 
                Description = L["Pages.Customer.OrderDetail.StepOrderPlacedDesc"],
                IsCompleted = currentStatusIndex >= 0,
                IsCurrent = currentStatusIndex == 0,
                Timestamp = order != null ? FormatDate(order.OrderCreatedTime) : ""
            },
            new OrderStep 
            { 
                Title = L["Pages.Customer.OrderDetail.StepAccepted"], 
                Description = L["Pages.Customer.OrderDetail.StepAcceptedDesc"],
                IsCompleted = currentStatusIndex >= 1,
                IsCurrent = currentStatusIndex == 1,
                Timestamp = statusTimestamps.GetValueOrDefault("Accepted", "")
            },
            new OrderStep 
            { 
                Title = L["Pages.Customer.OrderDetail.StepReady"], 
                Description = L["Pages.Customer.OrderDetail.StepReadyDesc"],
                IsCompleted = currentStatusIndex >= 2,
                IsCurrent = currentStatusIndex == 2,
                Timestamp = statusTimestamps.GetValueOrDefault("Ready", "")
            },
            new OrderStep 
            { 
                Title = L["Pages.Customer.OrderDetail.StepPickedUp"], 
                Description = L["Pages.Customer.OrderDetail.StepPickedUpDesc"],
                IsCompleted = currentStatusIndex >= 3,
                IsCurrent = currentStatusIndex == 3,
                Timestamp = statusTimestamps.GetValueOrDefault("PickedUp", "")
            },
            new OrderStep 
            { 
                Title = L["Pages.Customer.OrderDetail.StepDelivered"], 
                Description = L["Pages.Customer.OrderDetail.StepDeliveredDesc"],
                IsCompleted = currentStatusIndex >= 4,
                IsCurrent = currentStatusIndex == 4,
                Timestamp = statusTimestamps.GetValueOrDefault("Delivered", "")
            }
        };
        
        return steps;
    }

    private int GetStatusIndex(string status)
    {
        return status switch
        {
            "Placed" => 0,
            "Accepted" => 1,
            "Ready" => 2,
            "PickedUp" => 3,
            "Delivered" => 4,
            _ => -1
        };
    }

    private string FormatDate(string isoDate)
    {
        if (DateTime.TryParse(isoDate, out var date))
        {
            return date.ToLocalTime().ToString("h:mm tt");
        }
        return isoDate;
    }

    private decimal GetItemsSubtotal()
    {
        return order?.Items.Sum(i => i.Quantity * i.UnitPrice) ?? 0;
    }

    private decimal CalculateTotal()
    {
        if (order == null) return 0;
        return GetItemsSubtotal() + order.DeliveryFee;
    }

    private void SetFoodRating(int rating)
    {
        reviewModel.FoodRating = rating;
        StateHasChanged();
    }

    private void SetAgentRating(int rating)
    {
        reviewModel.AgentRating = rating;
        StateHasChanged();
    }

    private void SetOrderRating(int rating)
    {
        reviewModel.OrderRating = rating;
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        CultureService.OnChange -= OnCultureChanged;
        
        try
        {
            // Remove this component's listener, don't disconnect the whole socket
            if (_listenerId > 0)
            {
                await JS.InvokeVoidAsync("customerWebSocket.removeListener", _listenerId);
            }
        }
        catch { }
        
        _dotNetRef?.Dispose();
    }

    private class OrderStep
    {
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
        public bool IsCompleted { get; set; }
        public bool IsCurrent { get; set; }
        public string Timestamp { get; set; } = "";
    }

    public class CustomerOrderResponse
    {
        public int Id { get; set; }
        public int PartnerId { get; set; }
        public int? AgentId { get; set; }
        public string DeliveryAddress { get; set; } = string.Empty;
        public decimal ServiceFee { get; set; }
        public decimal DeliveryFee { get; set; }
        public string Status { get; set; } = string.Empty;
        public string OrderCreatedTime { get; set; } = string.Empty;
        public List<CustomerOrderItemResponse> Items { get; set; } = new();
    }

    public class CustomerOrderItemResponse
    {
        public int FoodItemId { get; set; }
        public string Name { get; set; } = string.Empty;
        public int Quantity { get; set; }
        public decimal UnitPrice { get; set; }
    }

    private async Task CheckExistingReview()
    {
        if (order == null || order.Status != "Delivered") return;

        try
        {
            var url = $"/api/v1/feedback-hub/reviews/order/{OrderId}/exists";
            var request = new HttpRequestMessage(HttpMethod.Get, url);
            if (!string.IsNullOrEmpty(Auth.Token))
            {
                request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", Auth.Token);
            }

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ReviewExistsResponse>();
                hasReviewed = result?.Exists ?? false;
                
                // If review exists, fetch the full review details
                if (hasReviewed)
                {
                    await LoadExistingReview();
                }
            }
        }
        catch { }
    }

    private async Task LoadExistingReview()
    {
        try
        {
            var url = $"/api/v1/feedback-hub/reviews/order/{OrderId}";
            var request = new HttpRequestMessage(HttpMethod.Get, url);
            if (!string.IsNullOrEmpty(Auth.Token))
            {
                request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", Auth.Token);
            }

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                existingReview = await response.Content.ReadFromJsonAsync<ReviewResponse>();
            }
        }
        catch { }
    }

    private async Task SubmitReview()
    {
        if (order == null || !Auth.Id.HasValue) return;

        isSubmittingReview = true;
        reviewErrorMessage = null;
        StateHasChanged();

        try
        {
            var reviewRequest = new CreateReviewRequest
            {
                OrderId = OrderId,
                CustomerId = Auth.Id.Value,
                PartnerId = order.PartnerId,
                AgentId = order.AgentId,
                FoodRating = reviewModel.FoodRating,
                AgentRating = reviewModel.AgentRating,
                OrderRating = reviewModel.OrderRating,
                FoodComment = reviewModel.FoodComment,
                AgentComment = reviewModel.AgentComment,
                OrderComment = reviewModel.OrderComment
            };

            var url = "/api/v1/feedback-hub/reviews";
            var request = new HttpRequestMessage(HttpMethod.Post, url);
            request.Content = JsonContent.Create(reviewRequest);
            if (!string.IsNullOrEmpty(Auth.Token))
            {
                request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", Auth.Token);
            }

            var response = await Http.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                hasReviewed = true;
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Conflict)
            {
                hasReviewed = true; // Already reviewed
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                reviewErrorMessage = "Failed to submit review. Please try again.";
            }
        }
        catch (Exception ex)
        {
            reviewErrorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isSubmittingReview = false;
            StateHasChanged();
        }
    }

    public class ReviewModel
    {
        public int FoodRating { get; set; }
        public int AgentRating { get; set; }
        public int OrderRating { get; set; }
        public string? FoodComment { get; set; }
        public string? AgentComment { get; set; }
        public string? OrderComment { get; set; }
    }

    public class CreateReviewRequest
    {
        public int OrderId { get; set; }
        public int CustomerId { get; set; }
        public int PartnerId { get; set; }
        public int? AgentId { get; set; }
        public int FoodRating { get; set; }
        public int AgentRating { get; set; }
        public int OrderRating { get; set; }
        public string? FoodComment { get; set; }
        public string? AgentComment { get; set; }
        public string? OrderComment { get; set; }
    }

    public class ReviewExistsResponse
    {
        public bool Exists { get; set; }
    }

    public class ReviewResponse
    {
        public int Id { get; set; }
        public int OrderId { get; set; }
        public int CustomerId { get; set; }
        public int PartnerId { get; set; }
        public int? AgentId { get; set; }
        public DateTime CreatedAt { get; set; }
        public int FoodRating { get; set; }
        public int AgentRating { get; set; }
        public int OrderRating { get; set; }
        public string? FoodComment { get; set; }
        public string? AgentComment { get; set; }
        public string? OrderComment { get; set; }
    }
}
