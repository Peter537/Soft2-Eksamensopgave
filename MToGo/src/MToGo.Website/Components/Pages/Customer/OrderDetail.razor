@page "/customer/orders/{OrderId:int}"
@inject HttpClient Http
@inject CultureService CultureService
@inject AuthService Auth
@inject NavigationManager Navigation
@inject ILocalizerService L
@inject IConfiguration Configuration
@inject IJSRuntime JS
@implements IAsyncDisposable
@rendermode InteractiveServer

<PageTitle>Order #@OrderId</PageTitle>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Back navigation -->
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/customer/active-orders">Active Orders</a></li>
                    <li class="breadcrumb-item active">Order #@OrderId</li>
                </ol>
            </nav>

            @if (!Auth.IsCustomer)
            {
                <div class="alert alert-warning">
                    <p class="mb-0">Please <a href="/login">log in</a> to view order details.</p>
                </div>
            }
            else if (isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading order details...</p>
                </div>
            }
            else if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
                </div>
            }
            else if (order != null)
            {
                <!-- Order Header -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">Order #@order.Id</h4>
                            <small>@FormatDate(order.OrderCreatedTime)</small>
                        </div>
                        <div class="text-end">
                            @if (IsConnected)
                            {
                                <span class="badge bg-success">
                                    <i class="bi bi-wifi me-1"></i>Live
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-light text-dark">
                                    <i class="bi bi-wifi-off me-1"></i>Offline
                                </span>
                            }
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong><i class="bi bi-shop me-2"></i>Partner:</strong> #@order.PartnerId</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong><i class="bi bi-geo-alt me-2"></i>Delivery:</strong> @order.DeliveryAddress</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Left: Order Status Stepper -->
                    <div class="col-lg-5 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Order Status</h5>
                            </div>
                            <div class="card-body">
                                @if (order.Status == "Rejected")
                                {
                                    <div class="alert alert-danger">
                                        <i class="bi bi-x-circle me-2"></i>
                                        <strong>Order Rejected</strong>
                                        @if (!string.IsNullOrEmpty(rejectionReason))
                                        {
                                            <p class="mb-0 mt-2">Reason: @rejectionReason</p>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="stepper">
                                        @foreach (var step in GetOrderSteps())
                                        {
                                            <div class="step @(step.IsCompleted ? "completed" : "") @(step.IsCurrent ? "current" : "")">
                                                <div class="step-icon">
                                                    @if (step.IsCompleted)
                                                    {
                                                        <i class="bi bi-check-lg"></i>
                                                    }
                                                    else if (step.IsCurrent)
                                                    {
                                                        <div class="spinner-border spinner-border-sm" role="status">
                                                            <span class="visually-hidden">In progress...</span>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <i class="bi bi-circle"></i>
                                                    }
                                                </div>
                                                <div class="step-content">
                                                    <div class="step-title">@step.Title</div>
                                                    <div class="step-description text-muted">@step.Description</div>
                                                    @if (!string.IsNullOrEmpty(step.Timestamp))
                                                    {
                                                        <small class="text-success">@step.Timestamp</small>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Right: Order Items & Pricing -->
                    <div class="col-lg-7 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-bag me-2"></i>Order Items</h5>
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Item</th>
                                            <th class="text-center">Qty</th>
                                            <th class="text-end">Price</th>
                                            <th class="text-end">Subtotal</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in order.Items)
                                        {
                                            <tr>
                                                <td>@item.Name</td>
                                                <td class="text-center">@item.Quantity</td>
                                                <td class="text-end">@item.UnitPrice.ToString("C")</td>
                                                <td class="text-end">@((item.Quantity * item.UnitPrice).ToString("C"))</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pricing Summary -->
                            <div class="card-footer bg-light">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Items Subtotal</span>
                                    <span>@GetItemsSubtotal().ToString("C")</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Delivery Fee</span>
                                    <span>@order.DeliveryFee.ToString("C")</span>
                                </div>
                                <hr />
                                <div class="d-flex justify-content-between">
                                    <strong class="fs-5">Total</strong>
                                    <strong class="fs-5 text-primary">@CalculateTotal().ToString("C")</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Back button -->
                <div class="text-center mt-2">
                    <a href="/customer/active-orders" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>Back to Active Orders
                    </a>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .stepper {
        position: relative;
        padding-left: 0;
    }
    
    .step {
        display: flex;
        align-items: flex-start;
        margin-bottom: 1.5rem;
        position: relative;
    }
    
    .step:not(:last-child)::after {
        content: '';
        position: absolute;
        left: 15px;
        top: 35px;
        width: 2px;
        height: calc(100% + 0.5rem);
        background-color: #dee2e6;
    }
    
    .step.completed:not(:last-child)::after {
        background-color: #198754;
    }
    
    .step-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #dee2e6;
        color: #6c757d;
        flex-shrink: 0;
        margin-right: 1rem;
        z-index: 1;
    }
    
    .step.completed .step-icon {
        background-color: #198754;
        color: white;
    }
    
    .step.current .step-icon {
        background-color: #0d6efd;
        color: white;
    }
    
    .step-content {
        flex-grow: 1;
        padding-top: 4px;
    }
    
    .step-title {
        font-weight: 600;
        margin-bottom: 2px;
    }
    
    .step-description {
        font-size: 0.875rem;
    }
    
    .step.completed .step-title {
        color: #198754;
    }
    
    .step.current .step-title {
        color: #0d6efd;
    }
</style>

@code {
    [Parameter]
    public int OrderId { get; set; }

    private CustomerOrderResponse? order;
    private string? errorMessage;
    private bool isLoading = true;
    private string? rejectionReason;
    
    // Status timestamps (populated from WebSocket events)
    private Dictionary<string, string> statusTimestamps = new();
    
    // WebSocket state
    private bool IsConnected { get; set; }
    private DotNetObjectReference<OrderDetail>? _dotNetRef;
    private int _listenerId;

    protected override void OnInitialized()
    {
        CultureService.OnChange += OnCultureChanged;
    }

    private void OnCultureChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Auth.InitializeAsync();
            
            if (Auth.IsCustomer)
            {
                await LoadOrderDetail();
                await ConnectWebSocket();
            }
            else
            {
                isLoading = false;
            }
            StateHasChanged();
        }
    }

    private async Task ConnectWebSocket()
    {
        if (!Auth.IsCustomer || !Auth.Id.HasValue) return;

        try
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            var gatewayUrl = Configuration["GatewayPublicUrl"] ?? Configuration["GatewayUrl"] ?? "http://localhost:5000";
            var wsUrl = gatewayUrl.Replace("http://", "ws://").Replace("https://", "wss://");
            wsUrl = $"{wsUrl}/api/v1/ws/customers/{Auth.Id}";
            
            // Connect returns a listener ID for cleanup
            _listenerId = await JS.InvokeAsync<int>("customerWebSocket.connect", wsUrl, _dotNetRef);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to connect WebSocket: {ex.Message}");
        }
    }

    [JSInvokable]
    public void OnConnected()
    {
        IsConnected = true;
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public void OnDisconnected(string reason)
    {
        IsConnected = false;
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public async Task OnOrderAccepted(int orderId, string partnerName, int estimatedMinutes, string timestamp)
    {
        if (orderId == OrderId && order != null)
        {
            order.Status = "Accepted";
            statusTimestamps["Accepted"] = FormatTimestamp(timestamp);
            await InvokeAsync(StateHasChanged);
        }
    }

    [JSInvokable]
    public async Task OnOrderRejected(int orderId, string reason, string timestamp)
    {
        if (orderId == OrderId && order != null)
        {
            order.Status = "Rejected";
            rejectionReason = reason;
            await InvokeAsync(StateHasChanged);
        }
    }

    [JSInvokable]
    public async Task OnOrderReady(int orderId, string partnerName, string timestamp)
    {
        if (orderId == OrderId && order != null)
        {
            order.Status = "Ready";
            statusTimestamps["Ready"] = FormatTimestamp(timestamp);
            await InvokeAsync(StateHasChanged);
        }
    }

    [JSInvokable]
    public async Task OnOrderPickedUp(int orderId, string agentName, string timestamp)
    {
        if (orderId == OrderId && order != null)
        {
            order.Status = "PickedUp";
            statusTimestamps["PickedUp"] = FormatTimestamp(timestamp);
            await InvokeAsync(StateHasChanged);
        }
    }

    [JSInvokable]
    public async Task OnOrderDelivered(int orderId, string timestamp)
    {
        if (orderId == OrderId && order != null)
        {
            order.Status = "Delivered";
            statusTimestamps["Delivered"] = FormatTimestamp(timestamp);
            await InvokeAsync(StateHasChanged);
        }
    }

    private string FormatTimestamp(string isoTimestamp)
    {
        if (DateTime.TryParse(isoTimestamp, out var dt))
        {
            return dt.ToLocalTime().ToString("h:mm tt");
        }
        return "";
    }

    private async Task LoadOrderDetail()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var url = $"/api/v1/orders/customer/{Auth.Id}/active";

            var request = new HttpRequestMessage(HttpMethod.Get, url);
            if (!string.IsNullOrEmpty(Auth.Token))
            {
                request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", Auth.Token);
            }

            var response = await Http.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                var orders = await response.Content.ReadFromJsonAsync<List<CustomerOrderResponse>>();
                order = orders?.FirstOrDefault(o => o.Id == OrderId);
                
                if (order == null)
                {
                    // Try loading from full order history
                    await LoadFromHistory();
                }
            }
            else
            {
                errorMessage = "Failed to load order details. Please try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadFromHistory()
    {
        try
        {
            var url = $"/api/v1/orders/customer/{Auth.Id}";
            var request = new HttpRequestMessage(HttpMethod.Get, url);
            if (!string.IsNullOrEmpty(Auth.Token))
            {
                request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", Auth.Token);
            }

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                var orders = await response.Content.ReadFromJsonAsync<List<CustomerOrderResponse>>();
                order = orders?.FirstOrDefault(o => o.Id == OrderId);
                
                if (order == null)
                {
                    errorMessage = "Order not found.";
                }
            }
        }
        catch { }
    }

    private List<OrderStep> GetOrderSteps()
    {
        var currentStatusIndex = GetStatusIndex(order?.Status ?? "Placed");
        
        var steps = new List<OrderStep>
        {
            new OrderStep 
            { 
                Title = "Order Placed", 
                Description = "Your order has been received",
                IsCompleted = currentStatusIndex >= 0,
                IsCurrent = currentStatusIndex == 0,
                Timestamp = order != null ? FormatDate(order.OrderCreatedTime) : ""
            },
            new OrderStep 
            { 
                Title = "Accepted", 
                Description = "Restaurant is preparing your food",
                IsCompleted = currentStatusIndex >= 1,
                IsCurrent = currentStatusIndex == 1,
                Timestamp = statusTimestamps.GetValueOrDefault("Accepted", "")
            },
            new OrderStep 
            { 
                Title = "Ready for Pickup", 
                Description = "Food is ready, waiting for delivery agent",
                IsCompleted = currentStatusIndex >= 2,
                IsCurrent = currentStatusIndex == 2,
                Timestamp = statusTimestamps.GetValueOrDefault("Ready", "")
            },
            new OrderStep 
            { 
                Title = "Picked Up", 
                Description = "Delivery agent is on the way",
                IsCompleted = currentStatusIndex >= 3,
                IsCurrent = currentStatusIndex == 3,
                Timestamp = statusTimestamps.GetValueOrDefault("PickedUp", "")
            },
            new OrderStep 
            { 
                Title = "Delivered", 
                Description = "Order has been delivered",
                IsCompleted = currentStatusIndex >= 4,
                IsCurrent = currentStatusIndex == 4,
                Timestamp = statusTimestamps.GetValueOrDefault("Delivered", "")
            }
        };
        
        return steps;
    }

    private int GetStatusIndex(string status)
    {
        return status switch
        {
            "Placed" => 0,
            "Accepted" => 1,
            "Ready" => 2,
            "PickedUp" => 3,
            "Delivered" => 4,
            _ => -1
        };
    }

    private string FormatDate(string isoDate)
    {
        if (DateTime.TryParse(isoDate, out var date))
        {
            return date.ToLocalTime().ToString("h:mm tt");
        }
        return isoDate;
    }

    private decimal GetItemsSubtotal()
    {
        return order?.Items.Sum(i => i.Quantity * i.UnitPrice) ?? 0;
    }

    private decimal CalculateTotal()
    {
        if (order == null) return 0;
        return GetItemsSubtotal() + order.DeliveryFee;
    }

    public async ValueTask DisposeAsync()
    {
        CultureService.OnChange -= OnCultureChanged;
        
        try
        {
            // Remove this component's listener, don't disconnect the whole socket
            if (_listenerId > 0)
            {
                await JS.InvokeVoidAsync("customerWebSocket.removeListener", _listenerId);
            }
        }
        catch { }
        
        _dotNetRef?.Dispose();
    }

    private class OrderStep
    {
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
        public bool IsCompleted { get; set; }
        public bool IsCurrent { get; set; }
        public string Timestamp { get; set; } = "";
    }

    public class CustomerOrderResponse
    {
        public int Id { get; set; }
        public int PartnerId { get; set; }
        public int? AgentId { get; set; }
        public string DeliveryAddress { get; set; } = string.Empty;
        public decimal ServiceFee { get; set; }
        public decimal DeliveryFee { get; set; }
        public string Status { get; set; } = string.Empty;
        public string OrderCreatedTime { get; set; } = string.Empty;
        public List<CustomerOrderItemResponse> Items { get; set; } = new();
    }

    public class CustomerOrderItemResponse
    {
        public int FoodItemId { get; set; }
        public string Name { get; set; } = string.Empty;
        public int Quantity { get; set; }
        public decimal UnitPrice { get; set; }
    }
}
