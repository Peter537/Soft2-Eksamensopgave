@page "/agent/available-jobs"
@rendermode InteractiveServer
@inject IConfiguration Configuration
@inject IJSRuntime JS
@inject HttpClient Http
@inject AuthService Auth
@inject NavigationManager Navigation
@inject CultureService CultureService
@inject ILocalizerService L
@implements IAsyncDisposable

<PageTitle>@L["Pages.Agent.AvailableJobs.PageTitle"]</PageTitle>

<div class="container mt-4">
    @if (!isInitialized)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (!Auth.IsAgent || !Auth.Id.HasValue)
    {
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="alert alert-warning">
                    <h5 class="alert-heading">@L["Pages.Agent.AvailableJobs.AccessDeniedTitle"]</h5>
                    <p class="mb-0">@L["Pages.Agent.AvailableJobs.LoginRequired"] <a href="/agent/login">@L["Pages.Agent.AvailableJobs.LoginLink"]</a></p>
                </div>
            </div>
        </div>
    }
    else
    {
        <h3 class="mb-4">@L["Pages.Agent.AvailableJobs.Title"]</h3>

@* Active toggle - just for show *@
<div class="form-check mb-3">
    <input class="form-check-input" type="checkbox" id="activeCheck" @bind="IsActive">
    <label class="form-check-label" for="activeCheck">Active</label>
</div>

@* Available Jobs List *@
<div class="jobs-container">
    @if (Jobs.Count == 0)
    {
        <div class="text-center text-muted py-5">
            <span style="font-size: 2rem;">üì¶</span>
            <p class="mt-2">No available deliveries right now...</p>
            <p class="small">New jobs will appear here when restaurants accept orders</p>
        </div>
    }
    else
    {
        @foreach (var job in Jobs.OrderByDescending(j => j.ReceivedAt))
        {
            <div class="card mb-3 job-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="d-flex">
                            @* Placeholder image *@
                            <div class="job-image me-3">
                                <div class="bg-light rounded" style="width: 60px; height: 60px;"></div>
                            </div>
                            <div>
                                <h5 class="mb-1">@job.PartnerName</h5>
                                <div class="text-muted small">
                                    üìç @job.Distance ¬∑ ETA @job.EtaMinutes min
                                </div>
                                <div class="text-muted small">
                                    @ShortenAddress(job.PartnerAddress) ‚Üí @ShortenAddress(job.DeliveryAddress)
                                </div>

                                @* Collapsible items *@
                                <div class="mt-2">
                                    <a class="text-decoration-none small" 
                                       data-bs-toggle="collapse" 
                                       href="#items-@job.OrderId" 
                                       role="button">
                                        ‚ñº Items (@job.Items.Count)
                                    </a>
                                    <div class="collapse" id="items-@job.OrderId">
                                        <ul class="list-unstyled mt-1 ms-2 small text-muted">
                                            @foreach (var item in job.Items)
                                            {
                                                <li>‚Ä¢ @item.Quantity x @item.Name</li>
                                            }
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">DKK @job.DeliveryFee.ToString("0")</div>
                            <button class="btn btn-outline-primary btn-sm mt-2" @onclick="() => AcceptJob(job)">
                                Accept
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@* Connection Status *@
<div class="mt-3 d-flex justify-content-between align-items-center status-bar">
    <div>
        <span class="badge @(IsConnected ? "bg-success" : "bg-danger")">
            @(IsConnected ? "Connected" : "Disconnected")
        </span>
        @if (!string.IsNullOrEmpty(StatusMessage))
        {
            <span class="ms-2 text-muted small">@StatusMessage</span>
        }
    </div>
    <div class="text-muted small">
        <a href="/agent/my-deliveries">@L["Pages.Agent.AvailableJobs.ViewMyDeliveries"]</a>
    </div>
</div>
    }
</div>

@code {
    private List<AvailableJob> Jobs { get; set; } = new();
    private bool IsConnected { get; set; }
    private bool IsActive { get; set; } = true;
    private string StatusMessage { get; set; } = "Loading...";
    private bool isInitialized;
    private bool isLoading = true;

    private DotNetObjectReference<AvailableJobs>? _dotNetRef;

    protected override void OnInitialized()
    {
        CultureService.OnChange += OnCultureChanged;
    }

    private void OnCultureChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Auth.InitializeAsync();
            isInitialized = true;
            
            if (Auth.IsAgent && Auth.Id.HasValue)
            {
                // Load available jobs (orders that are Accepted but not yet assigned to an agent)
                await LoadAvailableJobs();
                
                _dotNetRef = DotNetObjectReference.Create(this);
                
                // Connect to the broadcast room for all available jobs
                var gatewayUrl = Configuration["GatewayPublicUrl"] ?? Configuration["GatewayUrl"] ?? "http://localhost:8080";
                var wsUrl = gatewayUrl.Replace("http://", "ws://").Replace("https://", "wss://");
                wsUrl = $"{wsUrl}/api/v1/ws/agents";

                await JS.InvokeVoidAsync("agentWebSocket.connect", wsUrl, _dotNetRef);
            }
            StateHasChanged();
        }
    }

    private async Task LoadAvailableJobs()
    {
        isLoading = true;
        StatusMessage = "Loading available jobs...";
        
        try
        {
            var gatewayUrl = Configuration["GatewayUrl"] ?? "http://localhost:8080";
            var request = new HttpRequestMessage(HttpMethod.Get, $"{gatewayUrl}/api/v1/orders/available");
            
            if (!string.IsNullOrEmpty(Auth.Token))
            {
                request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", Auth.Token);
            }
            
            var response = await Http.SendAsync(request);
            
            if (response.IsSuccessStatusCode)
            {
                var availableJobs = await response.Content.ReadFromJsonAsync<List<AvailableJobApiResponse>>();
                
                if (availableJobs != null)
                {
                    foreach (var job in availableJobs)
                    {
                        // Prevent duplicates
                        if (!Jobs.Any(j => j.OrderId == job.OrderId))
                        {
                            Jobs.Add(new AvailableJob
                            {
                                OrderId = job.OrderId,
                                PartnerName = job.PartnerName,
                                PartnerAddress = job.PartnerAddress,
                                DeliveryAddress = job.DeliveryAddress,
                                DeliveryFee = job.DeliveryFee,
                                Distance = job.Distance,
                                EtaMinutes = job.EstimatedMinutes,
                                Items = job.Items.Select(i => new OrderItemDto
                                {
                                    Name = i.Name,
                                    Quantity = i.Quantity
                                }).ToList(),
                                ReceivedAt = DateTime.Parse(job.CreatedAt)
                            });
                        }
                    }
                }
                
                StatusMessage = Jobs.Count > 0 
                    ? $"Loaded {Jobs.Count} available jobs" 
                    : "Ready - listening for new jobs";
            }
            else
            {
                StatusMessage = "Ready - listening for new jobs";
            }
        }
        catch (Exception ex)
        {
            StatusMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    [JSInvokable]
    public void OnConnected()
    {
        IsConnected = true;
        StatusMessage = "Listening for jobs...";
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public void OnDisconnected(string reason)
    {
        IsConnected = false;
        StatusMessage = $"Disconnected: {reason}";
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public void OnOrderAccepted(int orderId, string partnerName, string partnerAddress, 
                                 string deliveryAddress, decimal deliveryFee, 
                                 string distance, int estimatedMinutes, OrderItemDto[] items)
    {
        // Prevent duplicate entries (Blazor can call this multiple times)
        if (Jobs.Any(j => j.OrderId == orderId))
        {
            return;
        }

        var job = new AvailableJob
        {
            OrderId = orderId,
            PartnerName = partnerName,
            PartnerAddress = partnerAddress,
            DeliveryAddress = deliveryAddress,
            DeliveryFee = deliveryFee,
            Distance = distance,
            EtaMinutes = estimatedMinutes,
            Items = items.ToList(),
            ReceivedAt = DateTime.Now
        };

        Jobs.Add(job);
        StatusMessage = $"New job from {partnerName}!";
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public void OnAgentAssigned(int orderId, int agentId)
    {
        // Another agent took this job - remove from our list
        var job = Jobs.FirstOrDefault(j => j.OrderId == orderId);
        if (job != null)
        {
            Jobs.Remove(job);
            StatusMessage = $"Job #{orderId} was taken";
            InvokeAsync(StateHasChanged);
        }
    }

    [JSInvokable]
    public void OnOrderReady(int orderId, string partnerName, string partnerAddress)
    {
        // This would be handled on the MyDeliveries page, not here
        // But we include the handler in case someone connects to personal room
        StatusMessage = $"Order #{orderId} is ready at {partnerName}!";
        InvokeAsync(StateHasChanged);
    }

    private async Task AcceptJob(AvailableJob job)
    {
        // Remove from list locally
        Jobs.Remove(job);
        StatusMessage = $"Accepting job #{job.OrderId}...";
        
        // Call OrderService assign-agent endpoint
        var gatewayUrl = Configuration["GatewayUrl"] ?? "http://localhost:8080";
        try
        {
            var payload = new { agentId = Auth.Id };
            var request = new HttpRequestMessage(HttpMethod.Post, $"{gatewayUrl}/api/v1/orders/order/{job.OrderId}/assign-agent");
            request.Content = JsonContent.Create(payload);
            
            if (!string.IsNullOrEmpty(Auth.Token))
            {
                request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", Auth.Token);
            }
            
            var response = await Http.SendAsync(request);
            
            if (response.IsSuccessStatusCode)
            {
                StatusMessage = $"Job #{job.OrderId} accepted! Go to My Deliveries to manage it.";
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Conflict)
            {
                StatusMessage = $"Job #{job.OrderId} was already taken by another agent!";
            }
            else
            {
                StatusMessage = $"Failed to accept job: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            StatusMessage = $"Error accepting job: {ex.Message}";
        }

        await InvokeAsync(StateHasChanged);
    }

    private string ShortenAddress(string address)
    {
        // Take just the street part if address is long
        if (string.IsNullOrEmpty(address)) return "Unknown";
        var parts = address.Split(',');
        return parts[0].Length > 25 ? parts[0].Substring(0, 22) + "..." : parts[0];
    }

    public async ValueTask DisposeAsync()
    {
        CultureService.OnChange -= OnCultureChanged;
        if (_dotNetRef != null)
        {
            await JS.InvokeVoidAsync("agentWebSocket.disconnect");
            _dotNetRef.Dispose();
        }
    }

    public class AvailableJob
    {
        public int OrderId { get; set; }
        public string PartnerName { get; set; } = "";
        public string PartnerAddress { get; set; } = "";
        public string DeliveryAddress { get; set; } = "";
        public decimal DeliveryFee { get; set; }
        public string Distance { get; set; } = "";
        public int EtaMinutes { get; set; }
        public List<OrderItemDto> Items { get; set; } = new();
        public DateTime ReceivedAt { get; set; }
    }

    public class OrderItemDto
    {
        public string Name { get; set; } = "";
        public int Quantity { get; set; }
    }

    public class AvailableJobApiResponse
    {
        public int OrderId { get; set; }
        public string PartnerName { get; set; } = "";
        public string PartnerAddress { get; set; } = "";
        public string DeliveryAddress { get; set; } = "";
        public decimal DeliveryFee { get; set; }
        public string Distance { get; set; } = "";
        public int EstimatedMinutes { get; set; }
        public string CreatedAt { get; set; } = "";
        public List<AvailableJobApiItemResponse> Items { get; set; } = new();
    }

    public class AvailableJobApiItemResponse
    {
        public string Name { get; set; } = "";
        public int Quantity { get; set; }
    }
}
