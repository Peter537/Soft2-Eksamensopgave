@page "/agent/my-deliveries/{AgentId:int}"
@using Microsoft.AspNetCore.Components
@rendermode InteractiveServer
@inject IConfiguration Configuration
@inject IJSRuntime JS
@inject HttpClient Http
@implements IAsyncDisposable

<PageTitle>My Deliveries - Agent @AgentId</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>üöó My Deliveries</h2>
            <p class="text-muted mb-0">Agent ID: @AgentId</p>
        </div>
        <div class="d-flex align-items-center gap-3">
            <span class="badge @(IsConnected ? "bg-success" : "bg-danger")">
                @(IsConnected ? "‚óè Connected" : "‚óã Disconnected")
            </span>
            <a href="/agent/@AgentId/available-jobs" class="btn btn-outline-primary btn-sm">
                ‚Üê Back to Available Jobs
            </a>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(StatusMessage))
    {
        <div class="alert @(StatusMessage.Contains("ready") ? "alert-success" : "alert-info") alert-dismissible fade show" role="alert">
            @StatusMessage
            <button type="button" class="btn-close" @onclick="() => StatusMessage = string.Empty"></button>
        </div>
    }

    @* My Deliveries List *@
    <div class="deliveries-container">
        @if (Deliveries.Count == 0)
        {
            <div class="text-center text-muted py-5">
                <h4>üì≠ No active deliveries</h4>
                <p>Accept orders from the <a href="/agent/@AgentId/available-jobs">Available Jobs</a> page to see them here.</p>
            </div>
        }
        else
        {
            @foreach (var delivery in Deliveries.OrderByDescending(d => d.AcceptedAt))
            {
                <div class="card mb-3 delivery-card @(delivery.IsPickedUp ? "border-info" : delivery.IsReady ? "border-success" : "")">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <h5 class="mb-0">@delivery.PartnerName</h5>
                                    @if (delivery.IsPickedUp)
                                    {
                                        <span class="badge bg-info">üöó EN ROUTE TO CUSTOMER</span>
                                    }
                                    else if (delivery.IsReady)
                                    {
                                        <span class="badge bg-success">üçî READY FOR PICKUP!</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning text-dark">‚è≥ Preparing...</span>
                                    }
                                </div>
                                <p class="text-muted mb-1">
                                    <small>
                                        üìç Pickup: @delivery.PartnerAddress<br/>
                                        üè† Deliver to: @delivery.DeliveryAddress
                                    </small>
                                </p>
                                <p class="mb-2">
                                    <span class="badge bg-primary me-2">Order #@delivery.OrderId</span>
                                    <span class="text-success fw-bold">@delivery.DeliveryFee.ToString("C")</span>
                                </p>
                                
                                @* Collapsible items *@
                                <div class="mt-2">
                                    <button class="btn btn-link btn-sm p-0 text-decoration-none" 
                                            type="button" 
                                            @onclick="() => delivery.ShowItems = !delivery.ShowItems">
                                        @(delivery.ShowItems ? "‚ñº" : "‚ñ∂") @delivery.Items.Count items
                                    </button>
                                    @if (delivery.ShowItems)
                                    {
                                        <ul class="list-group list-group-flush mt-2">
                                            @foreach (var item in delivery.Items)
                                            {
                                                <li class="list-group-item py-1 px-2 bg-light">
                                                    @item.Quantity x @item.Name
                                                </li>
                                            }
                                        </ul>
                                    }
                                </div>
                            </div>

                            <div class="d-flex flex-column gap-2 ms-3 delivery-actions">
                                @if (delivery.IsPickedUp)
                                {
                                    <button class="btn btn-primary" @onclick="() => MarkDelivered(delivery)">
                                        üì¶ Mark Delivered
                                    </button>
                                }
                                else if (delivery.IsReady)
                                {
                                    <button class="btn btn-success" @onclick="() => MarkPickedUp(delivery)">
                                        ‚úì Picked Up
                                    </button>
                                }
                                else
                                {
                                    <span class="text-muted small">Waiting for food...</span>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    [Parameter]
    public int AgentId { get; set; }

    private List<MyDelivery> Deliveries { get; set; } = new();
    private bool IsConnected { get; set; }
    private string StatusMessage { get; set; } = "Connecting...";

    private DotNetObjectReference<MyDeliveries>? _dotNetRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            
            // Connect to personal agent room for OrderReady notifications
            var gatewayUrl = Configuration["GatewayPublicUrl"] ?? Configuration["GatewayUrl"] ?? "http://localhost:8080";
            var wsUrl = gatewayUrl.Replace("http://", "ws://").Replace("https://", "wss://");
            wsUrl = $"{wsUrl}/api/v1/ws/agents/{AgentId}";

            await JS.InvokeVoidAsync("agentDeliveriesWebSocket.connect", wsUrl, _dotNetRef);
        }
    }

    [JSInvokable]
    public void OnConnected()
    {
        IsConnected = true;
        StatusMessage = "Listening for updates...";
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public void OnDisconnected(string reason)
    {
        IsConnected = false;
        StatusMessage = $"Disconnected: {reason}";
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public void OnDeliveryAccepted(int orderId, string partnerName, string partnerAddress, 
                                    string deliveryAddress, decimal deliveryFee, OrderItemDto[] items)
    {
        // Prevent duplicates
        if (Deliveries.Any(d => d.OrderId == orderId))
        {
            return;
        }

        var delivery = new MyDelivery
        {
            OrderId = orderId,
            PartnerName = partnerName,
            PartnerAddress = partnerAddress,
            DeliveryAddress = deliveryAddress,
            DeliveryFee = deliveryFee,
            Items = items.ToList(),
            AcceptedAt = DateTime.Now,
            IsReady = false,
            IsPickedUp = false
        };

        Deliveries.Add(delivery);
        StatusMessage = $"You accepted order #{orderId}!";
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public void OnOrderReady(int orderId, string partnerName, string partnerAddress)
    {
        var delivery = Deliveries.FirstOrDefault(d => d.OrderId == orderId);
        if (delivery != null)
        {
            delivery.IsReady = true;
            delivery.PartnerName = partnerName; // Update in case of change
            delivery.PartnerAddress = partnerAddress;
            StatusMessage = $"üçî Order #{orderId} is ready for pickup at {partnerName}!";
            InvokeAsync(StateHasChanged);
        }
    }

    private async Task MarkPickedUp(MyDelivery delivery)
    {
        // Mark as picked up - now agent is en route to customer
        delivery.IsPickedUp = true;
        StatusMessage = $"Order #{delivery.OrderId} picked up! Now deliver to customer.";
        
        // Call OrderService pickup endpoint
        var gatewayUrl = Configuration["GatewayUrl"] ?? "http://localhost:8080";
        try
        {
            await Http.PostAsync($"{gatewayUrl}/api/v1/orders/order/{delivery.OrderId}/pickup", null);
        }
        catch
        {
            // Fire-and-forget, UI already updated
        }
        
        await InvokeAsync(StateHasChanged);
    }

    private async Task MarkDelivered(MyDelivery delivery)
    {
        // Order delivered - remove from list
        Deliveries.Remove(delivery);
        StatusMessage = $"‚úÖ Order #{delivery.OrderId} delivered successfully!";
        
        // Call OrderService complete-delivery endpoint
        var gatewayUrl = Configuration["GatewayUrl"] ?? "http://localhost:8080";
        try
        {
            await Http.PostAsync($"{gatewayUrl}/api/v1/orders/order/{delivery.OrderId}/complete-delivery", null);
        }
        catch
        {
            // Fire-and-forget, UI already updated
        }
        
        await InvokeAsync(StateHasChanged);
    }

    public async ValueTask DisposeAsync()
    {
        if (_dotNetRef != null)
        {
            await JS.InvokeVoidAsync("agentDeliveriesWebSocket.disconnect");
            _dotNetRef.Dispose();
        }
    }

    public class MyDelivery
    {
        public int OrderId { get; set; }
        public string PartnerName { get; set; } = "";
        public string PartnerAddress { get; set; } = "";
        public string DeliveryAddress { get; set; } = "";
        public decimal DeliveryFee { get; set; }
        public List<OrderItemDto> Items { get; set; } = new();
        public DateTime AcceptedAt { get; set; }
        public bool IsReady { get; set; }
        public bool IsPickedUp { get; set; }
        public bool ShowItems { get; set; }
    }

    public class OrderItemDto
    {
        public string Name { get; set; } = "";
        public int Quantity { get; set; }
    }
}
