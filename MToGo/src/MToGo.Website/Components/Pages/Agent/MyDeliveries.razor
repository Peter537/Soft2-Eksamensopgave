@page "/agent/my-deliveries"
@using Microsoft.AspNetCore.Components
@using System.Text.Json
@rendermode InteractiveServer
@inject IConfiguration Configuration
@inject IJSRuntime JS
@inject HttpClient Http
@inject AuthService Auth
@inject NavigationManager Navigation
@inject CultureService CultureService
@inject ILocalizerService L
@implements IAsyncDisposable

<PageTitle>@L.GetString("Pages.Agent.MyDeliveries.PageTitle", Auth.Id)</PageTitle>

<div class="container mt-4">
    @if (!isInitialized)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">@L["Pages.Agent.MyDeliveries.Loading"]</span>
            </div>
        </div>
    }
    else if (!Auth.IsAgent)
    {
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="alert alert-warning">
                    <h5 class="alert-heading">@L["Pages.Agent.MyDeliveries.AccessDeniedTitle"]</h5>
                    <p class="mb-0">@L["Pages.Agent.MyDeliveries.LoginRequired"] <a href="/agent/login">@L["Pages.Agent.MyDeliveries.LoginLink"]</a></p>
                </div>
            </div>
        </div>
    }
    else if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">@L["Pages.Agent.MyDeliveries.Loading"]</span>
            </div>
            <p class="mt-2 text-muted">@L["Pages.Agent.MyDeliveries.LoadingDeliveries"]</p>
        </div>
    }
    else
    {
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>@L["Pages.Agent.MyDeliveries.Title"]</h2>
            </div>
            <div class="d-flex align-items-center gap-3">
                <span class="badge @(IsConnected ? "bg-success" : "bg-danger")">
                    @(IsConnected ? L["Pages.Agent.MyDeliveries.Connected"] : L["Pages.Agent.MyDeliveries.Disconnected"])
                </span>
                <a href="/agent/available-jobs" class="btn btn-outline-primary btn-sm">
                    @L["Pages.Agent.MyDeliveries.BackToJobs"]
                </a>
            </div>
        </div>

    @if (!string.IsNullOrEmpty(StatusMessage))
    {
        <div class="alert @(StatusMessage.Contains("ready") ? "alert-success" : "alert-info") alert-dismissible fade show" role="alert">
            @StatusMessage
            <button type="button" class="btn-close" @onclick="() => StatusMessage = string.Empty"></button>
        </div>
    }

    @* My Deliveries List *@
    <div class="deliveries-container">
        @if (Deliveries.Count == 0)
        {
            <div class="text-center text-muted py-5">
                <h4>üì≠ @L["Pages.Agent.MyDeliveries.NoDeliveries"]</h4>
                <p>@L["Pages.Agent.MyDeliveries.AcceptOrdersHint"] <a href="/agent/available-jobs">@L["Pages.Agent.MyDeliveries.AvailableJobsLink"]</a></p>
            </div>
        }
        else
        {
            @foreach (var delivery in Deliveries.OrderByDescending(d => d.AcceptedAt))
            {
                <div class="card mb-3 delivery-card @(delivery.IsPickedUp ? "border-info" : delivery.IsReady ? "border-success" : "")">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <h5 class="mb-0">@delivery.PartnerName</h5>
                                    @if (delivery.IsPickedUp)
                                    {
                                        <span class="badge bg-info">@L["Pages.Agent.MyDeliveries.EnRoute"]</span>
                                    }
                                    else if (delivery.IsReady)
                                    {
                                        <span class="badge bg-success">@L["Pages.Agent.MyDeliveries.ReadyForPickup"]</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning text-dark">@L["Pages.Agent.MyDeliveries.Preparing"]</span>
                                    }
                                </div>
                                <p class="text-muted mb-1">
                                    <small>
                                        @L["Pages.Agent.MyDeliveries.Pickup"] @delivery.PartnerAddress<br/>
                                        @L["Pages.Agent.MyDeliveries.DeliverTo"] @delivery.DeliveryAddress
                                    </small>
                                </p>
                                <p class="mb-2">
                                    <span class="badge bg-primary me-2">@string.Format(L["Pages.Agent.MyDeliveries.OrderNumber"], delivery.OrderId)</span>
                                    <span class="text-success fw-bold">@delivery.DeliveryFee.ToString("C")</span>
                                </p>
                                
                                @* Collapsible items *@
                                <div class="mt-2">
                                    <button class="btn btn-link btn-sm p-0 text-decoration-none" 
                                            type="button" 
                                            @onclick="() => delivery.ShowItems = !delivery.ShowItems">
                                        @(delivery.ShowItems ? "‚ñº" : "‚ñ∂") @string.Format(L["Pages.Agent.MyDeliveries.ItemsCount"], delivery.Items.Count)
                                    </button>
                                    @if (delivery.ShowItems)
                                    {
                                        <ul class="list-group list-group-flush mt-2">
                                            @foreach (var item in delivery.Items)
                                            {
                                                <li class="list-group-item py-1 px-2 bg-light">
                                                    @item.Quantity x @item.Name
                                                </li>
                                            }
                                        </ul>
                                    }
                                </div>
                            </div>

                            <div class="d-flex flex-column gap-2 ms-3 delivery-actions">
                                @if (delivery.IsPickedUp)
                                {
                                    <button class="btn btn-primary" @onclick="() => MarkDelivered(delivery)">
                                        @L["Pages.Agent.MyDeliveries.MarkDelivered"]
                                    </button>
                                }
                                else if (delivery.IsReady)
                                {
                                    <button class="btn btn-success" @onclick="() => MarkPickedUp(delivery)">
                                        @L["Pages.Agent.MyDeliveries.PickedUp"]
                                    </button>
                                }
                                else
                                {
                                    <span class="text-muted small">@L["Pages.Agent.MyDeliveries.WaitingForFood"]</span>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
    }
</div>

@code {
    private List<MyDelivery> Deliveries { get; set; } = new();
    private bool IsConnected { get; set; }
    private string StatusMessage { get; set; } = "Connecting...";
    private bool isInitialized;
    private bool isLoading;

    private DotNetObjectReference<MyDeliveries>? _dotNetRef;

    protected override void OnInitialized()
    {
        CultureService.OnChange += OnCultureChanged;
    }

    private void OnCultureChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Auth.InitializeAsync();
            isInitialized = true;
            
            if (Auth.IsAgent)
            {
                isLoading = true;
                StateHasChanged();
                
                // Load active deliveries from API
                await LoadMyDeliveries();
                
                isLoading = false;
                
                _dotNetRef = DotNetObjectReference.Create(this);
                
                // Connect to personal agent room for OrderReady notifications
                var gatewayUrl = Configuration["GatewayPublicUrl"] ?? Configuration["GatewayUrl"] ?? "http://localhost:8080";
                var wsUrl = gatewayUrl.Replace("http://", "ws://").Replace("https://", "wss://");
                wsUrl = $"{wsUrl}/api/v1/ws/agents/{Auth.Id}";

                await JS.InvokeVoidAsync("agentDeliveriesWebSocket.connect", wsUrl, _dotNetRef);
            }
            StateHasChanged();
        }
    }

    private async Task LoadMyDeliveries()
    {
        var gatewayUrl = Configuration["GatewayUrl"] ?? "http://localhost:8080";
        try
        {
            var request = new HttpRequestMessage(HttpMethod.Get, $"{gatewayUrl}/api/v1/orders/agent/{Auth.Id}/active");
            
            if (!string.IsNullOrEmpty(Auth.Token))
            {
                request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", Auth.Token);
            }
            
            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                var orders = JsonSerializer.Deserialize<List<AgentOrderResponse>>(json, new JsonSerializerOptions 
                { 
                    PropertyNameCaseInsensitive = true 
                });
                
                if (orders != null)
                {
                    foreach (var order in orders)
                    {
                        if (!Deliveries.Any(d => d.OrderId == order.Id))
                        {
                            Deliveries.Add(new MyDelivery
                            {
                                OrderId = order.Id,
                                PartnerName = order.PartnerName ?? "Unknown Partner",
                                PartnerAddress = order.PartnerAddress ?? "",
                                DeliveryAddress = order.DeliveryAddress ?? "",
                                DeliveryFee = order.DeliveryFee,
                                Items = order.Items?.Select(i => new OrderItemDto 
                                { 
                                    Name = i.Name ?? "Item", 
                                    Quantity = i.Quantity 
                                }).ToList() ?? new List<OrderItemDto>(),
                                AcceptedAt = order.AssignedAt ?? DateTime.Now,
                                IsReady = order.Status == "Ready" || order.Status == "PickedUp" || order.Status == "OutForDelivery",
                                IsPickedUp = order.Status == "PickedUp" || order.Status == "OutForDelivery"
                            });
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            StatusMessage = $"Error loading deliveries: {ex.Message}";
        }
    }

    [JSInvokable]
    public void OnConnected()
    {
        IsConnected = true;
        StatusMessage = "Listening for updates...";
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public void OnDisconnected(string reason)
    {
        IsConnected = false;
        StatusMessage = $"Disconnected: {reason}";
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public void OnDeliveryAccepted(int orderId, string partnerName, string partnerAddress, 
                                    string deliveryAddress, decimal deliveryFee, OrderItemDto[] items)
    {
        // Prevent duplicates
        if (Deliveries.Any(d => d.OrderId == orderId))
        {
            return;
        }

        var delivery = new MyDelivery
        {
            OrderId = orderId,
            PartnerName = partnerName,
            PartnerAddress = partnerAddress,
            DeliveryAddress = deliveryAddress,
            DeliveryFee = deliveryFee,
            Items = items.ToList(),
            AcceptedAt = DateTime.Now,
            IsReady = false,
            IsPickedUp = false
        };

        Deliveries.Add(delivery);
        StatusMessage = $"You accepted order #{orderId}!";
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public void OnOrderReady(int orderId, string partnerName, string partnerAddress)
    {
        var delivery = Deliveries.FirstOrDefault(d => d.OrderId == orderId);
        if (delivery != null)
        {
            delivery.IsReady = true;
            delivery.PartnerName = partnerName; // Update in case of change
            delivery.PartnerAddress = partnerAddress;
            StatusMessage = $"üçî Order #{orderId} is ready for pickup at {partnerName}!";
            InvokeAsync(StateHasChanged);
        }
    }

    private async Task MarkPickedUp(MyDelivery delivery)
    {
        // Mark as picked up - now agent is en route to customer
        delivery.IsPickedUp = true;
        StatusMessage = $"Order #{delivery.OrderId} picked up! Now deliver to customer.";
        
        // Call OrderService pickup endpoint
        var gatewayUrl = Configuration["GatewayUrl"] ?? "http://localhost:8080";
        try
        {
            var request = new HttpRequestMessage(HttpMethod.Post, $"{gatewayUrl}/api/v1/orders/order/{delivery.OrderId}/pickup");
            
            if (!string.IsNullOrEmpty(Auth.Token))
            {
                request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", Auth.Token);
            }
            
            await Http.SendAsync(request);
        }
        catch
        {
            // Fire-and-forget, UI already updated
        }
        
        await InvokeAsync(StateHasChanged);
    }

    private async Task MarkDelivered(MyDelivery delivery)
    {
        // Order delivered - remove from list
        Deliveries.Remove(delivery);
        StatusMessage = $"‚úÖ Order #{delivery.OrderId} delivered successfully!";
        
        // Call OrderService complete-delivery endpoint
        var gatewayUrl = Configuration["GatewayUrl"] ?? "http://localhost:8080";
        try
        {
            var request = new HttpRequestMessage(HttpMethod.Post, $"{gatewayUrl}/api/v1/orders/order/{delivery.OrderId}/complete-delivery");
            
            if (!string.IsNullOrEmpty(Auth.Token))
            {
                request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", Auth.Token);
            }
            
            await Http.SendAsync(request);
        }
        catch
        {
            // Fire-and-forget, UI already updated
        }
        
        await InvokeAsync(StateHasChanged);
    }

    public async ValueTask DisposeAsync()
    {
        CultureService.OnChange -= OnCultureChanged;
        if (_dotNetRef != null)
        {
            await JS.InvokeVoidAsync("agentDeliveriesWebSocket.disconnect");
            _dotNetRef.Dispose();
        }
    }

    public class MyDelivery
    {
        public int OrderId { get; set; }
        public string PartnerName { get; set; } = "";
        public string PartnerAddress { get; set; } = "";
        public string DeliveryAddress { get; set; } = "";
        public decimal DeliveryFee { get; set; }
        public List<OrderItemDto> Items { get; set; } = new();
        public DateTime AcceptedAt { get; set; }
        public bool IsReady { get; set; }
        public bool IsPickedUp { get; set; }
        public bool ShowItems { get; set; }
    }

    public class OrderItemDto
    {
        public string Name { get; set; } = "";
        public int Quantity { get; set; }
    }

    public class AgentOrderResponse
    {
        public int Id { get; set; }
        public string Status { get; set; } = "";
        public string? PartnerName { get; set; }
        public string? PartnerAddress { get; set; }
        public string? DeliveryAddress { get; set; }
        public decimal DeliveryFee { get; set; }
        public DateTime? AssignedAt { get; set; }
        public List<AgentOrderItemResponse>? Items { get; set; }
    }

    public class AgentOrderItemResponse
    {
        public string? Name { get; set; }
        public int Quantity { get; set; }
    }
}
